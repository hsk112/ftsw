<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>公共选择框</title>
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/mui.indexedlist.css" rel="stylesheet" />
		<style>
			html,
			body {
				height: 100%;
				overflow: hidden;
			}
			.mui-bar {
				-webkit-box-shadow: none;
				box-shadow: none;
			}
			#done.mui-disabled{
				color: gray;
			}
		</style>
	</head>

	<body>
<!-- 		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">选择</h1>
			<a id='done' class="mui-btn mui-btn-link mui-pull-right mui-btn-blue mui-disabled">完成</a>
		</header> -->
		<div class="mui-content">
			<div id='list' class="mui-indexed-list">
				<div class="mui-indexed-list-search mui-input-row mui-search" style="text-align: left;display: none">
					<input id="xxx2" type="search" style="width: 90%;" class="mui-input-clear mui-indexed-list-search-input" placeholder="搜索">
				</div>
                <div class="mui-indexed-list-search mui-input-row " style="text-align: left;">
                    <input id="xxx" type="search" style="width: 90%;" class="mui-input-clear " placeholder="搜索">
                </div>
				<div class="mui-indexed-list-bar">
					<a>A</a>
					<a>B</a>
					<a>C</a>
					<a>D</a>
					<a>E</a>
					<a>F</a>
					<a>G</a>
					<a>H</a>
					<a>I</a>
					<a>J</a>
					<a>K</a>
					<a>L</a>
					<a>M</a>
					<a>N</a>
					<a>O</a>
					<a>P</a>
					<a>Q</a>
					<a>R</a>
					<a>S</a>
					<a>T</a>
					<a>U</a>
					<a>V</a>
					<a>W</a>
					<a>X</a>
					<a>Y</a>
					<a>Z</a>
				</div>
				<div class="mui-indexed-list-alert"></div>
				<div class="mui-indexed-list-inner">
					<div class="mui-indexed-list-empty-alert">没有数据</div>
					<ul class="mui-table-view" id="data-ul-li">
					</ul>
				</div>
			</div>
		</div>
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/mui.indexedlist.js"></script>
		
		<script src="../../js/app.js"></script>
		<script src="../../js/config.js"></script>
		<script src="../../js/jquery.min.js"></script>
		<script src="../../js/common.js"></script>		
		<script src="../../js/s4.js"></script>
		<script src="../../js/smutils.js"></script>
		<script src="../../js/byte&string.js"></script>
		<script src="../../js/ajaxhook.min.js"></script>
		<script type="text/javascript" charset="utf-8">
			mui.init();
			var list = "";
			var done= "";
			var dataList= "";//基础数据
            var tmpDataList= "";
			var multiSelect = false; //是否多选
			var module = ''; //是否多选
			mui.ready(function () {
				list = document.getElementById('list');
				//calc hieght
				list.style.height = (document.body.offsetHeight) + 'px';
			})
			mui.plusReady(function () {
				var self = plus.webview.currentWebview();  
				self.setStyle({  
				    titleNView: {  
				      buttons: [{
				      	float: 'right',
						width:'100',
				      	fontSize: '17', 
				      	text: '完成' ,
						onclick:done
				      }]
				    }  
				});
				
				mui('.mui-indexed-list-inner').on('change', 'input', function() {
					var self = plus.webview.currentWebview();
					var count = list.querySelectorAll('input[type="checkbox"]:checked').length;
					var value = count ? "完成(" + count + ")" : "完成";
					self.setStyle({
					    titleNView: {  
					      buttons: [{
					      	float: 'right',
					      	width:'100',
					      	fontSize: '17', 
					      	text: value,
					      	onclick:done
					      }]
					    }  
					});
				});
				
				
				// 公共选择页面
				// dataList:{
				// 		value: 值,
				// 		text: 显示内容,
				// 		flag:自定义参数   原样返回
				// }
				// multiSelect  是否多选   true  是，false 否
				// module       所属模块
				// 公共选择页面
				dataList = self.dataList;//基础数据
                tmpDataList = self.dataList;
				multiSelect = self.multiSelect||false; //是否多选
				module = self.module||''; //所属模块
				// console.log(JSON.stringify(dataList))
				// console.log(module)
				if(!dataList || dataList.length <= 0){
					// if (module === 'com') 
					app.toast("附近暂无可选小区");
					// else app.toast("缺少基础数据");
					mui.back();
				}
				initSQ(dataList);
			})
			
			var done = function(){
				var checkboxArray = [].slice.call(list.querySelectorAll('input[type="checkbox"]'));
				var checkedValues = [];
				checkboxArray.forEach(function(box) {
					if (box.checked) {
						checkedValues.push({
							value: box.parentNode.getAttribute("data-value"),//值
							text: box.parentNode.getAttribute("data-text"),//标题
							flag: box.parentNode.getAttribute("data-flag"),//自定义参数
						});
					}
				});
				if (checkedValues.length > 0) {
					var view = plus.webview.currentWebview().opener();
					mui.fire(view, 'returnSelect', checkedValues);
					// mui.back();
					plus.webview.currentWebview().close('none');//正确
				} else {
					mui.alert('你没选择任何记录');
				}
			}
			var initSQ = function(data) {
				app.showLoader();
				var str = '';
				var group = {};
				
				for (var i = 0; i < data.length; i++) {
					var item = data[i];
					if(!item.text){
						continue;
					}
					var firstZM = codefans_net_CC2PY(item.text).substring(0,1)
					if (group[firstZM]){
						var groupList = group[firstZM];
						groupList.push(item);
						group[firstZM] = groupList;
					} else {
						var groupList = [];
						groupList.push(item);
						group[firstZM] = groupList;
					}
				}
				// console.log(JSON.stringify(group))
				var resultJson = objKeySort(group);
				for (var key in resultJson) {
					var listArray = resultJson[key];
					str = str+'<li data-group="'+key+'" class="mui-table-view-divider mui-indexed-list-group">'+key+'</li>';
					
					for (var i = 0; i < listArray.length; i++) {
						var line = listArray[i];
						str = str + '<li'
							+ ' data-value="' + line.value 
							+ '" data-text="' + line.text 
							+ '" data-flag="' + line.flag
							+ '" class="mui-table-view-cell mui-indexed-list-item mui-checkbox mui-left">' 
							+ '<input type="checkbox" />'
							+ line.text 
							+ '</li>';
					}
				}
			
				$("#data-ul-li").html(str);
				//create
				window.indexedList = new mui.IndexedList(list);
				
				if (!multiSelect){//单选的情况下，设置监听
					$(".mui-indexed-list-item").on("tap",function(){
						//清除其他选项
						$(".mui-indexed-list-item").find('input[type="checkbox"]:checked').each(function() {
							$(this).attr('checked', false);
						});
					});
				}
				app.hideLoader();
			}
			
			 function objKeySort(arys) { 
				//先用Object内置类的keys方法获取要排序对象的属性名，再利用Array原型上的sort方法对获取的属性名进行排序，newkey是一个数组
				var newkey = Object.keys(arys).sort();　　 
				////console.log('newkey='+newkey);
				var newObj = {}; //创建一个新的对象，用于存放排好序的键值对
				for(var i = 0; i < newkey.length; i++) {
					//遍历newkey数组
					newObj[newkey[i]] = arys[newkey[i]]; 
					//向新创建的对象中按照排好的顺序依次增加键值对
				}
				return newObj; //返回排好序的新对象
			}

            //搜索框改动
            $("#xxx").on('input', function(){
                if($("#xxx").val() != ''){
                    let name = $("#xxx").val()
                    var param = {name:name,rownum:50};
                    getPsXq(param,function (data) {
                        if(data.success == true){
                            // console.log(data.result.length)
                            // console.log(data.result[0].guid)
                            // console.log(data.result[0].reName)
                            var resultJSON =[];
                            for (var i = 0; i < data.result.length; i++) {
                                var item = data.result[i];
                                resultJSON.push({
                                    text: item.reName,//小区名
                                    value: item.guid //小区guid
                                })
                            }
                            dataList = resultJSON;
                            if(dataList.length > 0){
                                initSQ(dataList);
                            }else{
                                initSQ(tmpDataList);
                            }
                        }
                    })
                }else{
                    initSQ(tmpDataList);
                }

            })

		</script>
	</body>

</html>
