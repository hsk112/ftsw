<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>任务转发</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/common.css" rel="stylesheet" />
		<style>
		.mui-popover {
			height: 300px;
		}
		.mui-content {
			padding: 10px;
		}
		.bar-title{
			font-size: 14px;
			font-weight: 400;
			color: #888888;
		}
		.item-title{
			font-size: 14px;
			font-weight: 400;
			color: #444444;
		}
		.mui-icon-arrowright{
			color:#62666E;
			font-weight: 100 !important;
			width: 16px;
		}
		.inputCss{
			font-size: 16px;
			font-weight: 400;
			color: #1A1616;
			height: 30px;
		}
		.bottom-item-btn {
			height: 100px;
			position: fixed;
			z-index: 99;
			width: 100%;
			background: #f2f2f2;
			bottom: 0px;
			padding-top: 30px;
		}
		.bottom-item-btn .item {
			width: 50%;
			float: left;
			text-align: center;
			padding: 0 14px;

		}

		.bottom-item-btn .item div {
			border: 1px solid #337BFB;
			border-radius: 20px;
			height: 40px;
			line-height: 40px;
			font-size: 16px;
		}

		.mui-table-view:after{ height:0}
		.mui-table-view:before{ height:0}
		.mui-table-view-cell:after{ height:0}
		.mui-table-view-cell:before{ height:0}
		.mui-table-view::-webkit-scrollbar {
			display: none;
		}
		.mui-table-view-cell{
			width: 100%;
			text-align: left;
		}
		textarea::-webkit-input-placeholder{
            color:#B1B1B1;
			font-size: 16px;
			font-weight: 400;
		}
	</style>
	</head>

	<body style="background: #FFFFFF;">
		<!--页面主结构开始-->
		<div id="app" class="mui-views">
			<div class="mui-view">
				<div class="mui-navbar">
				</div>
				<div class="mui-pages">
				</div>
			</div>
		</div>
		<div class="bottom-item-btn" id="bottom-item-btn">
			<div class="item" id="hold">
				<div style="background: #fff;color:#337BFC ;border:1px solid #337BFC">返回</div>
			</div>
			<div class="item" id="submit">
				<div style="background: #337BFC;color: #fff">提交</div>
			</div>
		</div>
		<!--页面主结构结束-->
		<!--单页面开始-->
		<div id="mui-content" class="mui-page paish">
			<!--页面标题栏开始-->
			<!--页面标题栏结束-->
			<!--页面主内容区开始-->
			<div class="mui-page-content">
				<div id="scroll-content" class="mui-scroll-wrapper" style="margin-bottom: 100px;">
					<div class="mui-scroll">
						<div class="scroll-li">
							<div class="info-bar-content">
								<div class="info-bar-content-item">
									<div class="item-title">
										任务名称
									</div>
									<div class="mui-input-row item-input">
										<input id="taskName" readonly="true"  type="text" class="inputCss" value=""
										  maxlength="50">
									</div>
								</div>
								<div class="info-bar-content-item">
									<div class="item-title">
										负责人
									</div>
									<div class="mui-input-row item-input">
										<input id="assignUserId" style="display: none;" value=""/>
										<input id="assignUserRealName" readonly="true"  type="text" class="inputCss" value=""
										  maxlength="50">
									</div>
								</div>
								<div class="info-bar-content-item">
									<div class="item-title">
										新执行人<span style="color: red;margin-left: 3px;">*</span>
									</div>
									<div class="mui-input-row item-input">
										<input id="inspectPerson" style="display: none;" value=""/>
										<input id="inspectPersonRealName" required="true" readonly="true"  type="text" class="inputCss" value=""
										  maxlength="50" placeholder="请选择新执行人">
									</div>
								</div>								
								<div class="info-bar-content-item" style="height: 120px;border-bottom: none;">
									<div class="item-title">
										转发原因
									</div>
									<div class="mui-input-row item-input">
										 <textarea id="redirectReason" type="text"  maxlength="50" rows="2" onkeyup="format_textarea(this)"
										  placeholder="请输入转发原因" style="border:none;padding-left: 0;width: calc(100% - 25px);"></textarea>
										  <span class="mui-icon mui-icon-closeempty" id="clear" style="position: relative;top: -50px;line-height:16px;width:16px;height:16px;font-size: 16px; color:#FFFFFF;border-radius: 50%;background:#999999;display: none;"></span>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!--页面主内容区结束-->
		</div>

	</body>

	<script src="../../js/mui.min.js"></script>
	<script src="../../js/mui.view.js"></script>
	<script src="../../js/mui.locker.js"></script>

	<script src="../../js/app.js"></script>
	<script src="../../js/config.js"></script>
	<script src="../../js/jquery.min.js"></script>
	<script src="../../js/common.js"></script>	
	<script src="../../js/helper.js"></script>
	<script src="../../js/s4.js"></script>
	<script src="../../js/smutils.js"></script>
	<script src="../../js/byte&string.js"></script>
	<script src="../../js/ajaxhook.min.js"></script>


	<!-- <script src="../../js/vconsole.min.js"></script> -->
	<script>
		// var vConsole = new VConsole();
		mui.init({swipeBack:false});
		//初始化单页view
		var viewApi = mui('#app').view({
			defaultPage: '#mui-content'
		});
		var self;

		//初始化单页的区域滚动
		mui('.mui-scroll-wrapper').scroll();

		mui.plusReady(function() {
			//界面元素控制
			initView();
			
			initDownSelect();
			var originalHeight = document.documentElement.clientHeight || document.body.clientHeight;
			window.onresize = function() {
				var resizeHeight = document.documentElement.clientHeight || document.body.clientHeight;
				//软键盘弹起与隐藏  都会引起窗口的高度发生变化
				if (resizeHeight * 1 < originalHeight * 1) { //resizeHeight<originalHeight证明窗口被挤压了
					// plus.webview.currentWebview().setStyle({
					// 	height: originalHeight + 75
					// });
					$("#scroll-content").css("margin","0")
					$("#bottom-item-btn").hide()
				}else{
					$("#scroll-content").css("margin-bottom","100px")
					$("#bottom-item-btn").show()
				}
			}
		});

		//界面元素控制
		var initView = function() {

			self = plus.webview.currentWebview();
			$("#taskName").val(isEmp(self.taskName))
			$("#assignUserRealName").val(isEmp(self.assignUserRealName))
			$("#assignUserId").val(self.assignUserId)
		}
		// 点击事件
		var initDownSelect = function() {
			
		//清空textarea
		$("#clear").on("tap", function(event) {
			$("#redirectReason").val("");
			$(this).hide()
		});

		//选择新执行人
		$("#inspectPersonRealName").on("tap", function(event) {
			app.openPage("../commom/organ.html", {
				titleNView: {
					titleText: '选择新执行人',
					autoBackButton: true
				}
			});
			//移除
			window.removeEventListener('returnSelect', setTaskRelay, false);
			// 赋值
			window.addEventListener('returnSelect', setTaskRelay, false);
		});
		
		
		var setTaskRelay = function(data) {
			$("#inspectPerson").val(data.detail[0].username)
			$("#inspectPersonRealName").val(data.detail[0].realname)			
		}
		
		//返回
		$("#hold").on("tap", function(event) {
			mui.back()
		});
		//提交
		$("#submit").on("tap", function(event) {
			if (validateRequiredFields()) {
				var param = {}
				param.assignUserId = $("#assignUserId").val()
				param.assignUserRealName = $("#assignUserRealName").val()
				param.guid = self.guid
				param.inspectPerson = $("#inspectPerson").val()
				param.inspectPersonRealName = $("#inspectPersonRealName").val()
				param.redirectReason = $("#redirectReason").val()
				console.log(JSON.stringify(param))
				TaskRelay(param, function(data) {
					if (data.success) {
						app.toast("转发成功");
						let prePage = self.opener();
						mui.fire(prePage,'relaySuc')
						self.close();									
					} else {
						app.toast("转发失败")
					} 
				});
			}
		});
	}
		var TaskRelay = function(param, callback) {
			var url = config.urls.baseUrl + config.actions.inspectrepeat;

			app.showLoader();
			$.ajax(url, {
				data: param,
				// data: "",
				dataType: 'json', //服务器返回json格式数据
				type: 'get', //HTTP请求类型
				headers: {
					"X-Access-Token": app.sessionId(),
				},
				timeout: config.settings.requestTimeOut, //超时时间设置为10秒；
				success: function(data) {
					app.hideLoader();
					// console.log(JSON.stringify(data))
					if (dealingWithResponseCode(data)) {
						callback(data);
					} else {
						app.toast(data.message);
					}
				},
				error: function(xhr, type, errorThrown) {
					dealingWithErrorRequest(errorThrown);
					app.hideLoader();
					return callback('网络异常,请稍后再试');
				}
			});
		}
		
		function format_textarea(obj) {
			if (/^\s+$/gi.test(obj.value)) {
				obj.value = '';
			}

			var num = 50;
				if(obj.value.length > 0){
					$("#clear").show();
					if (obj.value.length >= num) {
						obj.value = obj.value.slice(0,50);
						app.toast("转发原因不可大于50个字！")
					}
				}else $("#clear").hide();
		}
	</script>

</html>
