<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>新增日常巡检</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/mui.picker.min.css" rel="stylesheet" />
		<link href="../../css/mui.poppicker.css" rel="stylesheet" />
		<link href="../../css/common.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../../css/mui.imageviewer.css" />
		<style>
			.mui-popover {
			height: 300px;
		}
		.mui-content {
			padding: 10px;
		}
		.bar-title{
			font-size: 14px;
			font-weight: 400;
			color: #888888;
		}
		.item-title{
			font-size: 14px;
			font-weight: 400;
			color: #444444;
		}
	.mui-icon-arrowright{
		color:#62666E;
		font-weight: 100 !important;
		width: 16px;
	}
	.inputCss{
		font-size: 16px;
		font-weight: 400;
		color: #1A1616;
		height: 30px;
	}
		.bottom-item-btn {
			height: 100px;
			position: fixed;
			z-index: 99;
			width: 100%;
			background: #f2f2f2;
			bottom: 0px;
			padding-top: 30px;
		}
		.bottom-item-btn .item {
			width: 50%;
			float: left;
			text-align: center;
			padding: 0 14px;

		}

		.bottom-item-btn .item div {
			border: 1px solid #337BFB;
			border-radius: 20px;
			height: 40px;
			line-height: 40px;
			font-size: 16px;
		}

		.mui-table-view:after{ height:0}
		.mui-table-view:before{ height:0}
		.mui-table-view-cell:after{ height:0}
		.mui-table-view-cell:before{ height:0}
		.mui-table-view::-webkit-scrollbar {
			display: none;
		}
		.mui-table-view-cell{
			width: 100%;
			text-align: left;
		}
		textarea::-webkit-input-placeholder{
            color:#B1B1B1;
			font-size: 16px;
			font-weight: 400;
		}
	</style>
	</head>

	<body style="background: #F4F4F4;">
		<!--页面主结构开始-->
		<div id="app" class="mui-views">
			<div class="mui-view">
				<div class="mui-navbar">
				</div>
				<div class="mui-pages">
				</div>
			</div>
		</div>
		<div class="bottom-item-btn" id="bottom-item-btn">
			<div class="item" id="hold">
				<div style="background: #fff;color:#337BFC ;border:1px solid #337BFC">返回</div>
			</div>
			<div class="item" id="submit">
				<div style="background: #337BFC;color: #fff">提交</div>
			</div>
		</div>
		<!--页面主结构结束-->
		<!--单页面开始-->
		<div id="mui-content" class="mui-page paish">
			<!--页面标题栏开始-->
			<!--页面标题栏结束-->
			<!--页面主内容区开始-->
			<div class="mui-page-content">
				<div id="scroll-content" class="mui-scroll-wrapper" style="margin-bottom: 100px;">
					<div class="mui-scroll">
						<div class="scroll-li">
							<div class="info-bar-content">
								<div class="info-bar-content-item">
									<div class="item-title">
										节点名称<span style="color: red;margin-left: 3px;">*</span>
									</div>
									<div class="mui-input-row item-input">
										<input id="archName" required="true"  type="text" class="inputCss mui-input-clear" value=""
										 placeholder="请输入节点名称" maxlength="50" onkeyup="format_input(this)">
									</div>
								</div>
								<div class="info-bar-content-item">
									<div class="item-title">
										年份<span style="color: red;margin-left: 3px;">*</span>
									</div>
									<div class="mui-input-row item-input">
										<input id="year" required="true"  type="text" class="inputCss" value=""
										 placeholder="请选择年份" readonly="true" >
									</div>
								</div>
								<div class="info-bar-content-item" id="selComDate">
									<div class="item-title">
										日期范围<span style="color: red;margin-left: 3px;">*</span>
									</div>
									<div class="mui-input-row item-input">
										<input id="selDate" class="inputCss" readonly="true" required="true" type="text" class="mui-input-clear"
										 placeholder="请选择日期范围" style="width: 90%;">
										<img src="../../img/commom/time.png" style="width:16px;height:16px"></img>
									</div>
								</div>
								<div class="info-bar-content-item" style="height: 120px;border-bottom: none;">
									<div class="item-title">
										描述
									</div>
									<div class="mui-input-row item-input">
										 <textarea id="archContent" type="text"  maxlength="200" rows="2" onkeyup="format_textarea(this)"
										  placeholder="请输入描述" style="border:none;padding-left: 0;width: calc(100% - 25px);"></textarea>
										  <span class="mui-icon mui-icon-closeempty" id="clear" style="position: relative;top: -50px;line-height:16px;width:16px;height:16px;font-size: 16px; color:#FFFFFF;border-radius: 50%;background:#999999;display: none;"></span>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!--页面主内容区结束-->
		</div>

	</body>

	<script type="text/javascript" src="http://39.98.190.45/supermap/mapbox-gl-enhance.js"></script>
	<script type="text/javascript" src="http://39.98.190.45/supermap/iclient-mapboxgl.min.js"></script>
	<script src="http://39.98.190.45/mobile-lib/mobile-lib.umd.min.js"></script>


	<script src="../../js/mui.min.js"></script>
	<script src="../../js/mui.view.js"></script>
	<script src="../../js/mui.locker.js"></script>
	<script src="../../js/mui.picker.min.js"></script>
	<script src="../../js/mui.picker.js"></script>
	<script src="../../js/mui.poppicker.js"></script>

	<script src="../../js/app.js"></script>
	<script src="../../js/config.js"></script>
	<script src="../../js/jquery.min.js"></script>
	<script src="../../js/common.js"></script>	
	<script src="../../js/archives.js"></script>
	<script src="../../js/helper.js"></script>
	<script src="../../js/uploadimage.js"></script>
	<script src="../../js/s4.js"></script>
	<script src="../../js/smutils.js"></script>
	<script src="../../js/byte&string.js"></script>
	<script src="../../js/ajaxhook.min.js"></script>
	<script src="../../js/mui.zoom.js"></script>
	<script src="../../js/mui.previewimage.js"></script>

	<!-- <script src="../../js/vconsole.min.js"></script> -->
	<script>
		// var vConsole = new VConsole();
		mui.init({swipeBack:false});
		//初始化单页view
		var viewApi = mui('#app').view({
			defaultPage: '#mui-content'
		});
		var self;
		//初始化单页的区域滚动
		mui('.mui-scroll-wrapper').scroll();

		var userPicker = new mui.PopPicker();
		mui.plusReady(function() {
			//界面元素控制
			initView();
			
			initDownSelect();
			var originalHeight = document.documentElement.clientHeight || document.body.clientHeight;
			window.onresize = function() {
				var resizeHeight = document.documentElement.clientHeight || document.body.clientHeight;
				//软键盘弹起与隐藏  都会引起窗口的高度发生变化
				if (resizeHeight * 1 < originalHeight * 1) { //resizeHeight<originalHeight证明窗口被挤压了
					// plus.webview.currentWebview().setStyle({
					// 	height: originalHeight + 75
					// });
					$("#scroll-content").css("margin","0")
					$("#bottom-item-btn").hide()
				}else{
					$("#scroll-content").css("margin-bottom","100px")
					$("#bottom-item-btn").show()
				}
			}
		});

		//界面元素控制
		var initView = function() {

			self = plus.webview.currentWebview();
			if(self.value){
				$("#archName").val(self.title);
				$("#year").val(self.year);
				$("#archContent").val(self.archContent);
				
				$("#selDate").val(self.beginTime+"~"+self.endTime)
			}else{
				var date = new Date();
				y = date.getFullYear()	
				$("#year").val(y);
				$("#selDate").val(y+"-01-01~"+y+"-12-31");
			}
		}
		// 点击事件
		var initDownSelect = function() {
			
			$("#year").on("tap", function() {			
					var resultJSON = [];
					for (var i = 1900; i < 2300; i++) {
						resultJSON.push({
							text: i,
							value: i
						})
					}
					if ($(".mui-poppicker").hasClass("mui-active")) {
						userPicker.hide();
						return false;
					} else {
						var y = ''
						if($("#year").val() == ''){
							var date = new Date();
							y = date.getFullYear()	
							userPicker.pickers[0].setSelectedIndex(y-1900); 
						}else if($("#selDate").val() != ''){
							y = $("#selDate").val().slice(0,4)
							userPicker.pickers[0].setSelectedIndex(y-1900); 
						}
						 
						// userPicker.pickers[0].setSelectedValue('2020');
						userPicker.setData(resultJSON);
						userPicker.show(function(items) {
							$("#year").val(items[0].text);
							$("#selDate").val(items[0].text+"-01-01~"+items[0].text+"-12-31");
						});
					}
				})
			}
		
		//清空textarea
		$("#clear").on("tap", function(event) {
			$("#archContent").val("");
			$(this).hide()
		});

		//选择日期
		$("#selDate").on("tap", function(event) {
			var that = $("#selDate");
			var start = '';
			var end = '';
			plusDate(function(data1) {	
				if(data1 != ''){
					plusDate(function(data2) {
						if(data2 != ''){
							console.log(data1)
							console.log(data2)
							if(data1 >= data2){
								start = data2.replace("/","-")
								end = data1.replace("/","-")
							}else{
								start = data1.replace("/","-")
								end = data2.replace("/","-")	
							}										
							$("#selDate").val(start+'~'+end);
							$("#year").val(start.slice(0,4))
						}
					});										
				}
			});
		});
		
		//返回
		$("#hold").on("tap", function(event) {
			mui.back()
			// app.toast("暂存成功")
			// mui.fire( plus.webview.currentWebview().opener(),'reload1');
			// app.openPage("../submitted.html", {
			// 	titleNView: {
			// 		titleText: '暂存日常巡检成功',
			// 		autoBackButton: true,
			// 	}
			// });
		});
		//提交
		$("#submit").on("tap", function(event) {
			if (validateRequiredFields()) {
				var formData = saveNode();
				if(self.value){				
					console.log(JSON.stringify(formData))
					editNode(formData, function(data) {
						if(data.success){
							app.toast("修改成功");
							plus.webview.currentWebview().opener().reload();
							mui.back();
						}else app.toast("修改失败");
					});						
				}else {
					console.log(JSON.stringify(formData))
					addNode(formData, function(data) {
						if(data.success){
							app.toast("新增成功");
							plus.webview.currentWebview().opener().reload();
							mui.back();
						}else app.toast("新增失败");
					});					
				}
			}
		});

		//组装表单
		function saveNode() {
			var formData = {};
			if(self.value){	
				formData.year = $("#year").val();
				formData.label = self.label;
				formData.title = self.title;
				formData.isLeaf = true;
				formData.yearPhase =  '';
				formData.children =  '';
				formData.dataIndex =  '';
				formData.text = self.text;
				var time = $("#selDate").val().split("~");
				formData.beginTime = time[0];
				formData.endTime = time[1];
				
				formData.value = self.value;
				formData.key = self.key;
				formData.archContent = $("#archContent").val();
				// formData.slots[icon] = 'apartment';
				formData.archName = $("#archName").val();
				formData.guid = self.value;
			}else{
				formData.archName = $("#archName").val();
				formData.year = $("#year").val();
				formData.archContent = $("#archContent").val();
				
				var time = $("#selDate").val().split("~");
				formData.beginTime = time[0];
				formData.endTime = time[1];
			}
			
			return formData;
		}
		// 对Date的扩展，将 Date 转化为指定格式的String
		// 月(M)、日(d)、小时(h)、分(m)、秒(s)、季度(q) 可以用 1-2 个占位符，
		// 年(y)可以用 1-4 个占位符，毫秒(S)只能用 1 个占位符(是 1-3 位的数字)
		// 例子：
		// (new Date()).Format("yyyy-MM-dd hh:mm:ss.S") ==> 2006-07-02 08:09:04.423
		// (new Date()).Format("yyyy-M-d h:m:s.S") ==> 2006-7-2 8:9:4.18

		Date.prototype.Format = function(fmt) { // author: meizz
			var o = {
				"M+": this.getMonth() + 1, // 月份
				"d+": this.getDate(), // 日
				"h+": this.getHours(), // 小时
				"m+": this.getMinutes(), // 分
				"s+": this.getSeconds(), // 秒
				"q+": Math.floor((this.getMonth() + 3) / 3), // 季度
				"S": this.getMilliseconds() // 毫秒
			};
			if (/(y+)/.test(fmt))
				fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
			for (var k in o)
				if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" +
					o[k]).substr(("" + o[k]).length)));
			return fmt;
		}

		function format_input(obj) {
			if (/^\s+$/gi.test(obj.value)) {
				obj.value = '';
			}
			var num = 50;
			if (obj.value.length >= num) {
				obj.value = obj.value.slice(0, num);
				// obj.focus();
				app.toast("节点名称不可大于" + num + "个字！")
			}
		}
		
		function format_textarea(obj) {
			if (/^\s+$/gi.test(obj.value)) {
				obj.value = '';
			}

			var num = 200;
				if(obj.value.length > 0){
					$("#clear").show();
					if (obj.value.length >= num) {
						obj.value = obj.value.slice(0,200);
						app.toast("描述不可大于200个字！")
					}
				}else $("#clear").hide();
		}
	</script>

</html>
