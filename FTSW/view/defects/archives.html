<!doctype html>
<html>

	<head>
		<meta charset="utf-8">
		<title>小区档案</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/mui.picker.min.css" rel="stylesheet" />
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/mui.picker.min.js"></script>
		<script src="../../js/jquery.min.js"></script>
		<!-- <script src="https://ajax.aspnetcdn.com/ajax/jquery/jquery-3.5.1.min.js"></script>	 -->
		<script src="../../js/underscore-min.js"></script>
		<script src="../../js/app.js"></script>
		<script src="../../js/config.js"></script>
		<script src="../../js/qrcode.js"></script>
		<script src="../../js/uploadimage.js"></script>
		<script src="../../js/s4.js"></script>
		<script src="../../js/smutils.js"></script>
		<script src="../../js/byte&string.js"></script>
		<script src="../../js/ajaxhook.min.js"></script>
		<script src="../../js/common.js"></script>
		<!-- <script src="../../js/vconsole.min.js"></script> -->
		<style>
			body {
				background: #fff;
				height: 100vh;
				/* .mui-title{
					text-align: center;
				} */
			}
			.mui-title{
				font-size: 28px;
			}
			.mui-input-row{
				padding: 10px 20px;
				background-color: #F4F4F4;
			}
			.mui-input-row .mui-input-clear{
				padding: 5px;
				width: 100%;
				height: 32px;
				text-align: center;
				border-radius: 25px;
				border: none;
				margin-bottom:0px;
				background: #fff;
			}
			.content{
			height: 100%;
/* 			  text-align: center;
			  width: 100%;
			  display: flex;
			  justify-content:center;
			  align-items:Center; */
			  margin-top: 50px;
			}
			.content .mui-table-view {
				list-style-type: none;
			}
			.content .mui-table-view .top {
				display: flex;
				justify-content: space-between;    
				padding: 10px 0;
			}
			.color888{
				color:#888888;
			}
			.colorFF7{
				color:#FF7800;
			}
			.color337{
				color:#337BFC;
			}
			.color000{
				color:#000;
			}
			.tpis{
				margin-top: 4px;
				text-align: center;
				background: #FFF7F0;
				border: 1px solid #FFAB61;
				border-radius: 2px;
				color: #FF7800;
				padding:0px 5px;
				line-height: 16px;
				font-size:12px;
				width: 54px;
				height: 16px;
			}
			.content .mui-table-view .top .topname {
				font-size: 16px;
				font-family: PingFang SC;
				font-weight: bold;
				color: #191515;
				line-height: 24px;
				width: 65%;
			}
			.content .mui-table-view .top .isArc {
				margin-top: 4px;
				text-align: center;
				background: rgb(51, 123, 252, 0.1);
				border: 1px solid #329CFC;
				border-radius: 2px;
				color: #337BFC;
				padding:0px 5px;
				line-height: 16px;
				font-size:12px;
				width: 54px;
				height: 16px;
				/* margin-left:5% ; */
			}
			
			.content .mui-table-view .top .addres {
				font-size: 14px;
				font-family: PingFang SC;
				font-weight: 400;
				color: #888888;
				line-height: 7px;
			}
			.content .mui-table-view .top .omit {			
				line-height: 14px;
				word-break: break-all;
				width: 70%;             
				overflow: hidden;      
				text-overflow: ellipsis;  
				white-space: nowrap; 
			}
			.content .mui-table-view .top .toptext {
				font-size: 14px;
				font-family: PingFang SC;
				font-weight: 400;
				color: #191515;
				line-height: 7px;
			}
			.content .mui-table-view .top .toptext .unit {
				font-size: 14px;
				font-family: PingFang SC;
				font-weight: 400;
				color: #888888;
				line-height: 7px;
			}
			.header_search{
				display: flex;
				background-color: #F4F4F4;
				justify-content: space-between;
				position: absolute;
				width: 100%;
				z-index: 99;
				top:0;
			}
			.mui-search{
				width: 100%;
			}
			.mui-search .mui-placeholder{
				line-height: 52px;
			}
			.mui-search.mui-active:before{
				left: 30px;
				line-height: 35px;
			}
			.mui-input-row.mui-search .mui-icon-clear{
				top: 17px;
				right: 20px;
			}
			.mui-search .mui-placeholder{
				text-align: left;
				padding-left: 30px;
			}
			.mui-table-view-cell{
				border-bottom: 5px solid #F4F4F4;;
			}
			.mui-table-view-cell:after{
				height: 0;
			}
			#keyinput{
				text-align: left;
			}
			
			.no-data {
				position: absolute;
				top: 15rem;
				left: 50%;
				font-size: 14px;
				color: #999;
				transform: translateX(-50%);
				display: none;
			}
		</style>
	</head>

	<body>
		<!-- <header class="mui-bar mui-bar-nav">
		  <a class="mui-icon mui-action-menu mui-icon-bars mui-pull-left"></a>
		  <h1 class="mui-title">小区档案</h1>
		  <a class="mui-icon mui-action-menu mui-icon-bars mui-pull-right"></a>
		  <a class="mui-icon mui-action-menu mui-icon-bars mui-pull-right"></a>
		</header> -->
		<div class="header_search">
			<div class="mui-input-row mui-search" style="text-align: left">
				<img src="../../img/commom/search1@2x.png" style="width: 20px;height:20px;position: absolute;top:15px;left:30px"/>
				<input id="keyinput" type="text" style="width: 100%;padding-left:40px;border:none;" class="mui-input-clear" placeholder="请输入小区名称">
			</div>
			<!-- <img id="xqdapx" style="width:18px;height:18px;margin: 18px 20px 10px 0;" src="../../img/commom/xqdapx@2x.png" alt=""> -->
		</div>
		</div>
		<div id="qrcode" style="width:0px; height:0px; margin:0px;padding: 0;" style="display: none;"></div>
		<div class="content" id="content">
			<ul class="mui-table-view" id="element"></ul>
			<div class="no-data">暂无数据！</div>
		</div>


		<!-- 定义模板，将模板内容放到一个script标签中 -->
		<script type="text/template" id="tpl">
			<% for(var i = 0; i < list.length; i++) { %> 
			<% var item = list[i] %> 
			<li class="mui-table-view-cell" dataid="<%=item.guid%>" > 
				<div class="top"> 
					<span class="color000 topname"><%=isEmp(item.reCode)%></span>
					<span class="isArc"><%=item.archivedAttachment == null?'未归档':'已归档'%></span>
					<span class="tpis"><%=yearLabel%>年</span>
				</div>
				<div class="top">
					<span class="toptext">检测: 
						<span class="color337"><%=item.checkCount%> </span>
						<span class="unit">(条)</span>
					</span>
					<span class="toptext">清疏: 
						<span class="color337"><%=item.dredgCount%> </span>
						<span class="unit">(条)</span>
					</span>
					<span class="toptext">缺陷: 
						<span class="color337"><%=item.bugCount%> </span>
						<span class="unit">(条)</span>
					</span>
				</div>
				<div class="top">
					<span class="addres omit"><%=isEmp(item.reName)%></span>
					<span class="addres">填写人: <%=isEmp(item.inputFullname)%></span>
				</div>
			</li> 
			<% } %> 
		
		</script>

		<script>

			// var vConsole = new VConsole();
			$("body").delegate(".mui-icon-clear", "tap", function(e) {
				dataApi.reName = ''
				getlist()

			});
			var OpenBottom = true;
			var qrcode = new QRCode(document.getElementById("qrcode"), {
				width: 100,
				height: 100
			});
			var item = {}
			var pickerpxtop = null
			var pickerpx = new mui.PopPicker({
				buttons: ['取消', '确定']
			}); //
			var counterIsok = true
			var datalist = []
			var keytext = ''
			var dataApi = {
				archId: '',
				reName: '',
				column: 'createTime',
				order: 'desc',
				field: 'id,,,reCode,reName,stationName,streetName,checkCount,dredgCount,bugCount,doc,action',
				pageNo: 0,
				pageSize: 20
			}

			var wjldata = '';
			var pickerpxtopdata = null;
			var yearLabel = '';
			var beginTime = '';
			var endTime = '';
			
			//页面初始化完成渲染
			mui.plusReady(function() {
				// pickerpxtop= new mui.PopPicker({
				// 		buttons: ['取消', '确定']
				// }); //
				// var self = plus.webview.currentWebview();
				// self.setStyle({
				//     titleNView: {  
				// 	// backgroundImage:"../../img/bgTop.png",
				// 	// backgroundRepeat:'no-repeat',
				// 		buttons: [{
				// 			"color": "white",
				// 			"colorPressed": "gray",
				// 			"float": "right",
				// 			"fontWeight": "400",
				// 			"fontSize": "24px",
				// 			"fontSrc": "../../fonts/iconfont.ttf",
				// 			"text": "\ue773",
				// 			"onclick": Selecttree
				// 		}]

				//     }  
				// });
				var OpenBottom = true;
				pickerpxtop = new mui.PopPicker({
					buttons: ['取消', '确定']
				}); //		
										
				Selecttree(); 
				
				var self = plus.webview.currentWebview();

				var Selectcolumn = function() {
					if (OpenBottom) {
						OpenBottom = false;
						pickerpxtop.setData(pickerpxtopdata); //{value:'word',text:'word文档'},
						pickerpxtop.show(pickercolumn)
					} else {
						pickerpxtop.hide()
						OpenBottom = true;
						// pickerpxtop.hide()
					}
				}

				function pickercolumn(selectItems) { //选择确定按钮
					dataApi.archId = selectItems[0].value;
					dataApi.reName = '';
					$("#keyinput").val("")
					if(selectItems[0].text.length>8){
						yearTitle = selectItems[0].text.substring(0,8)+"...\ue8b6"
					}else yearTitle = selectItems[0].text+"\ue8b6";
					yearLabel = selectItems[0].label
					beginTime = selectItems[0].beginTime
					endTime = selectItems[0].endTime
					getlist();
					self.setStyle({
						titleNView: {
							backgroundImage:"../../img/bgTop.png",
							backgroundRepeat:'no-repeat',
							buttons: [{
								"color": "white",
								"colorPressed": "gray",
								"float": "left",
								"fontWeight": "400",
								"fontSize": "18px",
								"fontSrc": "../../fonts/iconfont.ttf",
								"text": yearTitle,
								"onclick": Selectcolumn,
								"width": "300px",
							},
							{
								"color": "white",
								"colorPressed": "gray",
								"float": "right",
								"fontWeight": "500",
								"fontSize": "25px",
								"fontSrc": "../../fonts/iconfont.ttf",
								"text": "",
								"onclick": function() {
									app.openPage("nodeList.html", {
										titleNView: {
											titleText: '节点列表',
											autoBackButton: true,
										}
										});
									},
								"width": "50px",
							}]

						}
					});
				};	
				// console.log(JSON.stringify(pickerpxtopdata))
				if(pickerpxtopdata[pickerpxtopdata.length-1].text.length>8){
					yearTitle = pickerpxtopdata[pickerpxtopdata.length-1].text.substring(0,8)+"...\ue8b6"
				}else yearTitle = pickerpxtopdata[pickerpxtopdata.length-1].text+"\ue8b6";
				yearLabel = pickerpxtopdata[pickerpxtopdata.length-1].label
				beginTime = pickerpxtopdata[pickerpxtopdata.length-1].beginTime
				endTime = pickerpxtopdata[pickerpxtopdata.length-1].endTime
				dataApi.archId = pickerpxtopdata[pickerpxtopdata.length-1].value;
				self.setStyle({
					titleNView: {
						backgroundImage:"../../img/bgTop.png",
						backgroundRepeat:'no-repeat',
						buttons: [{
							"color": "white",
							"colorPressed": "gray",
							"float": "left",
							"fontWeight": "400",
							"fontSize": "18px",
							"fontSrc": "../../fonts/iconfont.ttf",
							"text": yearTitle,
							"onclick": Selectcolumn,
							"width": "300px"
						},
						{
							"color": "white",
							"colorPressed": "gray",
							"float": "right",
							"fontWeight": "500",
							"fontSize": "25px",
							"fontSrc": "../../fonts/iconfont.ttf",
							"text": "",
							"onclick":function() {
								app.openPage("nodeList.html", {
										titleNView: {
											titleText: '节点列表',
											autoBackButton: true,
										}
									});
								},
							"width": "50px",
						}]
					}
				});
				// getlist();
			})
			
			var Selectcolumn = function() {
				if (OpenBottom) {
					OpenBottom = false;
					pickerpxtop.setData([{
						value: 'mainNo',
						text: '编号'
					}, {
						value: 'communityName',
						text: '小区名称'
					}, {
						value: 'year',
						text: '年度'
					}]); //{value:'word',text:'word文档'},
					pickerpxtop.show(pickercolumn)
				} else {
					pickerpxtop.hide()
					OpenBottom = true;
					// pickerpxtop.hide()
				}
			}
			
			$("#keyinput").on("input  propertychange", function() {
				keytext = $(this).val()
				dataApi.pageNo = 1
				datalist = []
				dataApi.reName = $(this).val()
                $('#element').html("")//清掉原来的内容先
				getlist()
			});
			var Selecttree = function() {
				var url = config.urls.baseUrl + config.actions.tree;
				$.ajax(url, {
					data: "",
					dataType: 'json', //服务器返回json格式数据
					type: 'get', //HTTP请求类型
					async: false,
					headers: {
						"Content-Type": "application/json",
						// "Content-Type": "application/x-www-form-urlencoded",
						"X-Access-Token": app.sessionId(),
						// "X-Access-Token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE1OTg5Mjk1MDYsInVzZXJuYW1lIjoiY3doMDEifQ.f1H4CpN_us8XRDI-Nxdpfsw4Xc6eku1tVFmicLM1syw"
					},
					timeout: config.settings.requestTimeOut, //超时时间设置为10秒；
					success: function(data) {
						app.hideLoader();
						if (dealingWithResponseCode(data)) {
							arr = []
							for (let i = 0; i < data.result.length; i++) {
								arr.push({
									value: data.result[i].value,
									text: data.result[i].label,
									label:  data.result[i].year,
									beginTime: data.result[i].beginTime,
									endTime: data.result[i].endTime,
								})
							}
							pickerpxtopdata = arr;
							// console.log(JSON.stringify(pickerpxtopdata))
							// if(OpenBottom){
							// 	OpenBottom = false;
							// 	pickerpx.setData(arr); //{value:'word',text:'word文档'},
							// pickerpx.show(pickerdatapx)
							// }else{
							// 	pickerpx.hide()
							// 	OpenBottom = true;
							// }
						} else {
							app.toast(data.message);
						}
					},
					error: function(xhr, type, errorThrown) {
						dealingWithErrorRequest(errorThrown);
						app.hideLoader();
						app.toast('网络异常,请稍后再试')
					}
				});
			}
			
			$("#xqdapx").on('tap', function(e) {
				var pickerpxtop = new mui.PopPicker({
					buttons: ['取消', '确定']
				}); //
				pickerpxtop.setData([{
					value: 'mainNo',
					text: '编号'
				}, {
					value: 'communityName',
					text: '小区名称'
				}, {
					value: 'year',
					text: '年度'
				}]); //{value:'word',text:'word文档'},
				pickerpxtop.show(pickercolumn)
				// pickerpx.hide(pickerdatahide)
			});

			mui.init({
				pullRefresh: {
					container: '#content', //待刷新区域标识，querySelector能定位的css选择器均可，比如：id、.class等
					up: {
						height: 50, //可选.默认50.触发上拉加载拖动距离
						auto: true, //可选,默认false.自动上拉加载一次
						contentrefresh: "正在加载...", //可选，正在加载状态时，上拉加载控件上显示的标题内容
						contentnomore: '没有更多数据了', //可选，请求完毕若没有更多数据时显示的提醒内容；
                        contentdown:'',
						callback: pullupRefresh //必选，刷新函数，根据具体业务来编写，比如通过ajax从服务器获取新数据；
					},down: {
            		},
				},
				swipeBack:false
			});
			
			var picker = new mui.PopPicker(); //{buttons:['cancle','ok']}
			picker.cancel.addEventListener('tap', function(event) {
				console.log('点击取消按钮userPicker.cancel')
			}, false);

			function pullupRefresh() {
			    // console.log("*******************")
                setTimeout(function() {
                    if (counterIsok) {
                        dataApi.pageNo++
                        this.getlist();
                        // dataApi.pageNo++
                    } else {
                        app.toast('已全部加载完')
                        $('#dataloadover').css('display', 'block')
                    }
                    mui('#content').pullRefresh().endPullupToRefresh();
                }, 800)
            }

			function pickerdata(selectItems) { //选择确定按钮
				var extras = item
				console.log('SelectedItem' + JSON.stringify(selectItems));
				getFileurl1()
				// extras.url = wjldata

				// app.openPage("./preview.html", {
				//     titleNView: {
				//         titleText: '文档预览',
				//         autoBackButton: true
				//     }
				// }, extras);
			}


			// function pickerdatapx(selectItems) { //选择确定按钮
			// 	console.log('SelectedItem' + JSON.stringify(selectItems[0].value));
			// 	dataApi.archId = selectItems[0].value;
			// 	getlist()
			// }

			function pickercolumn(selectItems) { //选择确定按钮
				console.log('SelectedItem' + JSON.stringify(selectItems[0].value));
				dataApi.column = selectItems[0].value;
				getlist()
			}

			function pickerdatahide() { //选择确取消
				//重置
				// dataApi = {}
				// getlist()
			}

			function getFileurl1() {
				var extras = {}
				extras.value = item;
				extras.archId = dataApi.archId;
				extras.beginTime = beginTime;
				extras.endTime = endTime;
				// console.log(JSON.stringify(extras))
				// if(item.archivedAttachment !=null){
					app.openPage("./preview.html", {
						titleNView: {
							titleText: '文档预览',
							autoBackButton: true
						}
					}, extras);	
				// }else app.toast("该小区未归档")

			}
			//获取文档地址
			function getFileurl() {
				// app.toast('获取文档地址')
				var url = config.urls.baseUrl + config.actions.drainageDistrictFiledownload;

				var qrUrl = url + '/pdf?guid=' + item.guid +
					'&beginTime=' + item.beginTime + '&endTime=' + item.endTime +
					'&path=' + config.urls.domain + '/ecidi-cmp/sys/common/view/ecidi/35574339ab3c813.jpg'
				console.log(url)
				qrcode.makeCode(qrUrl)
				let canvas = qrcode._el.querySelector("canvas");

				var base64Text = canvas.toDataURL("image/png");
				//调用
				// var blob = dataURLtoBlob(base64Text);
				app.baseImgFile('blob', A, 'qrimgName', function(i) {
					console.log(JSON.stringify(i.target))
					plusUploadFile(i.target, function(data) {
						url = config.urls.baseUrl + config.actions.drainageDistrictFiledownload + "/pdf"

						if (data.success) {
							var getApi = {
								beginTime: item.beginTime,
								endTime: item.endTime,
								guid: item.communityId,
								archId: '',
								// type: 'pdf',
								path: "ecidi/35574339ab3c813.jpg",
								qrPath: data.result.uploadFile.savePath,

								// 'guid':'re_area_1953',
								// 'beginTime':'2020-01-01',
								// 'endTime':'2020-12-31',
								// 'path':'ecidi/35574339ab3c813.jpg',
								// 'qrPath':'ecidi/a5479feaf717497483517ede8c5d7a0a.jpg',

							}

							var params = new FormData();
							for (var i in getApi) {
								params[i] = getApi[i]
							}
							app.showLoader();
							console.log('0')
							console.log(JSON.stringify(getApi))

							// function request () {
							// 	const req = new XMLHttpRequest();
							// 	req.open('POST', url, true);
							// 	req.responseType = 'blob';
							// 	req.setRequestHeader('Content-Type', 'application/json');
							// 	req.onload = function() {
							// 	  const data = req.response;
							// 	  const a = document.createElement('a');
							// 	  const blob = new Blob([data]);
							// 	  const blobUrl = window.URL.createObjectURL(blob);
							// 	  console.log(JSON.stringify(blobUrl))
							// 	  download(blobUrl) ;
							// 	};
							// 	req.send('<请求参数：json字符串>');
							//   };

							// function download(blobUrl) {
							//   const a = document.createElement('a');
							//   a.style.display = 'none';
							//   a.download = '安保处';
							//   a.href = blobUrl;
							//   a.click();
							//   // document.body.removeChild(a);
							// }
							// request()
							// dtask  = plus.downloader.createDownload(url, {"X-Access-Token": app.sessionId()},  function(d, status){
							// 	if(status == 200){ 
							// 				console.log("Download success: " + d.filename);
							// 			} else {
							// 				 console.log("Download failed: " + status); 
							// 			}  
							// })
							// console.log(JSON.stringify(dtask.start()))
							// var strgetApi = ''
							// for(key in getApi){
							// 	strgetApi += key +'=' + getApi[key]+';'
							// }
							// download(url,strgetApi)
							console.log(url)
							//----------------------------------------------
							$.ajax(url, {
								type: 'post',
								contentType: 'application/x-www-form-urlencoded', //服务器返回文件流格式数据
								data: getApi,
								headers: {
									"X-Access-Token": app.sessionId()
								},
								// responseType: 'blob', //设置响应的数据类型为一个包含二进制数据的 Blob 对象，必须设置！！！
								success: function(res) {
									if (dealingWithResponseCode(res)) {
										plus.io.requestFileSystem(plus.io.PUBLIC_DOWNLOADS, function(fs) {
											// fs.root.getFile('txt.pdf', {create:true},{},{})

											fs.root.getFile('txt.pdf', {
												create: true
											}, function(entry) {

												entry.createWriter(function(writer) {
													console.log(entry.fullPath);
													// console.log(''+res)
													// Write data to the end of file.
													writer.write('' + res);
													writer.onwrite = function(e) {
														console.log(e)
														console.log("Write data success!");
														plus.io.getFileInfo({
															filePath: 'txt.pdf'
														});

														path = entry.fullPath
														console.log(plus.io.convertAbsoluteFileSystem(path))
														var extras = item
														extras.url = plus.io.convertAbsoluteFileSystem(path);
														extras.url = plus.io.convertAbsoluteFileSystem('test.pdf');
														console.log(extras.url)
														app.openPage("./preview.html", {
															titleNView: {
																titleText: '文档预览',
																autoBackButton: true
															}
														}, extras);
													};

												}, function(e) {
													console.log(e)
													alert(e.message);
												});
											}, function(error) {
												console.log(error)
											});

											plus.io.getFileInfo({
												filePath: 'txt.pdf'
											});
										}, function(error) {
											console.log(error)
										});
									} else {
										app.toast(res.message);
									}
									// console.log('res:'+res);





									// 	var blob = new Blob([res], {
									// 		type: 'application/pdf;chartset=UTF-8'
									// 	})




									// 	var binaryData = [];
									// 	binaryData.push(res);
									// 	this.url =getObjectURL(res); //window.URL.createObjectURL(new Blob(binaryData, {type:"application/zip"}));

									// 	var extras=item;
									// 	extras.url =encodeURIComponent(this.url);
									// 	app.openPage("./preview.html", {
									// 		titleNView: {
									// 			titleText: '文档预览',
									// 			autoBackButton: true
									// 		}
									// 	}, extras);


									// console.log(res)
									// let filename = '深圳市福田区小区排水设施运维工作档案.pdf'
									// if (typeof window.navigator.msSaveOrOpenBlob !== 'undefined') {
									//           window.navigator.msSaveOrOpenBlob(new Blob([res]), filename)
									// 		  console.log('if')
									//         } else {
									// 			console.log('else')
									//           let url = window.URL.createObjectURL(new Blob([res]))
									//           let link = document.createElement('a')
									//           link.style.display = 'none'
									//           link.href = url
									//           link.setAttribute('download', filename)
									//           document.body.appendChild(link)
									//           link.click()
									//           // document.body.removeChild(link) // 下载完成移除元素
									//           // window.URL.revokeObjectURL(url) // 释放掉blob对象
									// 		  console.log(url)
									// 			app.hideLoader();
									//         }
									// var binaryData = [];

									// binaryData.push(data);

									// url =window.URL.createObjectURL(new Blob(binaryData, {type:"application/zip"}));

									// console.log(url);
									// wjldata = url
									// app.hideLoader();
									// var extras = item
									// extras.url = wjldata

									// app.openPage("./preview.html", {
									//     titleNView: {
									//         titleText: '文档预览',
									//         autoBackButton: true
									//     }
									// }, extras);
								},
								error: function() {
									alert('错误')
								}
							});

							//---------------------------------------------
							//////////
							// var xhr = new XMLHttpRequest()
							// xhr.open('POST', url, true)
							// xhr.setRequestHeader("X-Access-Token",app.sessionId())
							// xhr.responseType = 'blob'
							// xhr.onload = function (e) {
							//     if (xhr.status == 200) {
							//         var blob = xhr.response
							//         var pdfurl = window.URL.createObjectURL(blob);

							//         console.log(pdfurl);

							// 		var extras=item;
							// 		extras.url = encodeURIComponent(pdfurl);

							// 		app.openPage("./preview.html", {
							// 		    titleNView: {
							// 		        titleText: '文档预览',
							// 		        autoBackButton: true
							// 		    }
							// 		}, extras);
							//         // window.open('kite/static/pdf/web/viewer.html?file=' +);

							//     }
							// }
							// xhr.send(JSON.stringify(getApi))
							////////
							// // // // console.log("http://zhswtest.ecidi.com/ecidi-cmp/ft-device/drainageDistrictFile/download/pdf"+convParams(getApi))
							// // var x = "http://zhswtest.ecidi.com/ecidi-cmp/ft-device/drainageDistrictFile/download/pdf"+convParams(getApi)
							// $.ajax(url+ convParams(getApi), {
							// 	// data: convParams(getApi),
							// 	// data: "",
							// 	dataType: 'json', //服务器返回json格式数据
							// 	type: 'post', //HTTP请求类型
							// 	headers: {
							// 		// "Content-Type": "application/json",
							// 		// "Content-Type": "application/x-www-form-urlencoded",
							// 		// "Content-Type": "multipart/form-data; boundary=--6c7a1966e0294e1cb89b06b95cf3da84",
							// 		"X-Access-Token": app.sessionId(),
							// 		// "X-Access-Token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE1OTg5Mjk1MDYsInVzZXJuYW1lIjoiY3doMDEifQ.f1H4CpN_us8XRDI-Nxdpfsw4Xc6eku1tVFmicLM1syw"
							// 	},
							// 	// timeout: config.settings.requestTimeOut, //超时时间设置为10秒；
							// 	success: function(data) {
							// 		console.log(JSON.stringify(data))
							// 		app.hideLoader();
							// 		if (data.code == 200) {

							// 		}else{
							// 			console.log(JSON.stringify(data.code))
							// 			app.toast('网络异常,请稍后再试')
							// 		}
							// 	},
							// 	error: function(xhr, type, errorThrown) {
							// 		console.log(JSON.stringify(data))
							// 		app.hideLoader();
							// 		app.toast('error,请稍后再试')
							// 	}
							// },"json");


						} else {
							console.log(JSON.stringify(data))
							app.hideLoader();
							app.toast("数据异常")
						}
					})
					// var filesdata = new FormData()
					// filesdata.append('file',i.target);
					// var url = "http://zhswtest.ecidi.com/ecidi-cmp/file/uploadFile/add";
					// app.showLoader();
					// $.ajax(url, {
					// 	data: filesdata,
					// 	dataType: 'json', //服务器返回json格式数据
					// 	type: 'post', //HTTP请求类型
					// 	headers: {
					// 		"Content-Type": "multipart/form-data;boundary = "+ new Date().getTime(),
					// 		"X-Access-Token": app.sessionId()
					// 	},
					// 	timeout: config.settings.requestTimeOut, //超时时间设置为10秒；	
					// 	success: function(data) {
					// 		if (data.success) {
					// 			var getApi = {
					// 				beginTime: item.beginTime,
					// 				endTime: item.endTime,
					// 				guid: item.guid,
					// 				type: 'pdf',
					// 				path:"http://zhswtest.ecidi.com/ecidi-cmp/sys/common/view/ecidi/35574339ab3c813.jpg",
					// 				qrpath:data.result.uploadFile.savePath
					// 			}
					// 			console.log(JSON.stringify(getApi))
					// 			app.showLoader();
					// 			alert('0')
					// 			$.ajax(url, {
					// 				data: getApi,
					// 				data: "",
					// 				dataType: 'json', //服务器返回json格式数据
					// 				type: 'get', //HTTP请求类型
					// 				headers: {
					// 					// "Content-Type": "application/json",
					// 					"Content-Type": "application/x-www-form-urlencoded",
					// 					"X-Access-Token": app.sessionId(),
					// 					// "X-Access-Token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE1OTg5Mjk1MDYsInVzZXJuYW1lIjoiY3doMDEifQ.f1H4CpN_us8XRDI-Nxdpfsw4Xc6eku1tVFmicLM1syw"
					// 				},
					// 				timeout: config.settings.requestTimeOut, //超时时间设置为10秒；
					// 				success: function(data) {
					// 					console.log('extras' + JSON.stringify(data))
					// 					app.hideLoader();
					// 					if (data.code == 200) {

					// 						alert('1')
					// 					}
					// 				},
					// 				error: function(xhr, type, errorThrown) {
					// 					console.log('接口异常', xhr, type, errorThrown, 'app.sessionId()' + app.sessionId())
					// 					app.hideLoader();
					// 					app.toast('网络异常,请稍后再试')
					// 				}
					// 			});
					// 		} else {
					// 			console.log(JSON.stringify(data))
					// 			app.hideLoader();
					// 			app.toast("数据异常") 
					// 		}

					// 	},
					// 	error: function(xhr, type, errorThrown) {
					// 		dealingWithErrorRequest(errorThrown);
					// 		app.hideLoader();
					// 		return app.toast('网络异常,请稍后再试');
					// 	}
					// });
				});
				// plusUploadFile(file,function(data){
				// 	console.log(JSON.stringify(data))
				// })

			}

			function download(url, data) {
				var xmlResquest = new XMLHttpRequest();
				xmlResquest.open("POST", url, true);
				xmlResquest.setRequestHeader("Content-type", "application/json");
				xmlResquest.setRequestHeader("Authorization", "Bearer 6cda86e3-ba1c-4737-972c-f815304932ee");
				xmlResquest.responseType = "blob";
				xmlResquest.onload = function(oEvent) {

					var content = xmlResquest.response;
					var elink = document.createElement('a');
					elink.download = "test.pdf";
					elink.style.display = 'none';
					var blob = new Blob([content]);
					console.log(JSON.stringify(content))
					elink.href = URL.createObjectURL(blob);
					document.body.appendChild(elink);
					elink.click();
					document.body.removeChild(elink);
				};
				console.log(data)
				xmlResquest.send(data);
			}


			function _base64ToArrayBuffer(data) {
				var binary_string = decodeURIComponent(escape(window.atob(data.toString().replace(/-/g, "+").replace(/_/g, "/"))));


				var len = binary_string.length;
				var bytes = new Uint8Array(len);
				for (var i = 0; i < len; i++) {
					bytes[i] = binary_string.charCodeAt(i);
				}
				return bytes.buffer;
			}
			// 将返回的流数据转换为url
			function getObjectURL(file) {
				let url = null;
				if (window.createObjectURL != undefined) { // basic
					url = window.createObjectURL(file);
				} else if (window.URL != undefined) { // webkit or chrome
					try {
						url = window.URL.createObjectURL(file);
					} catch (error) {
						alert('暂不支持文件流转换')
					}
				} else if (window.URL != undefined) { // mozilla(firefox)
					try {
						url = window.URL.createObjectURL(file);
					} catch (error) {

					}
				}
				return url;
			}
			//将base64转换为blob
			var dataURLtoBlob = function(dataurl) {
				var arr = dataurl.split(','),
					mime = arr[0].match(/:(.*?);/)[1],
					bstr = atob(arr[1]),
					n = bstr.length,
					u8arr = new Uint8Array(n);
				while (n--) {
					u8arr[n] = bstr.charCodeAt(n);
				}
				return new Blob([u8arr], {
					type: mime
				});
			};
			//将blob转换为file
			var blobToFile = function(theBlob, fileName) {
				theBlob.name = new Date();
				theBlob.file = fileName;
				return theBlob;
			};

			// 参数转换
			function convParams(param) {
				let mark = '?';
				//         let hasMark = this.url.indexOf(mark) > 0; // 是否包含特殊字符
				//         if (hasMark){
				//             mark = '&';
				//         }

				let newParams = '';
				let i = 0;
				for (let key in param) {
					if (i > 0) {
						newParams += `&${key}=${encode(param[key])}`;
					} else {
						newParams += `${mark}${key}=${encode(param[key])}`;
					}
					i++;
				}

				function encode(val) {
					return encodeURIComponent(val);
				}

				return newParams;
			}

			$("#element").on('click', 'li', function(e) {
				console.log(this.getAttribute('dataid'))
				item = datalist.find(ele => {	
					return ele.guid == this.getAttribute('dataid');
				})
				// console.log(JSON.stringify(item))
				// picker.setData([{
				// 	value: 'pdf',
				// 	text: 'PDF'
				// }]); //{value:'word',text:'word文档'},
				// picker.show(pickerdata)

				//直接进入预览页
				getFileurl1();
			});

			function getlist() {
				//获取后台数据
				var url = config.urls.baseUrl + config.actions.archlist;
				// console.log(url)
				var param = dataApi;

				app.showLoader();
				console.log(JSON.stringify(param))
				$.ajax(url, {
					data: param,
					dataType: 'json', //服务器返回json格式数据
					type: 'get', //HTTP请求类型
					headers: {
						"Content-Type": "application/json",
						// "Content-Type": "application/x-www-form-urlencoded",
						"X-Access-Token": app.sessionId(),
						// "X-Access-Token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE1OTg5Mjk1MDYsInVzZXJuYW1lIjoiY3doMDEifQ.f1H4CpN_us8XRDI-Nxdpfsw4Xc6eku1tVFmicLM1syw"
					},
					timeout: config.settings.requestTimeOut, //超时时间设置为10秒；
					success: function(data) {
						// console.log("data:",JSON.stringify(data.result))
						app.hideLoader();
						if(data.result.total == 0){
							$('.no-data').show();
						}else{
							$('.no-data').hide();
						}
						if (dealingWithResponseCode(data)) {
							// console.log(111111111111111111111111111111111111111)
							// $('#element').html("")
							var element = $('#element'),
								tpl = $('#tpl').html();
							// 解析模板, 返回解析后的内容    
							var render = _.template(tpl);
							// console.log('data.result.records.length<dataApi.pageSize', data.result.records.length, dataApi.pageSize)
							if (data.result.records.length < dataApi.pageSize) {
								counterIsok = false; //加载完毕
							}
							datalist = []
							datalist = datalist.concat(data.result.records)

							var html = render({
								list: datalist
							});

							// 将解析后的内容填充到渲染元素    
							// element.html(html);
							element.append(html);
							// document.getElementById('element').innerHTML = document.getElementById('element').innerHTML+html;
						} else {
							app.toast(data.message);
						}
					},
					error: function(xhr, type, errorThrown) {
						dealingWithErrorRequest(errorThrown);
						app.hideLoader();
						app.toast('网络异常,请稍后再试')
					}
				});

			}
			
		window.addEventListener('reload1', function(e) { //执行刷新	
			keytext = $("#keyinput").val()
			dataApi.pageNo = 1
			datalist = []
			dataApi.reName = $("#keyinput").val()
			getlist()
		});
		</script>
	</body>

</html>
