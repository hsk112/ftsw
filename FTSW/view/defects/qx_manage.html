<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>缺陷管理-新增缺陷</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/mui.picker.css" rel="stylesheet" />
		<link href="../../css/mui.picker.min.css" rel="stylesheet" />
		<link href="../../css/mui.poppicker.css" rel="stylesheet" />
		<link href="../../css/common.css" rel="stylesheet" />
		<!--<link href="../../css/ps.css" rel="stylesheet" />-->
		<link rel="stylesheet" type="text/css" href="../../css/mui.imageviewer.css" />
		<style>
			.mui-popover {
				height: 60px;
			}
			.paish .btn-item{
				width: 100%;
			}
			img[src=""],img:not([src]){
				opacity:0;
			}
			.bar-content-item{
				height: 150px;
				margin: 0px 20px;
				padding-bottom: 10px;
				border-bottom: 1px solid #EDEDED;
			}
			.bar-content-item .item-title{
				text-align: left;
				padding: 15px 0px 10px 0px;
				font-size: 14px;
				color: #444444;
			}
        .img_item{
			text-align: left;
			width: 72px;
			height: 100px;
			float: left;
			margin-right: 20px;
        }
			.img_item img{
				width: 72px;
				height: 72px;
			}
		.delete-icon {
			position: absolute;
			top: 8px;
			right: 10px;
			z-index: 10;
			display: none;
			line-height: 16px;
			width: 16px;
			height: 16px;
			font-size: 16px;
			color: #FFFFFF;
			border-radius: 50%;
			background: #999999;
		}

			textarea {
				border: 1px solid #EDEDED;
			}
			textarea::-webkit-input-placeholder {
				color: #bbb;
			}

			/*横版*/
			/*.info-bar-content-item {*/
				/*display: flex;*/
				/*justify-content: space-between;*/
				/*text-align: left;*/
				/*font-size: 16px;*/
				/*font-weight: 400;*/
				/*margin: 0 0 0 20px;*/
				/*padding-top: 10px;*/
				/*border-bottom: 1px solid #EDEDED;*/
			/*}*/
			/*.info-bar-content-item .item-title {*/
				/*text-align: left;*/
				/*padding: 10px 0px 0px 0px;*/
				/*color: #444444;*/
				/*display: inline-block;*/
				/*vertical-align: top;*/
				/*line-height: 20px;*/
			/*}*/
			/*.info-bar-content-item .item-input {*/
				/*display: inline-block;*/
				/*width: 60%;*/
				/*padding-right: 20px;*/
			/*}*/
			.info-bar-content-item .item-input {
				float: right;width: 45%;height:70%;padding: 4.5px 0px 0px 0px; display: flex;
			}
			.test1{
				border: 1px solid red
			}
			.test2{
				border:1px solid blue;
			}
			.textAlignRight {
				text-align: right;
			}
			.right-img-center {
				display: flex;
				align-items: center;
				height: 40px;
				margin-left: 5px;
			}
			.paish .info-bar-content-item {
				height: 57px;
			}

			.show-tip-info {
				display: inline-block;
				margin-left: 10px;
				font-size: 12px;
				color: #337BFC;
				width: 24px;
				height: 21px;
				padding-top: 2px;
			}

		</style>

		<script>
			function deleteDate(a) {
				$("#"+a).val("");
				$("#"+a).next().css('display', 'none');
				if (a === 'comm_input') {
					commId = '';
					commName = '';
				}
				if (a === 'obj') {
					objId = '';
					objName = '';
				}
				if (a === 'locationContent') setLength({value: ''}, 300, 'wordsLength2');
				if (a === 'problemContent') setLength({value: ''}, 300, 'wordsLength');
				if (a === 'doneMeasures') setLength({value: ''}, 300, 'wordsLength3');
				if (a === 'bugLevel_input') levelId = '';
			}
		</script>
	</head>

	<body>
		<!--页面主结构开始-->
		<div id="app" class="mui-views">
			<div class="mui-view">
				<div class="mui-navbar">
				</div>
				<div class="mui-pages">
				</div>
			</div>
		</div>
		<!--页面主结构结束-->
		<!--单页面开始-->
		<div id="mui-content" class="mui-page paish">
			<!--页面标题栏开始-->
			<!--<header class="mui-bar mui-bar-nav common-header">-->
			<!--<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>-->
			<!--<h1 class="mui-title">缺陷管理</h1>-->
			<!--</header>-->
			<!--页面标题栏结束-->
			<!--页面主内容区开始-->
			<div class="mui-page-content">
				<div class="mui-scroll-wrapper" id="scroll">
					<div class="mui-scroll">
						<div class="scroll-li">
							<div class="info-bar-content">
								<div class="info-bar-content-item">
									<div class="item-title" style="float: left;width: 50%;font-size: 17px">
										缺陷来源
									</div>
									<div class="mui-input-row item-input" style="">
										<input id="bugSource" class="textAlignRight" readonly="readonly" type="text" style="width: 100%;font-size: 17px;" placeholder="请选择缺陷来源">
										<div class="right-img-center">
											<img src="../../img/arrow-right-gray.png" style="width: 7px; height: 12px;" alt="">
										</div>
									</div>
								</div>
								<!--<div class="info-bar-content-item">-->
								<!--<div class="item-title">-->
								<!--缺陷名称<span style="color: red;">*</span>-->
								<!--</div>-->
								<!--<div class="mui-input-row item-input">-->
								<!--<input id="bugTitle" type="text" class="mui-input-clear" value="" placeholder="请输入缺陷名称">-->
								<!--</div>-->
								<!--</div>-->
								<div class="info-bar-content-item" >
									<div class="item-title" style="float: left;width: 50%;font-size: 17px">
										<span style="color: red;">*</span>设施类型
									</div>
									<div class="mui-input-row item-input" >
										<input id="obj_input" class="textAlignRight" readonly="readonly" type="text" style="width: 100%;font-size: 17px;" value="" placeholder="请选择设施类型">
										<div class="right-img-center">
											<img src="../../img/arrow-right-gray.png" style="width: 7px; height: 12px;" alt="">
										</div>
									</div>
								</div>
								<div class="info-bar-content-item" >
									<div class="item-title" style="float: left;width: 50%;font-size: 17px">
										<span style="color: red;">*</span>所在片区
									</div>
									<div class="mui-input-row item-input">
										<input id="comm_input" class="textAlignRight" readonly="readonly" type="text" value="" placeholder="请选择所在片区">
										<span class="mui-icon mui-icon-closeempty delete-icon" style="margin-top: 8px;right:1px" onclick="deleteDate('comm_input')"></span>
										<div class="right-img-center">
											<img src="../../img/arrow-right-gray.png" style="width: 7px; height: 12px;" alt="">
										</div>
									</div>
								</div>
								<div class="info-bar-content-item">
									<div class="item-title" style="float: left;width: 50%;font-size: 17px">
										<span style="color: red;">*</span>所在地点
										<!--										<img id="location" src="../../img/commom/dz@2x.png" style="display: none;width: 18px;height: 18px;margin-top:5px;float: right;" />-->
									</div>
									<div class="mui-input-row item-input">
										<input id="locationContent" readonly="readonly" class="textAlignRight" type="text" value="" placeholder="请选择所在地点" maxlength="300"
											   onkeyup="setLength(this,300,'wordsLength2');">
										<span class="mui-icon mui-icon-closeempty delete-icon"  onclick="deleteDate('locationContent')" style="right:1px"></span>
										<span id="wordsLength2" style="display: none;position:absolute; right:5px; bottom:1vh;font-size:12px; color:#BDCADA">0/300</span>
										<div class="right-img-center">
											<img src="../../img/arrow-right-gray.png" style="width: 7px; height: 12px;" alt="">
										</div>
									</div>
								</div>
								<div class="info-bar-content-item" >
									<div class="item-title" style="float: left;width: 50%;font-size: 17px">
										<span style="color: red;">*</span>设施编号
									</div>
									<div class="mui-input-row item-input">
										<input id="obj" readonly="readonly" class="textAlignRight" type="text" value="" placeholder="地点选择后回填">
										<span class="mui-icon mui-icon-closeempty delete-icon" style="margin-top: 8px;right:1px" onclick="deleteDate('obj')"></span>
										<div class="right-img-center">
											<img src="../../img/arrow-right-gray.png" style="width: 7px; height: 12px;" alt="">
										</div>
									</div>
								</div>


								<!--<div class="info-bar-content-item">-->
								<!--<div class="item-title">-->
								<!--缺陷<span style="color: red;"></span>-->
								<!--</div>-->
								<!--<div class="mui-input-row item-input">-->
								<!--<input id="bug_input" readonly="readonly" type="text" class="mui-input-clear" value="" placeholder="请选择缺陷">-->
								<!--</div>-->
								<!--</div>-->

								<div class="info-bar-content-item" style="height: 57px">
									<div class="item-title" style="float: left;width: 50%;font-size: 17px">
										<span style="color: red;">*</span>缺陷类型
									</div>
									<div class="mui-input-row item-input" >
										<input id="bugType_input" class="textAlignRight"  readonly="readonly" type="text" style="width: 90%;" value="" placeholder="请选择缺陷类型">
										<div class="right-img-center">
											<img src="../../img/arrow-right-gray.png" style="width: 7px; height: 12px;" alt="">
										</div>
									</div>
								</div>
								<div class="info-bar-content-item" style="height: 57px">
									<div class="item-title" style="float: left;width: 50%;font-size: 17px">
										<span style="color: red;"></span>缺陷等级
									</div>
									<div class="mui-input-row item-input" >
										<input id="bugLevel_input" class="textAlignRight" readonly="readonly" type="text" style="width: 90%;" value="" placeholder="请选择缺陷等级">
										<span class="mui-icon mui-icon-closeempty delete-icon" style="margin-top: 7px" onclick="deleteDate('bugLevel_input')"></span>
										<div class="right-img-center">
											<img src="../../img/arrow-right-gray.png" style="width: 7px; height: 12px;" alt="">
										</div>
									</div>
								</div>
								<div class="bar-content-item" style="height: 180px;">
									<div class="item-title" style="margin-bottom: 10px;font-size: 17px;border-bottom: 1px solid #ededed;">
										<span style="color: red;">*</span>缺陷描述
									</div>
									<div class="mui-input-row item-input">
										<!--<input type="text" class="mui-input-clear" value="" placeholder="请输入缺陷描述">-->
										<textarea id="problemContent" maxlength="300" rows="5" type="text" style="padding: 0;margin: 0;border: none;" value=""
										 placeholder="请输入缺陷描述" onkeyup="setLength(this,300,'wordsLength');"></textarea>
										<span class="mui-icon mui-icon-closeempty delete-icon" onclick="deleteDate('problemContent')"></span>
										<span id="wordsLength" style="display: none;position:relative;left:87%; bottom:50px;font-size:12px; color:#BDCADA">0/300</span>
									</div>
								</div>

								<div class="info-bar-content-item" style="height: 150px;">
									<div class="item-title" style="width: calc(100vw - 40px);margin-bottom: 10px; display: flex;">

										<a href="#overall" class="show-tip-info">
											<img src="../../img/show_tip_info.png" style="width: 16px; height: 16px;" alt="">
										</a>
										整体图片
									</div>
									<input id="image_path" style="display: none;" />
									<div class="img_list"></div>
									<div id="photo" class="img_item">
										<img src="../../img/commom/pz@2x.png" style="" />
									</div>
								</div>
								<div class="info-bar-content-item" style="height: 140px;">
									<div class="item-title" style="width: calc(100vw - 40px);margin-bottom: 10px; display: flex;">

										<a href="#partial" class="show-tip-info">
											<img src="../../img/show_tip_info.png" style="width: 16px; height: 16px;" alt="">
										</a>
										局部图片
									</div>
									<input id="image_path2" style="display: none;" />
									<div class="img_list2"></div>
									<div id="photo2" class="img_item">
										<img src="../../img/commom/pz@2x.png" style="" />
									</div>
								</div>
								<div class="info-bar-content-item" style="height: 140px;">
									<div class="item-title" style="width: calc(100vw - 40px);margin-bottom: 10px; display: flex;">

										<a href="#crucial" class="show-tip-info">
											<img src="../../img/show_tip_info.png" style="width: 16px; height: 16px;" alt="">
										</a>
										关键部位
									</div>
									<input id="image_path3" style="display: none;" />
									<div class="img_list3"></div>
									<div id="photo3" class="img_item">
										<img src="../../img/commom/pz@2x.png" style="" />
									</div>
								</div>
                                <br>
								<div class="info-bar-content-item" style="height: 57px">
									<div class="item-title" style="float: left;width: 50%;font-size: 17px">
										发现人
									</div>
									<div class="mui-input-row item-input" >
										<input id="findBy_input" class="textAlignRight" readonly="readonly" type="text" value="" placeholder="请选择发现人">
									</div>
								</div>
                                <!--<br>-->
								<div class="info-bar-content-item" style="height: 57px">
									<div class="item-title" style="float: left;width: 50%;font-size: 17px">
										发现日期
									</div>
									<div class="mui-input-row item-input" >
										<input id="findTime" class="textAlignRight" readonly="readonly" type="text" placeholder="请选择发现日期">
										<div class="right-img-center">
											<img src="../../img/cal.png" style="width: 14px;height: 14px;" />
										</div>
									</div>

								</div>
                                <!--<br>-->
<!--								web没有负责人 ，隐藏-->
								<div class="info-bar-content-item"  style="height: 57px;display: none;">
									<div class="item-title" style="float: left;width: 50%;font-size: 17px">
										负责人<span style="color: red;">*</span>
									</div>
									<div class="mui-input-row item-input" style="float: right;width: 45%;height:70%;padding: 4.5px 0px 0px 0px;">
										<input id="handler_input" readonly="readonly" type="text" style="width: 90%;" value="" placeholder="请选择负责人">
									</div>
								</div>
<!--								隐藏处理 ，只在web端处理-->
								<div class="info-bar-content-item" style="display: none;">
									<div class="item-title" style="margin-bottom: 10px;">
										处理
									</div>
									<div class="mui-switch mui-switch-blue" id="mySwitch">
										<div class="mui-switch-handle"></div>
									</div>
								</div>
								<div id="isHandle" style="display: none;">
									<div class="bar-content-item" style="height: 200px;">
										<div class="item-title">
											处理措施<span style="color: red;"></span>
										</div>
										<div class="mui-input-row item-input">
											<textarea id="doneMeasures" maxlength="300" rows="5" type="text" style="" class="mui-input-clear " value=""
											 placeholder="请输入处理措施" onkeyup="setLength(this,300,'wordsLength3');"></textarea>
											<span class="mui-icon mui-icon-closeempty delete-icon" onclick="deleteDate('doneMeasures')"></span>
											<span id="wordsLength3" style="position:relative;left:87%; bottom:50px;font-size:12px; color:#BDCADA">0/300</span>
										</div>
									</div>

									<div class="info-bar-content-item" style="height: 140px;">
										<div class="item-title" id="allWord" style="margin-bottom: 10px;">
											整体图片<span style="color: red;"></span>
											<a href="#overall" style="display:inline-block;margin-left:10px;font-size: 12px;color: #337BFC;">说明</a>
										</div>
										<div class="img_list4"></div>
										<div id="photo4" class="img_item">
											<img src="../../img/commom/pz@2x.png" style="" />
										</div>
									</div>
									<div class="info-bar-content-item" style="height: 140px;">
										<div class="item-title" id="keyWord" style="margin-bottom: 10px;">
											关键部位<span style="color: red;"></span>
											<a href="#crucial" style="display:inline-block;margin-left:10px;font-size: 12px;color: #337BFC;">说明</a>
										</div>
										<div class="img_list5"></div>
										<div id="photo5" class="img_item">
											<img src="../../img/commom/pz@2x.png" style="" />
										</div>
									</div>
                                    <br>
									<div class="info-bar-content-item" style="height: 57px">
										<div class="item-title" style="float: left;width: 50%;font-size: 17px">
											状态<span style="color: red;">*</span>
										</div>
										<div class="mui-input-row item-input" style="float: right;width: 45%;height:70%;padding: 4.5px 0px 0px 0px;">
											<input id="bugStatus" style="display: none;" />
											<input id="status_input" required="true" readonly="readonly" type="text" style="width: 90%;" value="" placeholder="请选择状态">
										</div>
									</div>

									<div class="info-bar-content-item" style="height: 57px">
										<div class="item-title" style="float: left;width: 50%;font-size: 17px">
											处理人<span style="color: red;">*</span>
										</div>
										<div class="mui-input-row item-input" style="float: right;width: 45%;height:70%;padding: 4.5px 0px 0px 0px;">
											<input id="donePerson" required="true" readonly="readonly" type="text" style="width: 90%;" value=""
											 placeholder="请选择处理人">
										</div>
									</div>
									<div class="info-bar-content-item"  style="height: 57px;border:none">
										<div class="item-title" style="float: left;width: 50%;font-size: 17px">
											处理日期<span style="color: red;">*</span>
										</div>
										<div class="mui-input-row item-input" style="float: right;width: 45%;height:70%;padding: 4.5px 0px 0px 0px;">
											<div class="mui-row task-item">
												<div class="mui-col-xs-10 task-item-title">
													<input id="endTime" required="true" readonly="readonly" type="text" placeholder="请选择处理日期" style="width: 100%;">
												</div>
												<div class="mui-col-xs-2" style="line-height: 43px;text-align: right;">
													<img src="../../img/cal.png" style="width: 14px;height: 14px;" />
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>

						<div class="bottom-btn">
							<div class="btn-item">
								<div id="ok" style="background: #337BFC;color: #fff;">提交</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!--页面主内容区结束-->
		</div>

		<!--整体拍照说明-->
		<div id="overall" class="mui-popover" style="text-align: left;background: #FFFFFF;">
			<div class="mui-popover-arrow"></div>
			<div class="mui-scroll-wrapper">
				<span style="display:inline-block;padding: 2px 8px;">手机镜头拉远拍摄，能够看清存在缺陷的设施设备与周边环境的位置关系</span>
			</div>
		</div>

		<!--局部拍照说明-->
		<div id="partial" class="mui-popover" style="text-align: left;background: #FFFFFF;">
			<div class="mui-popover-arrow"></div>
			<div class="mui-scroll-wrapper">
				<span style="display:inline-block;padding: 2px 8px;">手机镜头拉近拍摄，能够看清缺陷在设施设备上的位置分布</span>
			</div>
		</div>

		<!--关键拍照说明-->
		<div id="crucial" class="mui-popover" style="text-align: left;background: #FFFFFF;">
			<div class="mui-popover-arrow"></div>
			<div class="mui-scroll-wrapper">
				<span style="display:inline-block;padding: 2px 8px;">手机正对着缺陷部位拍摄，能够看清具体的缺陷情况</span>
			</div>
		</div>
	</body>
	<script type="text/javascript" src="http://gd.wiseom.cn/supermap/mapbox-gl-enhance.js"></script>
	<script type="text/javascript" src="http://gd.wiseom.cn/supermap/iclient-mapboxgl.min.js"></script>
	<script src="http://gd.wiseom.cn/mobile-lib/mobile-lib.umd.js"></script>

	<script src="../../js/mui.min.js"></script>
	<script src="../../js/mui.view.js"></script>
	<script src="../../js/mui.locker.js"></script>
	<script src="../../js/mui.picker.js"></script>
	<script src="../../js/mui.picker.min.js"></script>
	<script src="../../js/mui.poppicker.js"></script>
	<script src="../../js/jquery.min.js"></script>

	<script src="../../js/common.js"></script>
	<script src="../../js/app.js"></script>
	<script src="../../js/config.js"></script>
	<script src="../../js/qx.js"></script>
	<script src="../../js/uploadimage.js"></script>
	<script src="../../js/paishuihu.js"></script>
	<script src="../../js/position.js"></script>
	<script src="../../js/helper.js"></script>
	<script src="../../js/s4.js"></script>
	<script src="../../js/smutils.js"></script>
	<script src="../../js/byte&string.js"></script>
	<script src="../../js/ajaxhook.min.js"></script>
	<script src="../../js/mui.zoom.js"></script>
	<script src="../../js/mui.previewimage.js"></script>
	<script>
		var isTest = false


		mui.init({
			beforeback: function() {
				//获得父页面的webview
				var list = plus.webview.currentWebview().opener();
				//触发父页面的自定义事件(refresh),从而进行刷新
				mui.fire(list, 'refresh');
				//返回true,继续页面关闭逻辑
				return true;
			}
		});
		//初始化单页view
		var viewApi = mui('#app').view({
			defaultPage: '#mui-content'
		});
		//初始化单页的区域滚动
		mui('.mui-scroll-wrapper').scroll();

		// 界面加载时就获取
		// 从小区巡检跳转到这里 ，缺陷来源默认选中不可选，小区选中不可选
		var addQxFrom = '' // 巡检xj ，抽查cc
		var bugSourceObjData = {};
		var sourceId = ""; //缺陷来源Id
		var commId = ""; //小区guid
		var commName = ""; //小区名
		var bugId = ""; //缺陷guid
		var bugType = ""; //缺陷类型id
		var levelId = ""; //缺陷等级id
		var findBy = ""; //发现人名字
		var belongId = ""; //负责单位
		var belongManager = ""; //负责人名字 - web端没有 ，隐藏
		var objTypeId = "" //设施类型id
		var objTypeName = "" //设施类型名
		var bugAllImageToken = '';
		var bugPartImageToken = '';
		var bugKeyImageToken = '';
		var solveImageToken = '';
		var solveAllImageToken = '';


		var deviceTypeObj = {}
		// 设施类型 deviceType 对应 deviceBugAssociated
		var deviceTypeDictTypeForBugAssociated = {}
		// 缺陷类型
		// code 对应 数据对象 ，这个code对应设施类型 的 deviceBugAssociated
		var bugTypeDictCodeForChildrenObj = {}

		// 所在片区数据
		var nearAreaObj = {}

		const mapData = window['mobile-lib'].MapData({
			serverUrl: config.urls.serverDomain,
			style: 'color'
		});

		var point2; //位置

		mui.plusReady(function() {
			//获取当前位置
			// getCurrentPosition();

			var date = new Date();
			$("#findTime").val(date.Format('yyyy-MM-dd'))
			//默认发现人
			$("#findBy_input").val(app.userInfo().realname);
			// console.log(JSON.stringify(app.userInfo()))

			var self = plus.webview.currentWebview();
			addQxFrom = self.addQxFrom

			if(addQxFrom == 'xj') {
				$("#bugSource").val('巡检');
				sourceId = 3;
				// 附近小区 - 请求完小区数据也设置
				 commId = self.taskId; //小区guid
				 commName = self.taskName; //小区名
				setupCommWithData(commId, commName, false)
			}else if(addQxFrom == 'cc') {
				$("#bugSource").val('抽查');
				sourceId = 6;
				// 附近小区 - 请求完小区数据也设置
				commId = self.taskId; //小区guid
				commName = self.taskName; //小区名
				setupCommWithData(commId, commName, false)
			}else{
				$("#bugSource").val('填报');
				sourceId = 4;
				//获取缺陷来源
				$("#bugSource").on("tap", function() {
					if(bugSourceObjData == null || bugSourceObjData.result == null || bugSourceObjData.result.length < 1) {
						getDictItems('ZHSW.DEVICE.BUG_SOURCE', function(data) {
							// console.log('getDictItems - ZHSW.DEVICE.BUG_SOURCE, function(data) start');
							// console.log(JSON.stringify(data))
							// console.log('getDictItems - ZHSW.DEVICE.BUG_SOURCE, function(data) end');
							showBugSourceAndPicker(data);
						})
					}else{
						showBugSourceAndPicker(bugSourceObjData);
					}
				});
				//获取附近小区
				$("#comm_input").on("tap", function() {
					var point;
					var param = {name:'',rownum:50};
					if(!nearAreaObj) {
						getNearArea()
					}
					if(!showNearAreaPage(nearAreaObj)) {
						return;
					}
					// getPsXq(param,function(data){
					// 	console.log('小区 -- start')
					// 	console.log(JSON.stringify(data));
					// 	console.log('小区 -- end')
					// 	if (200 != parseInt(data.code)) {
					// 		app.toast(data.message);
					// 		return;
					// 	}
					// 	var resultJSON =[];
					// 	for (var i = 0; i < data.result.length; i++) {
					// 		var item = data.result[i];
					// 		resultJSON.push({
					// 			text: item.reName,
					// 			value: item.guid
					// 		})
					// 	}
					// 	var extras = {
					// 		dataList: resultJSON,//内容
					// 		multiSelect:false
					// 	}
					// 	app.openPage("../commom/select.html", {
					// 		titleNView: {
					// 			titleText: '小区',
					// 			autoBackButton: true
					// 		}
					// 	}, extras);
					// })
					//移除
					window.removeEventListener('returnSelect', setComm, false);
					window.removeEventListener('returnSelect', setDiscover, false);
					window.removeEventListener('returnSelect', setHandler, false);
					// 赋值
					window.addEventListener('returnSelect', setComm, false);

				});
			}
			// 提交获取附近小区数据
			getNearArea()
			// 获取缺陷来源数据
			getBugSourceDataOnly();

			const mapData = window['mobile-lib'].MapData({
				serverUrl: config.urls.serverDomain,
				style: 'color'
			});

			//*获取缺陷类型
			$("#bugType_input").on("tap", function() {
				var param = objTypeId;
				// if(param == ""||param ==null){
				//                 app.toast("请先选择设施");
				//     return;
				// }
				var needRelaod = true
				if(deviceTypeDictTypeForBugAssociated && deviceTypeDictTypeForBugAssociated[objTypeId]) {
					var bugAssociated = deviceTypeDictTypeForBugAssociated[objTypeId]
					if(bugAssociated) {
						if(bugTypeDictCodeForChildrenObj && bugTypeDictCodeForChildrenObj[bugAssociated]) {
							needRelaod = false
							showBugTypeSelect(bugTypeDictCodeForChildrenObj[bugAssociated])
						}
					}
				}
				if(needRelaod) {
					getQx_Type(param, function(data) {
						console.log('缺陷类型返回 start')
						console.log(JSON.stringify(data))
						console.log('缺陷类型返回 end')
						if (200 != parseInt(data.code)) {
							app.toast(data.message);
							return;
						}
						if(data && data.result && data.result.length) {
							for(var i = 0; i < data.result.length; i++) {
								var item = data.result[i];
								bugTypeDictCodeForChildrenObj[item.code] = item.children
							}
							if(deviceTypeDictTypeForBugAssociated && deviceTypeDictTypeForBugAssociated[objTypeId]) {
								var bugAssociated = deviceTypeDictTypeForBugAssociated[objTypeId]
								if(bugAssociated) {
									if(bugTypeDictCodeForChildrenObj && bugTypeDictCodeForChildrenObj[bugAssociated]) {
										showBugTypeSelect(bugTypeDictCodeForChildrenObj[bugAssociated])
									}
								}
							}
						}

					})
				}


			});

			//*获取缺陷等级
			$("#bugLevel_input").on("tap", function() {
				var objType = $("#obj_input").val()
				var reg1 = new RegExp("管渠")
				var reg2 = new RegExp("灌渠")
				if (!reg1.test(objType) && !reg2.test(objType)) {
					app.toast("管渠类或者灌渠类设施才能选择等级")
					return;
				}

				getDictItems('ZHSW.DEVICE.BUG_LEVEL', function(data) {
					if (206 != parseInt(data.code)) {
						app.toast(data.message);
						return;
					}
					var resultJSON = [];
					resultJSON.push({
						text: '无',
						value: '-1'
					})
					for (var i = 0; i < data.result.length; i++) {
						var item = data.result[i];
						resultJSON.push({
							text: item.text,
							value: item.value
						})
					}
					var userPicker = new mui.PopPicker();
					if ($(".mui-poppicker").hasClass("mui-active")) {
						userPicker.hide();
						return false;
					}
					userPicker.setData(resultJSON);
					userPicker.show(function(items) {
						if(items[0].value==-1){
							$("#bugLevel_input").val('');
							levelId = '';
							// $("#bugLevel_input").next().css('display', 'none');
						}else{
							$("#bugLevel_input").val(items[0].text);
							levelId = items[0].value;
							// $("#bugLevel_input").next().css('display', 'inline-block');
						}
						//返回 false 可以阻止选择框的关闭
						//return false;
					});

				})
			});

			//是否处理
			document.getElementById("mySwitch").addEventListener("toggle", function(event) {
				if (event.detail.isActive) {
					$("#isHandle").fadeIn()
				} else {
					$("#isHandle").hide()
					mui('#scroll').scroll().reLayout();
					mui('#scroll').scroll().scrollToBottom(-100);
				}
			})
		});

		// 显示缺陷类型的数据 ，是children数组
		function showBugTypeSelect(data) {
			var resultJSON = [];
			resultJSON.push({
				text: '无',
				value: '-1'
			})

			if(data && data.length > 0) {
				for (var i = 0; i < data.length; i++) {
					// {"code":"jgyc","children":null,"icon":null,"title":"井盖异常","leaf":true,"value":"e6918e76c216a794c039f1330d63d095","key":"e6918e76c216a794c039f1330d63d095","parentId":"b373586881ae6fe3c50251cb2c9db395"},
					var item = data[i];

					resultJSON.push({
						text: item.title,
						value: item.value
					})
				}
			}
			// for (var i = 0; i < data.result.length; i++) {
			// 	// {"code":"jgyc","children":null,"icon":null,"title":"井盖异常","leaf":true,"value":"e6918e76c216a794c039f1330d63d095","key":"e6918e76c216a794c039f1330d63d095","parentId":"b373586881ae6fe3c50251cb2c9db395"},
			// 	var item = data.result[i];
			//
			// 	resultJSON.push({
			// 		text: item.problemType_dictText,
			// 		value: item.problemType
			// 	})
			// }

			var userPicker = new mui.PopPicker();
			if ($(".mui-poppicker").hasClass("mui-active")) {
				userPicker.hide();
				return false;
			}

			userPicker.setData(resultJSON);
			userPicker.show(function(items) {
				if(items[0].value==-1){
					$("#bugType_input").val('');
					bugType = '';
				}else{
					$("#bugType_input").val(items[0].text);
					bugType = items[0].value;
				}
				//返回 false 可以阻止选择框的关闭
				//return false;
			});
		}

		function showNearAreaPage(data) {

			if (200 != parseInt(data.code)) {
				app.toast(data.message);
				return false;
			}
			var resultJSON =[];
			for (var i = 0; i < data.result.length; i++) {
				var item = data.result[i];
				resultJSON.push({
					text: item.reName,
					value: item.guid
				})
			}
			var extras = {
				dataList: resultJSON,//内容
				multiSelect:false
			}
			app.openPage("../commom/select.html", {
				titleNView: {
					titleText: '小区',
					autoBackButton: true
				}
			}, extras);
			return true
		}

		// 首次需要获取所在片区
		function getNearArea() {
			var param = {name:'',rownum:50}
			getPsXq(param,function(data){
				// console.log('小区 -- start')
				// console.log(JSON.stringify(data));
				// console.log('小区 -- end')
				nearAreaObj = data
				console.log('commId :' + commId + ',commName:' + commName)
				if(!commId || !commName) {
					return;
				}


				if (200 != parseInt(data.code)) {
					app.toast(data.message);
					return;
				}
				// var resultJSON =[];
				for (var i = 0; i < data.result.length; i++) {
					var item = data.result[i];
					if(item.reName == commName) {

						// 附近小区
						commId = item.guid; //小区guid
						//commName = item.reName; //小区名
						console.log('item.reName == self.taskName')
						console.log('commId:' + commId + ',commName:' + commName)
						setupCommWithData(commId, commName, false)
						return;
					}
					// resultJSON.push({
					// 	text: item.reName,
					// 	value: item.guid
					// })
				}
				// var extras = {
				// 	dataList: resultJSON,//内容
				// 	multiSelect:false
				// }
				// app.openPage("../commom/select.html", {
				// 	titleNView: {
				// 		titleText: '小区',
				// 		autoBackButton: true
				// 	}
				// }, extras);
			})

		}


		// 首次需要获取缺陷来源
		function getBugSourceDataOnly() {
			getDictItems('ZHSW.DEVICE.BUG_SOURCE', function(data) {
				// console.log('getDictItems - ZHSW.DEVICE.BUG_SOURCE, function(data) start');
				// console.log(JSON.stringify(data))
				// console.log('getDictItems - ZHSW.DEVICE.BUG_SOURCE, function(data) end');
				//showBugSourceAndPicker(data);
				bugSourceObjData = data;
				if(addQxFrom == 'xj') {
					if(data.result) {
						for (var i = 0; i < data.result.length; i++) {
							var item = data.result[i];
							if(item.text == '巡检') {
								$("#bugSource").val('巡检');
								sourceId = item.value;
								return;
							}
						}
					}

				}else if(addQxFrom == 'cc') {
					if(data.result) {
						for (var i = 0; i < data.result.length; i++) {
							var item = data.result[i];
							if(item.text == '抽检') {
								$("#bugSource").val('抽检');
								sourceId = item.value;
								return;
							}
						}
					}

				}

			})
		}
		function showBugSourceAndPicker(data) {
			if (206 != parseInt(data.code)) {
				app.toast(data.message);
				return;
			}
			var resultJSON = [];
			for (var i = 0; i < data.result.length; i++) {
				var item = data.result[i];
				resultJSON.push({
					text: item.text,
					value: item.value
				})
			}

			var userPicker = new mui.PopPicker();
			if ($(".mui-poppicker").hasClass("mui-active")) {
				userPicker.hide();
				return false;
			}
			userPicker.setData(resultJSON);
			userPicker.show(function(items) {
				$("#bugSource").val(items[0].text);
				sourceId = items[0].value;
				//返回 false 可以阻止选择框的关闭
				//return false;
			});
		}
		//自定义的回调函数
		var setComm = function(data) {
			// $("#comm_input").val(data.detail[0].text);
			// commId = data.detail[0].value; //小区guid
			// commName = data.detail[0].text;
			// $("#comm_input").next().css('display', 'inline-block');
			console.log('guid:' + data.detail[0].value)
			console.log('name:'+ data.detail[0].text)
			setupCommWithData(data.detail[0].value, data.detail[0].text, true)
		}

		function setupCommWithData(pCommId, pCommName, canDelete)
		{
			$("#comm_input").val(pCommName);
			commId = pCommId; //小区guid
			commName = pCommName;
			if(canDelete) {
				$("#comm_input").next().css('display', 'inline-block');
			}else{
				$("#comm_input").next().css('display', 'none');
			}
		}

		var getCurrentPosition = function() {
			if (mui.os.plus) {
				app.showLoader();
			}
			//获取当前坐标
			plus.geolocation.getCurrentPosition(function(position) {
				app.hideLoader();
				//坐标修正
				point2 = coordtransform.gcj02towgs84(position.coords.longitude, position.coords.latitude);

				var Lon = point2[0]; //获取经度
				var Lat = point2[1]; //获取纬度
				// Lon = 114.05326971436261;
				// Lat = 22.51186935424799;

				// setTimeout(function(){
				//     mobileContainer.flyTo([Lon, Lat], {
				//         zoom: 18
				//     });
				//     mobileContainer.markAddress(Lon,Lat);
				// },2000);
			}, function(e) {
				mui.toast("获取定位失败，请查看设备是否开启定位");
			})
		}

		//时间选择
		$("#findTime").on("tap", function() {
			var that = $(this);
			// plus.nativeUI.pickDate(function(e) {
			//     var d = e.date;
			//     that.val(d.getFullYear()+"-"+preZero((d.getMonth()+1),2)+"-"+preZero(d.getDate(),2))
			// }, function(e) {
			//     that.val("");
			// }, {
			//     title: "请选择日期"
			// });
			plusDate(function(data) {
				that.val(data)
			},1);
		})

		//发现人
		$("#findBy_input").on("tap", function() {
			var extras = {
				multiSelect: false
			}
			app.openPage("../commom/organ.html", {
				titleNView: {
					titleText: '选择发现人',
					autoBackButton: true
				}
			}, extras);
			//移除
			window.removeEventListener('returnSelect', setComm, false);
			window.removeEventListener('returnSelect', setDiscover, false);
			window.removeEventListener('returnSelect', setHandler, false);
			// 赋值
			window.addEventListener('returnSelect', setDiscover, false);

		})

		//自定义的回调函数
		var setDiscover = function(data) {
			$("#findBy_input").val(data.detail[0].realname); //名称
			// $("#findBy_input").val(data.detail[0].username);//账号
			// $("#approverUsername").val(data.detail[0].value);
			findBy = data.detail[0].realname;
		}

		//获取负责人
		$("#handler_input").on("tap", function() {
			var extras = {
				multiSelect: false
			}
			app.openPage("../commom/organ.html", {
				titleNView: {
					titleText: '选择负责人',
					autoBackButton: true
				}
			}, extras);
			//移除
			window.removeEventListener('returnSelect', setComm, false);
			window.removeEventListener('returnSelect', setDiscover, false);
			window.removeEventListener('returnSelect', setHandler, false);
			// 赋值
			window.addEventListener('returnSelect', setHandler, false);

		})
		var setHandler = function(data) {
			$("#handler_input").val(data.detail[0].realname); //名称
			belongManager = data.detail[0].realname;
		}

		//获取设施类型√
		var newObj;
		var oldBoj = $("#obj_input").val();
		$("#obj_input").on("tap", function() {

			console.log('deviceTypeObj:' + JSON.stringify(deviceTypeObj))
			if(deviceTypeObj && deviceTypeObj.result) {
				console.log('1')
				showDeviceTypeData(deviceTypeObj)
			}else{
				console.log('2')
				var params = {
					deviceTypeId: 1
				}
				getQxDeviceType(params, function(retData){
					deviceTypeObj = retData
					showDeviceTypeData(retData)
				})
			}

			// ==
		});
		function showDeviceTypeData(data) {

			//getDictItems("ZHSW.DEVICE.BUG_OBJECT_TYPE", function(data) {
			//getQxDeviceType(params, function(retData){

			var retData = data;
				var resultJSON = [];
				resultJSON.push({
					text: '无',
					value: '-1'
				})
				// for (var i = 0; i < data.result.length; i++) {
				// 	var item = data.result[i];
				// 	resultJSON.push({
				// 		text: item.text,
				// 		value: item.value
				// 	})
				// }
				if(retData.result && retData.result.records) {
					let data = retData.result.records
					for (var i = 0; i < data.length; i++) {
						var item = data[i];
						// 缺陷类型使用 deviceBugAssociated
						deviceTypeDictTypeForBugAssociated[item.deviceType] = item.deviceBugAssociated
						//deviceTypeDictIdForName[item.deviceType] = item.deviceTypeName
						resultJSON.push({
							text: item.deviceTypeName,
							value: item.deviceType
						})
					}
				}
				var userPicker = new mui.PopPicker();
				if ($(".mui-poppicker").hasClass("mui-active")) {
					userPicker.hide();
					return false;
				}
				userPicker.setData(resultJSON);
				userPicker.show(function(items) {
					if(items[0].value==-1){
						$("#obj_input").val('');
						newObj = '';
						objTypeId = '';
						objTypeName = '';
					}else{
						$("#obj_input").val(items[0].text);
						newObj = items[0].text;
						objTypeId = items[0].value;
						objTypeName = items[0].text;
					}

					if (oldBoj != newObj) {
						//设施类型变，缺陷类型清除
						$("#bugType_input").val("");
						$("#bugLevel_input").val("");
						$("#bugLevel_input").next().css('display', 'none');
						$("#obj").val("");
						$("#obj").next().css('display', 'none');
						// $("#locationContent").val("");
						// $("#locationContent").next().css('display', 'none');
						// setLength({value: ''},300,'wordsLength2');
						bugType = '';
						levelId = '';
					}
					//返回 false 可以阻止选择框的关闭
					//return false;
				});
		//	})
		}

		$("#locationContent").on("tap", function() {
			selectLocation();
		});

		//获取对象（获取objectDesc，objectId，过滤条件objTypeId & commId）
		$("#location").on("tap", function() {
			// 跳转
			// mui.openWindow({
			// 	url: 'qx_object_select.html',
			// 	id: 'qx_object_select.html',
			// 	show: {
			// 		aniShow: 'pop-in'
			// 	},
			//    extras:{
			//        OTId : objTypeId,   //设施类型Id
			// 		OTName : objTypeName     //设施类型名
			//    },
			// });
			selectLocation();

		});

		function selectLocation() {
			if (objTypeId == "" || objTypeId == null) {
				objTypeId = 1
				// app.toast("请先选择设施类型")
				// return;
			}
			var pointCode = getPointCode(objTypeId);
			var extras = {
				OTId: objTypeId, //设施类型Id
				OTName: objTypeName, //设施类型名
				pointCode: pointCode,
				commId: commId,
				xq:$("#comm_input").val()
			}
			console.log(JSON.stringify(extras))
			app.openPage("qx_object_select.html", {
				titleNView: {
					titleText: '设施选择',
					autoBackButton: true
				}
			}, extras);

		}
		//监听自定义事件，用于和B.html页面进行通信
		var objId; //对象id
		var objName; //对象名
		//获取设施编号
		window.addEventListener("getObject", function(e) {
			// document.getElementById("obj").value=e.detail.val.name;
			$("#obj").val(e.detail.val.id);

			$("#locationContent").val(e.detail.val.name);
			setLength({
				value: e.detail.val.name
			}, 300, 'wordsLength2');
			if (e.detail.val.name.length > 0) $("#locationContent").next().css('display', 'inline-block');
			else $("#locationContent").next().css('display', 'none');
			// objId = e.detail.val.id;
			objId = e.detail.val.id;
			objName = e.detail.val.name;
			$("#obj").next().css('display', 'inline-block');

			getDictItems("ZHSW.DEVICE.BUG_OBJECT_TYPE", function(data) {
				if (206 != parseInt(data.code)) {
					app.toast(data.message);
					return;
				}

				for (var i = 0; i < data.result.length; i++) {
					var item = data.result[i];
					if (item.text == e.detail.val.deviceName) {
						$("#obj_input").val(item.text);
						newObj = item.text;
						objTypeId = item.value;
						objTypeName = item.text;
					}
				}
			})
		});

		document.getElementById("locationContent").addEventListener('input', function() {
			let localVal = $('#locationContent').val();
			if (localVal == '' || localVal == null || localVal == undefined) {
				$("#locationContent").next().css('display', 'none');
			} else {
				$("#locationContent").next().css('display', 'inline-block');
			}
		});

		document.getElementById("problemContent").addEventListener('input', function() {
			let proVal = $('#problemContent').val();
			if (proVal == '' || proVal == null || proVal == undefined) {
				$("#problemContent").next().css('display', 'none');
			} else {
				$("#problemContent").next().css('display', 'inline-block');
			}
		});

		document.getElementById("doneMeasures").addEventListener('input', function() {
			let proVal = $('#doneMeasures').val();
			if (proVal == '' || proVal == null || proVal == undefined) {
				$("#doneMeasures").next().css('display', 'none');
			} else {
				$("#doneMeasures").next().css('display', 'inline-block');
			}
		});

		//整体图片上传
		$("#photo").on("tap", function() {
			plusSelectImage(function(data, path) {
				if (!data.result) {
					app.toast(data.message);
					return;
				}
				// bugAllImageToken = data.result.fileTokens;
				// bugAllImagePath = data.result.uploadFile.savePath; //保存路径
				var html = '<div id="img1" data-token="' + data.result.fileTokens +
					'" class="img_item" filePath="' + data.result.uploadFile.savePath + '">' +
					'		<img class="imgCss" data-preview-src="" data-preview-group="img1" src="' + path + '" style=""  />' +
					'		<span class="img_close1 mui-icon mui-icon-closeempty" style="width: 16px;height: 16px;position:relative;top:-88px;left:64px;font-size: 16px;color: #888888;background: #E7E7E7;border-radius: 50%;"></span>' +
					'	</div>';
				$(".img_list").append(html);
				var count = $(".img_list").children(".img_item").length;
				var h = 160 + (Math.ceil((count + 1) / 3) - 1) * 110;

				$(".img_list").parent().css("height", h + 'px')
				// if (count == 1) $("#photo").hide();
			});
		});

		$(document).on("tap", ".img_close1", function() {
			var that = $(this)
			mui.confirm("移除图片?", "提示", ['确定', '取消'], function(result) {
				if (parseInt(result.index) == 0) {
					var count = $(".img_list").children(".img_item").length;
					var h = 160 + (Math.ceil(count / 3) - 1) * 110;

					$(".img_list").parent().css("height", h + 'px')
					that.parent().remove();
					// bugAllImageToken = '';
					// bugAllImagePath = '';
					// $("#photo").show();
				}
			})
		});

		//局部图片上传
		$("#photo2").on("tap", function() {
			plusSelectImage(function(data, path) {
				if (!data.result) {
					app.toast(data.message);
					return;
				}
				// bugPartImageToken = data.result.fileTokens;
				// bugPartImagePath = data.result.uploadFile.savePath; //保存路径
				var html = '<div id="img2" data-token="' + data.result.fileTokens +
					'" class="img_item" filePath="' + data.result.uploadFile.savePath + '">' +
					'		<img class="imgCss" data-preview-src="" data-preview-group="img2" src="' + path + '" style=""  />' +
					'		<span class="img_close2 mui-icon mui-icon-closeempty" style="width: 16px;height: 16px;position:relative;top:-88px;left:64px;font-size: 16px;color: #888888;background: #E7E7E7;border-radius: 50%;"></span>' +
					'	</div>';
				$(".img_list2").append(html);
				var count = $(".img_list2").children(".img_item").length;
				var h = 150 + (Math.ceil((count + 1) / 3) - 1) * 110;

				$(".img_list2").parent().css("height", h + 'px')
				// if (count == 1) $("#photo2").hide();
			});
		});

		$(document).on("tap", ".img_close2", function() {
			var that = $(this)
			mui.confirm("移除图片?", "提示", ['确定', '取消'], function(result) {
				if (parseInt(result.index) == 0) {
					var count = $(".img_list2").children(".img_item").length;
					var h = 150 + (Math.ceil(count / 3) - 1) * 110;

					$(".img_list2").parent().css("height", h + 'px')
					that.parent().remove();
					// bugPartImageToken = '';
					// bugPartImagePath = '';
					// $("#photo2").show();
				}
			})
		});

		//关键图片上传
		$("#photo3").on("tap", function() {
			plusSelectImage(function(data, path) {
				if (!data.result) {
					app.toast(data.message);
					return;
				}
				// bugKeyImageToken = data.result.fileTokens;
				// bugKeyImagePath = data.result.uploadFile.savePath; //保存路径
				var html = '<div id="img3" data-token="' + data.result.fileTokens +
					'" class="img_item" filePath="' + data.result.uploadFile.savePath + '">' +
					'		<img class="imgCss" data-preview-src="" data-preview-group="img3" src="' + path + '" style=""  />' +
					'		<span class="img_close3 mui-icon mui-icon-closeempty" style="width: 16px;height: 16px;position:relative;top:-88px;left:64px;font-size: 16px;color: #888888;background: #E7E7E7;border-radius: 50%;"></span>' +
					'	</div>';
				$(".img_list3").append(html);
				var count = $(".img_list3").children(".img_item").length;
				var h = 150 + (Math.ceil((count + 1) / 3) - 1) * 110;

				$(".img_list3").parent().css("height", h + 'px')
				// if (count == 1) $("#photo3").hide();
			});
		});

		$(document).on("tap", ".img_close3", function() {
			var that = $(this)
			mui.confirm("移除图片?", "提示", ['确定', '取消'], function(result) {
				if (parseInt(result.index) == 0) {
					var count = $(".img_list3").children(".img_item").length;
					var h = 150 + (Math.ceil(count / 3) - 1) * 110;

					$(".img_list3").parent().css("height", h + 'px')
					that.parent().remove();
					// bugKeyImageToken = '';
					// bugKeyImagePath = '';
					// $("#photo3").show();
				}
			})
		});


		//处理-整体图片上传
		$("#photo4").on("tap", function() {
			plusSelectImage(function(data, path) {
				if (!data.result) {
					app.toast(data.message);
					return;
				}
				// solveAllImageToken = data.result.fileTokens;
				// solveAllImagePath = data.result.uploadFile.savePath; //保存路径
				var html = '<div id="img4" data-token="' + data.result.fileTokens +
					'" class="img_item" filePath="' + data.result.uploadFile.savePath + '">' +
					'		<img class="imgCss" data-preview-src="" data-preview-group="img4" src="' + path + '" style=""  />' +
					'		<span class="img_close4 mui-icon mui-icon-closeempty" style="width: 16px;height: 16px;position:relative;top:-88px;left:64px;font-size: 16px;color: #888888;background: #E7E7E7;border-radius: 50%;"></span>' +
					'	</div>';
				$(".img_list4").append(html);

				var count = $(".img_list4").children(".img_item").length;
				var h = 150 + (Math.ceil((count + 1) / 3) - 1) * 110;

				$(".img_list4").parent().css("height", h + 'px')
				// if (count == 1) $("#photo4").hide();
			});
		});

		$(document).on("tap", ".img_close4", function() {
			var that = $(this)
			mui.confirm("移除图片?", "提示", ['确定', '取消'], function(result) {
				if (parseInt(result.index) == 0) {
					var count = $(".img_list4").children(".img_item").length;
					var h = 150 + (Math.ceil(count / 3) - 1) * 110;

					$(".img_list4").parent().css("height", h + 'px')
					that.parent().remove();
					// solveAllImageToken = '';
					// solveAllImagePath = '';
					// $("#photo4").show();
				}
			})
		});

		//处理-关键图片上传
		$("#photo5").on("tap", function() {
			plusSelectImage(function(data, path) {
				if (!data.result) {
					app.toast(data.message);
					return;
				}
				// solveImageToken = data.result.fileTokens;
				// solveImagePath = data.result.uploadFile.savePath; //保存路径
				var html = '<div id="img5" data-token="' + data.result.fileTokens +
					'" class="img_item" filePath="' + data.result.uploadFile.savePath + '">' +
					'		<img class="imgCss" data-preview-src="" data-preview-group="img5" src="' + path + '" style=""  />' +
					'		<span class="img_close5 mui-icon mui-icon-closeempty" style="width: 16px;height: 16px;position:relative;top:-88px;left:64px;font-size: 16px;color: #888888;background: #E7E7E7;border-radius: 50%;"></span>' +
					'	</div>';
				$(".img_list5").append(html);
				var count = $(".img_list5").children(".img_item").length;
				var h = 150 + (Math.ceil((count + 1) / 3) - 1) * 110;

				$(".img_list5").parent().css("height", h + 'px')
				// if (count == 1) $("#photo5").hide();
			});
		});

		$(document).on("tap", ".img_close5", function() {
			var that = $(this)
			mui.confirm("移除图片?", "提示", ['确定', '取消'], function(result) {
				if (parseInt(result.index) == 0) {
					var count = $(".img_list5").children(".img_item").length;
					var h = 150 + (Math.ceil(count / 3) - 1) * 110;

					$(".img_list5").parent().css("height", h + 'px')
					that.parent().remove();
					// solveImageToken = '';
					// solveImagePath = '';
					// $("#photo5").show();
				}
			})
		});


		//获取状态
		$("#status_input").on("tap", function() {
			getDictItems('ZHSW.DEVICE.BUG_STATE', function(data) {
				if (206 != parseInt(data.code)) {
					app.toast(data.message);
					return;
				}
				var resultJSON = [];
				for (var i = 0; i < data.result.length; i++) {
					var item = data.result[i];
					resultJSON.push({
						text: item.text,
						value: item.value
					})
				}
				var userPicker = new mui.PopPicker();
				if ($(".mui-poppicker").hasClass("mui-active")) {
					userPicker.hide();
					return false;
				}
				userPicker.setData(resultJSON);
				userPicker.show(function(items) {
					$("#status_input").val(items[0].text);
					$("#bugStatus").val(items[0].value);

					//返回 false 可以阻止选择框的关闭
					//return false;
				});

			})
		});

		//处理人
		$("#donePerson").on("tap", function() {
			var extras = {
				multiSelect: false
			}
			app.openPage("../commom/organ.html", {
				titleNView: {
					titleText: '选择处理人',
					autoBackButton: true
				}
			}, extras);
			//移除
			window.removeEventListener('returnSelect', setDonePerson, false);
			// 赋值
			window.addEventListener('returnSelect', setDonePerson, false);

		})

		//自定义的回调函数
		var setDonePerson = function(data) {
			$("#donePerson").val(data.detail[0].realname); //名称
		}

		//处理时间选择（保留）
		$("#endTime").on("tap", function() {
			var that = $(this);

			plusDate(function(data) {
				that.val(data)
			});
		})
		//字数限制
		function setLength(obj, maxlength, id) {
			var num = obj.value.length;
			var leng = id;
			if (num < 0) {
				num = 0;
			}
			document.getElementById(leng).innerHTML = num + "/300";
		}

		//生成groupid
		function groupid() {
			return 'xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
				var r = Math.random() * 16 | 0,
					v = c == 'x' ? r : (r & 0x3 | 0x8);
				return v.toString(16);
			});
		}

		//点击确定
		$("#ok").on("tap", function() {

			// 必填项检测
			//必填项集合
			var paramList1 = "#comm_input"  + "," + "#bugType_input";
			//必填空判断
			if (judgeParam(paramList1)) {
				app.toast('必填项不能为空')
				return;
			}
			// ===
			$("#problemContent").val().replace(/\s/gi, ''); //去空格
			// var bugSource = $("#bugSource"); //*缺陷来源 下拉
			// var bugTitle = $("#bugTitle"); //*缺陷名称
			var problemContent = $("#problemContent"); //缺陷描述
			var locationContent = $("#locationContent") //地点
			var objNo = $("#obj"); //设施编号

			var finder = $("#findBy_input"); //发现人
			var findTime = $("#findTime"); //*发现日期
			//var handler = $("#handler_input"); //*负责人(noName) - 负责人web端没有 ，隐藏

			//必填项集合
			//var paramList = "#problemContent" + "," + "#findBy_input" + "," + "#findTime" + "," + "#handler_input";
			var paramList = "#problemContent" + "," + "#findBy_input" + "," + "#findTime";
			//必填空判断
			if (judgeParam(paramList)) {
				return;
			}

	
			var bugAllImage = groupid(); //缺陷-全局图片
			var bugPartImage = groupid(); //缺陷-局部图片
			var bugKeyImage = groupid(); //缺陷-关键图片
			var solveImage = groupid(); //处理-图片
			var solveAllImage = groupid(); //处理-全局图片
			
			var imagefileTokens1 = ''; //图片token
			var imagefileTokens2 = '';
			var imagefileTokens3 = '';
			var imagefileTokens4 = '';
			var imagefileTokens5 = '';
			
			var imagefilePaths1 = ''; //图片path
			var imagefilePaths2 = '';
			var imagefilePaths3 = '';
			var imagefilePaths4 = '';
			var imagefilePaths5 = '';
			$("div[data-token]").each(function(index) {
				var imgID = $(this).attr("id");
				var path = $(this).attr("filePath");
				var token = $(this).attr("data-token");
				if (imgID == "img1") {
					if (imagefileTokens1 == '') {
						imagefileTokens1 = token;
						imagefilePaths1 = path;
					} else {
						imagefileTokens1 = imagefileTokens1 + "," + token;
						imagefilePaths1 = imagefilePaths1 + "," + path;
					}
				} else if (imgID == "img2") {
					if (imagefileTokens2 == '') {
						imagefileTokens2 = token;
						imagefilePaths2 = path;
					} else {
						imagefileTokens2 = imagefileTokens2 + "," + token;
						imagefilePaths2 = imagefilePaths2 + "," + path;
					}
			
				} else if (imgID == "img3") {
					if (imagefileTokens3 == '') {
						imagefileTokens3 = token;
						imagefilePaths3 = path;
					} else {
						imagefileTokens3 = imagefileTokens3 + "," + token;
						imagefilePaths3 = imagefilePaths3 + "," + path;
					}
				} else if (imgID == "img4") {
					if (imagefileTokens4 == '') {
						imagefileTokens4 = token;
						imagefilePaths4 = path;
					} else {
						imagefileTokens4 = imagefileTokens4 + "," + token;
						imagefilePaths4 = imagefilePaths4 + "," + path;
					}
				} else if (imgID == "img5") {
					if (imagefileTokens5 == '') {
						imagefileTokens5 = token;
						imagefilePaths5 = path;
					} else {
						imagefileTokens5 = imagefileTokens5 + "," + token;
						imagefilePaths5 = imagefilePaths5 + "," + path;
					}
				}
			});
			// console.log("imagefileTokens1:" + imagefileTokens1 + ",imagefileTokens2:" + imagefileTokens2 + ",imagefileTokens3:" +
			// 	imagefileTokens3 + ",imagefileTokens4:" + imagefileTokens4 + ",imagefileTokens5:" + imagefileTokens5);
			
			// console.log("imagefilePaths1:" + imagefilePaths1 + ",imagefilePaths2:" + imagefilePaths2 + ",imagefilePaths3:" +
			// 	imagefilePaths3 + ",imagefilePaths4:" + imagefilePaths4 + ",imagefilePaths5:" + imagefilePaths5);	
						
			var arrAttachment = [{
					"groupId": bugAllImage,
					"fileTokens": imagefileTokens1,
					"fieldName": "bugAllImage",
					"tableName": "attachment"
				},
				{
					"groupId": bugPartImage,
					"fileTokens": imagefileTokens2,
					"fieldName": "bugPartImage",
					"tableName": "attachment"
				},
				{
					"groupId": bugKeyImage,
					"fileTokens": imagefileTokens3,
					"fieldName": "bugKeyImage",
					"tableName": "attachment"
				},
				{
					"groupId": solveImage,
					"fileTokens": '',
					"fieldName": "solveImage",
					"tableName": "attachment"
				},
				{
					"groupId": solveAllImage,
					"fileTokens": '',
					"fieldName": "solveAllImage",
					"tableName": "attachment"
				}
			];
			var param = {
				bugSource: sourceId, //缺陷来源*
				// bugTitle: bugTitle.val(), //缺陷名称
				objectType: objTypeId, //设施类型
				// objectDesc:objName,      //对象
				objectId: objNo.val(), //设施编号
				commId: commId, //小区
				commName: commName, //小区名
				bugId: bugId, //缺陷
				bugType: bugType, //缺陷类型Id
				bugLevel: levelId, //缺陷等级Id*
				problemContent: problemContent.val(), //缺陷描述*
				locationContent: locationContent.val(), //地点
				bugAllImage: bugAllImage, //整体图片*
				bugAllImagePath: imagefilePaths1,
				bugKeyImage: bugKeyImage, //关键部位*
				bugKeyImagePath: imagefilePaths3,
				bugPartImage: bugPartImage, //局部图片*
				bugPartImagePath: imagefilePaths2,
				solveImage: solveImage,
				solveImagePath: '',
				solveAllImage: solveAllImage,
				solveImagePath: '',
				strAttachment: JSON.stringify(arrAttachment),

				findBy: finder.val(), //发现人
				findTime: findTime.val(), //发现日期
				// belongManager: handler.val(), // 负责人 - web端没有 ，隐藏
			};
			var isActive = document.getElementById("mySwitch").classList.contains("mui-active");
			if(isActive){
			  if(validateRequiredFields()){
				  param.doneMeasures = $("#doneMeasures").val()
				  param.bugStatus = $("#bugStatus").val();
				  param.donePerson = $("#donePerson").val()
				  param.endTime = $("#endTime").val()
				  arrAttachment[3].fileTokens = imagefileTokens5;
				  arrAttachment[4].fileTokens = imagefileTokens4;
				  param.solveImagePath = imagefilePaths5;
				  param.solveAllImagePath = imagefilePaths4;
				  param.strAttachment= JSON.stringify(arrAttachment)
			  }else return
			}
			console.log(JSON.stringify(param));
			qxAdd(param, function(data) {
				if (data.success) {
					app.toast("新增成功")

					if(addQxFrom == 'xj' || addQxFrom == 'cc') {
						//获取当前页
						var selfPage = plus.webview.currentWebview();
						//获取父页面
						var openerPage = selfPage.opener();
						//自定义事件,事件名为changeCity
						mui.fire(openerPage,'addQxSuccess');

						//关闭页面
						mui.back();
					}
					//返回上一页
					mui.back()


				} else {
					app.toast("新增失败")
				}

			});

		});
		$("body").delegate("img[class=imgCss]","tap", function(e) {		
			mui.previewImage();
		});

		// 测试区
		// 缺陷来源
		function testGetSource() {
			var dataStr = `
			{"success":true,"message":"操作成功!","result":[{"text":"检测","title":"检测","value":"1"},{"text":"巡检","title":"巡检","value":"3"},{"text":"填报","title":"填报","value":"4"},{"text":"抽检","title":"抽检","value":"6"}],"timestamp":1622946045266,"code":206,"key":"ZHSW.DEVICE.BUG_SOURCE"}
			`;
			var data = JSON.parse(dataStr)
		}
		if(isTest) {
			setupCommWithData(1,"iekd", false);
		}

	</script>
</html>
