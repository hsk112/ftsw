<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>缺陷查看</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <link href="../../css/mui.min.css" rel="stylesheet" />
    <link href="../../css/mui.picker.css" rel="stylesheet" />
    <link href="../../css/mui.picker.min.css" rel="stylesheet" />
    <link href="../../css/mui.poppicker.css" rel="stylesheet" />
    <link href="../../css/common.css" rel="stylesheet" />
	<link rel="stylesheet" type="text/css" href="../../css/mui.imageviewer.css" />
    <style>
        img[src=""],img:not([src]){
            opacity:0;
        }
        .bar-content-item{
            height: 150px;
            margin: 0px 20px;
            border-bottom: 1px solid #EDEDED;
        }
        .bar-content-item .item-title{
            text-align: left;
            padding: 15px 0px 0px 0px;
            font-size: 14px;
            color: #444444;
        }
        .img_item{
			text-align: left;
			width: 72px;
			height: 100px;
			float: left;
			margin-right: 20px;
        }
        .img_item img{
            width: 72px;
            height: 72px;
        }
    </style>
</head>

<body>
<!--页面主结构开始-->
<div id="app" class="mui-views">
    <div class="mui-view">
        <div class="mui-navbar">
        </div>
        <div class="mui-pages">
        </div>
    </div>
</div>
<!--页面主结构结束-->
<!--<div id="slider" class="mui-slider" style="position:fixed;z-index:10 ">-->
    <!--<div class="mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted" style="height: 60px" id="segmented">-->
        <!--<div class="mui-scroll" style="width: 100%;height: 100%;font-size:15px">-->
            <!--<a class="mui-control-item mui-active queryQx" href="#item1mobile" style="margin-top:14px;width:50%;font-weight: bolder;touch-action: none">-->
                <!--缺陷详情-->
            <!--</a>-->
            <!--<a class="mui-control-item handQx"  href="#item2mobile" style="margin-top:14px;width:50%;font-weight: bolder;touch-action: none">-->
                <!--缺陷处理-->
            <!--</a>-->
        <!--</div>-->
    <!--</div>-->
    <!--&lt;!&ndash;分隔&ndash;&gt;-->
    <!--<div style="background-color:#EDEDED;height:2px;margin: 0;"></div>-->
<!--</div>-->
<!--单页面开始-->
<div id="mui-content" class="mui-page paish">
    <!--页面标题栏开始-->
    <!--<header class="mui-bar mui-bar-nav common-header">-->
        <!--<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>-->
        <!--<h1 class="mui-title">缺陷详情</h1>-->
    <!--</header>-->
    <!--页面标题栏结束-->
    <!--页面主内容区开始-->
    <div class="mui-page-content">
        <div class="mui-scroll-wrapper">
            <div class="mui-scroll">
                <div class="scroll-li">
                    <!--缺陷详情-->
                    <div id="detail" class="info-bar-content" style="display: block">
                        <div class="info-bar-content-item">
                            <div class="item-title">
                                缺陷来源
                            </div>
                            <div class="mui-input-row item-input">
                                <input id="bugSource" readonly="readonly" type="text">
                            </div>
                        </div>
                        <div class="info-bar-content-item">
                            <div class="item-title">
                                设施类型
                            </div>
                            <div class="mui-input-row item-input">
                                <input id="obj_input" readonly="readonly" type="text" value="">
                            </div>
                        </div>
                        <div class="info-bar-content-item">
                            <div class="item-title">
                                所在片区
                            </div>
                            <div class="mui-input-row item-input">
                                <input id="comm_input" readonly="readonly" type="text" value="">
                            </div>
                        </div>
                        <div class="info-bar-content-item">
                            <div class="item-title">
                                设施编号
                            </div>
                            <div class="mui-input-row item-input">
                                <input id="obj" readonly="readonly" type="text" value="">
                            </div>
                        </div>
                        <div class="info-bar-content-item" style="height: 130px;">
                            <div class="item-title" style="margin-bottom: 10px;">
                                所在地点
                            </div>
                            <div class="mui-input-row item-input">
                                <textarea id="locationContent" readonly="readonly" rows="2" type="text" value=""></textarea>
                            </div>
                        </div>
                        <div class="info-bar-content-item">
                            <div class="item-title">
                                缺陷类型
                            </div>
                            <div class="mui-input-row item-input">
                                <input id="bugType_input" readonly="readonly" type="text" value="">
                            </div>
                        </div>
                        <div class="info-bar-content-item">
                            <div class="item-title">
                                缺陷等级
                            </div>
                            <div class="mui-input-row item-input">
                                <input id="bugLevel_input" readonly="readonly" type="text" value="">
                            </div>
                        </div>
                        <div class="bar-content-item" style="height: 170px;">
                            <div class="item-title" style="margin-bottom: 10px;">
                                缺陷描述
                            </div>
                            <div class="mui-input-row item-input">
                                <textarea id="problemContent" readonly="readonly" rows="5" type="text"  value=""></textarea>
                            </div>
                        </div>

                        <div class="info-bar-content-item" style="height: 150px;">
                            <div class="item-title" style="margin-bottom: 10px;">
                                整体图片
                            </div>
                            <div class="img_list"></div>
                            <div id="photo" class="img_item">
                                <img src="../../img/commom/pz@2x.png" style="" />
                            </div>
                        </div>
                        <div class="info-bar-content-item" style="height: 150px;">
                            <div class="item-title" style="margin-bottom: 10px;">
                                局部图片
                            </div>
                            <div class="img_list2"></div>
                            <div id="photo2" class="img_item">
                                <img src="../../img/commom/pz@2x.png" style="" />
                            </div>
                        </div>
                        <div class="info-bar-content-item" style="height: 150px;">
                            <div class="item-title" style="margin-bottom: 10px;">
                                关键图片<span style="color: red;"></span>
                            </div>
                            <div class="img_list3"></div>
                            <div id="photo3" class="img_item">
                                <img src="../../img/commom/pz@2x.png" style="" />
                            </div>
                        </div>
                        <div class="info-bar-content-item">
                            <div class="item-title">
                                发现人
                            </div>
                            <div class="mui-input-row item-input">
                                <input id="findBy_input" readonly="readonly" type="text" value="">
                            </div>
                        </div>
                        <div class="info-bar-content-item">
                            <div class="item-title">
                                发现日期
                            </div>
                            <div class="mui-input-row item-input">
                                <div class="mui-row task-item">
                                    <div class="mui-col-xs-8 task-item-title">
                                        <input id="findTime" readonly="readonly" type="text" style="width: 90%;">
                                    </div>
                                    <div class="mui-col-xs-4" style="line-height: 43px;text-align: right;">
                                        <img src="../../img/cal.png" style="width: 14px;height: 14px;" />
                                    </div>
                                </div>
                            </div>

                        </div>
                        <div class="info-bar-content-item">
                            <div class="item-title">
                                负责人
                            </div>
                            <div class="mui-input-row item-input">
                                <input id="handler_input" readonly="readonly" type="text" value="">
                            </div>
                        </div>
                    </div>
                </div>

                <div id="okArea" class="bottom-btn">
                    <div class="btn-item">
                        <div id="ok" style="background: #337BFC;color: #fff;">返回</div>
                    </div>
                </div>

                <div id="actionBtn" class="bottom-btn" style="display: none">
                    <div class="btn-item">
                        <div id="return" style="background: #337BFC;color: #fff;">返回</div>
                    </div>
                    <div class="btn-item">
                        <div id="handle" style="background: #337BFC;color: #fff;">查看处理情况</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--页面主内容区结束-->
</div>

</body>
<script type="text/javascript" src="http://gd.wiseom.cn/supermap/mapbox-gl-enhance.js"></script>
<script type="text/javascript" src="http://gd.wiseom.cn/supermap/iclient-mapboxgl.min.js"></script>
<script src="http://gd.wiseom.cn/mobile-lib/mobile-lib.umd.js"></script>

<script src="../../js/mui.min.js"></script>
<script src="../../js/mui.view.js"></script>
<script src="../../js/mui.locker.js"></script>
<script src="../../js/mui.picker.js"></script>
<script src="../../js/mui.picker.min.js"></script>
<script src="../../js/mui.poppicker.js"></script>
<script src="../../js/jquery.min.js"></script>

<script src="../../js/common.js"></script>
<script src="../../js/app.js"></script>
<script src="../../js/config.js"></script>
<script src="../../js/qx.js"></script>
<script src="../../js/uploadimage.js"></script>
<script src="../../js/paishuihu.js"></script>
<script src="../../js/position.js"></script>
<script src="../../js/helper.js"></script>
<script src="../../js/s4.js"></script>
<script src="../../js/smutils.js"></script>
<script src="../../js/byte&string.js"></script>
<script src="../../js/ajaxhook.min.js"></script>
<script src="../../js/mui.zoom.js"></script>
<script src="../../js/mui.previewimage.js"></script>
<!-- <script src="../../js/vconsole.min.js"></script> -->
<script type="text/javascript">
	// var vConsole = new VConsole();
    mui.init({
        beforeback: function() {
            //获得父页面的webview
            var list = plus.webview.currentWebview().opener();
            //触发父页面的自定义事件(refresh),从而进行刷新
            // mui.fire(list, 'refresh');
            //返回true,继续页面关闭逻辑
            return true;
        }
    });
    //初始化单页view
    var viewApi = mui('#app').view({
        defaultPage: '#mui-content'
    });
    //初始化单页的区域滚动
    mui('.mui-scroll-wrapper').scroll();

    var guid="";
	var bugAllImageToken = '';
	var bugPartImageToken = '';
	var bugKeyImageToken = '';
    var self ='';
    const mapData = window['mobile-lib'].MapData({
        serverUrl: config.urls.serverDomain,style:'color'
    });

    mui.plusReady(function() {
        self = plus.webview.currentWebview();
        var qid = self.idd;
        guid = qid;

        if(self.btnStatus == 'true'){
            $("#okArea").css("display","none");
            $("#actionBtn").css("display","inline-block");
            $("#actionBtn .btn-item").css("width","50%");
        } else {
            $("#actionBtn").css("display","none");
            $("#okArea").css("display","inline-block");
            $("#okArea .btn-item").css("width","100%");
        }

        //根据qid获取缺陷
        searchBugById(qid,function(data){
            if (200 != parseInt(data.code)) {
                app.toast(data);
                return;
            }

            var item = data.result;
            // console.log(JSON.stringify(item))
            objTypeId = item.objectType;

            //获取缺陷来源
            getAQx_Source(item.bugSource,function(data){
                $("#bugSource").val(data)
            })
            //获取设施对象名

            getAQx_ObjType(item.objectType,function (data) {//设施类型
				$("#obj_input").val(data)
            })
            //缺陷类型
			
            getAQx_Type(item.objectType,item.bugType,function(data){				
                $("#bugType_input").val(isEmp(data.text))
            })
            //缺陷等级
            if(item.bugLevel == "" || item.bugLevel==null){
                $("#bugLevel_input").val('无')
            }
			// console.log(item.bugLevel)
            getAQx_Level(item.bugLevel,function(data){
				console.log(JSON.stringify(data))
                if(data) $("#bugLevel_input").val(data)
                else $("#bugLevel_input").val('无')
            })

            //获取小区by commId
            if(!isEmpty(item.commId)){
                getXqById(item.commId,function (data) {
                    if (200 != parseInt(data.code)) {
                        $("#comm_input").val();
                    }
                    if(data.result.reName) $("#comm_input").val(data.result.reName);
                    else $("#comm_input").val('无');
                })
                commId = item.commId;
            } else {
                $("#comm_input").val('无');
            }

            //获取小区by commName
            // $("#comm_input").val(commName)
            if(item.objectId) $("#obj").val(isEmp(item.objectId));   //所在设施编号
            else $("#obj").val('无');

            $("#problemContent").val(isEmp(item.problemContent))   //缺陷描述
            if(item.locationContent) $("#locationContent").val(isEmp(item.locationContent));   //地点
            else $("#locationContent").val('无');

				//1.获取缺陷-全局图片token
				queryQxPhoto(item.bugAllImage, function(data) {
					if (data.success) {					
						bugAllImageToken = data;
					} else {
						// console.log("this-undefined");
					}
				})
				//2.获取缺陷-局部图片token
				queryQxPhoto(item.bugPartImage, function(data) {
					if (data.success) {
						// console.log(data);
						bugPartImageToken = data;
					} else {
						// console.log("this-undefined");
					}
				})
				//3.获取缺陷-关键图片token
				queryQxPhoto(item.bugKeyImage, function(data) {
					if (data.success) {
						// console.log(data);
						bugKeyImageToken = data;
					} else {
						// console.log("this-undefined");
					}
				})
				//全局图片
				if (bugAllImageToken == '') {
					$(".img_list").html('<div style="text-align:left">无</div>');
					var h = 90;
									
					$(".img_list").parent().css("height", h + 'px')
					$("#photo").hide();
				} else {
					var count = bugAllImageToken.result.length;
					var html = '';
					for (let i = 0; i < bugAllImageToken.result.length; i++) {
						let url = config.urls.baseUrl + "sys/common/view/" + bugAllImageToken.result[i].uploadFile.savePath;
						html += '<div class="img_item" id="img1" data-token="' + bugAllImageToken.result[i].fileToken +
							'" filePath="' + bugAllImageToken.result[i].uploadFile.savePath + '">' +
							'		<img class="imgCss" data-preview-src="" data-preview-group="img1" src="' + url + '" style=""  />' +
							'	</div>';
					}
					$(".img_list").append(html);
					var h = 160 + (Math.ceil(count / 3) - 1) * 110;

					$(".img_list").parent().css("height", h + 'px')
					$("#photo").hide();
					// $("#photo").attr('src',allPath);
				}

				//局部图片
				if (bugPartImageToken == '') {
					$(".img_list2").html('<div style="text-align:left">无</div>');
					var h = 80;
									
					$(".img_list2").parent().css("height", h + 'px')
					$("#photo2").hide();
				} else {

					var count = bugPartImageToken.result.length;
					var html = '';
					for (let i = 0; i < bugPartImageToken.result.length; i++) {
						let url = config.urls.baseUrl + "sys/common/view/" + bugPartImageToken.result[i].uploadFile.savePath
						html += '<div class="img_item"  id="img2" data-token="' + bugPartImageToken.result[i].fileToken +
							'" filePath="' + bugPartImageToken.result[i].uploadFile.savePath + '">' +
							'		<img class="imgCss" data-preview-src="" data-preview-group="img2" src="' + url + '" style=""  />' +
							'	</div>';
					}
					$(".img_list2").append(html);
					var h = 150 + (Math.ceil(count  / 3) - 1) * 110;

					$(".img_list2").parent().css("height", h + 'px')
					$("#photo2").hide();
					// $("#photo2").attr('src',partPath);
				}

				//关键图片
				if (bugKeyImageToken == '') {
					$(".img_list3").html('<div style="text-align:left">无</div>');
					var h = 80;
									
					$(".img_list3").parent().css("height", h + 'px')
					$("#photo3").hide();
				} else {
					var count = bugKeyImageToken.result.length;
					var html = '';
					for (let i = 0; i < bugKeyImageToken.result.length; i++) {
						let url = config.urls.baseUrl + "sys/common/view/" + bugKeyImageToken.result[i].uploadFile.savePath
						html += '<div class="img_item"  id="img3" data-token="' + bugKeyImageToken.result[i].fileToken +
							'" filePath="' + bugKeyImageToken.result[i].uploadFile.savePath+ '">' +
							'		<img class="imgCss" data-preview-src="" data-preview-group="img3" src="' + url + '" style=""  />' +
							'	</div>';
					}
					$(".img_list3").append(html);
					var h = 150 + (Math.ceil(count  / 3) - 1) * 110;

					$(".img_list3").parent().css("height", h + 'px')
					$("#photo3").hide();
					// $("#photo3").attr('src',keyPath);
				}

            $("#findBy_input").val(isEmp(item.findBy))   //发现人
            $("#findTime").val(isEmp(item.findTime))   //发现日期
            // $("#department_input").val(item.belongName)   //负责单位 ->belongName(belongid去找)
            $("#handler_input").val(isEmp(item.belongManager))  //负责人
        });
    });

    //点击返回
    $("#ok").on("tap", function() {
        mui.back();
    });

    //点击返回
    $("#return").on("tap", function() {
        mui.back();
    });

    //点击处理
    $("#handle").on("tap", function() {
        var extras = { idd: guid, btnStatus: 'false' };
        app.openPage("qx_handle.html", {
            titleNView: {
                titleText: '处理缺陷',
                autoBackButton: true
            }
        }, extras);
    });
	
	$("body").delegate("img[class=imgCss]","tap", function(e) {
		mui.previewImage();
	});
</script>

</html>
