<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
		<title>质安监管-新增检查记录</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

        <link href="../../../css/mui.min.css" rel="stylesheet" />
		<link href="../../../css/common.css" rel="stylesheet" /> 
        <link href="../../../css/mui.picker.min.css" rel="stylesheet" />    
		<link href="../../../css/mui.poppicker.css" rel="stylesheet" />
        <link rel="stylesheet" type="text/css" href="../../../css/mui.imageviewer.css" />
        <style>
            .mui-page-content{
                padding-top:44px !important;
            }
            .recordInp::placeholder{
                text-align: right;
            }
            .recordInp{
                text-align: right;
                padding:10px 0 10px 15px !important;
                position: relative;
                top:10px;
            }
            .record-list{
               padding:0 20px 0 20px;
            }
            .lable{
                position: relative;
                text-align: left;
                padding:11px 0 11px 8px !important;
                height: 55px;
            }
            .lable span{
                position: absolute;
                top:15px;
                left:0px;
                color: #DB2828;
            }
            .date-item{
                position: relative;
            }
            .date-select{
                position: absolute;
                right: 0px;
                top:10px;
                font-size:16px;
            }
            .dateSelect{
                text-align: left !important;;
                width: 120px !important;
                font-size:  16px !important; ;
            }
            .dateSelect::placeholder{
                text-align: left;
                font-size: 16px;
            }
            .dateSelect-fill{
                text-align: left !important;;
                width: 120px !important;
                font-size:  16px !important; ;
            }
            .dateSelect-fill::placeholder{
                text-align: left;
                font-size: 16px;
            }
            .day-record{
                position: relative;
            }
            .dayRecord{
                position: absolute;
                right: 0px;
                top:0PX;
            }
            .dayRecord span{
                font-size: 16px;
                color: #C5C5C5;
            }
            /* ------------- */
            .issues-total{
                display: flex;
                justify-content: space-between;
                padding:0 16px;
                height: 55px;
                line-height: 55px;
                font-size: 14px;
            }
            .total{
                color:#0493F3;
            }
            .mui-icon-bars{
                font-size: 14px;
                color:#0493F3;
            } 
            .bar{
                font-size: 18px;
                color:#0493F3;
            }  
            /* ------------*/
            
            .issues-list-item{
                padding:10px;
                text-align: left;
                background: #f4f4f4;
            }
            .issues-item-probably{
                font-size: 14px;
                padding-left: 20px;
                padding-right: 27px;
                padding-bottom: 20px;
                padding-top:1px;
                background: #fff;
                border-radius: 5px;
            }
            .item-list{
                margin-top:20px;
                display: flex;
                
            }
            .text-ellipsis{
                overflow: hidden;
                white-space:nowrap;
                text-overflow: ellipsis;
            }
            .fixed{
                color:#8C8C8C;
                display: inline-block;
                white-space:nowrap;
                margin-right: 8px;
            }
            .dynamic{
                color:#444444;
            }
            .pic{
                
                display: flex;
                flex-direction:row;
                flex-wrap:wrap;
                overflow:hidden
            }
            .quesList_img>img{
                width: 72px;
                height: 72px;
                border-radius: 5px;
            }
            .setHeight{
                height: 72px;
            }
            .quesList_img{
                margin-right: 2px;
                margin-bottom: 2px;
            }
            .item-probably-bot{
                margin-top:20px;
                border-top: solid 0.5px #EDEDED;
                line-height: 44px;
                height: 44px;
                display: flex;
                justify-content: space-between;
            }
            .corner{
                font-size: 18px;
                color: #C5C5C5;
                line-height: 44px;
            }
            
            .cut{
                font-size: 14px;
                color: #444444;
            }
            
            .hidden{
                display: none;
            }
            .issues-list-item{
                background:#F4F4F4;
            }
            /* ----- */
            
            .page-bottom{
                padding-left: 20px;
            }
            .remark-text{
                height: 55px;
                text-align: left ;
                line-height: 55px;
                border-top:solid 0.5px #EDEDED;
                border-bottom: solid 0.5px #EDEDED;
            }
            /* ---------- */
            .page-footer{
                padding:0 20px 0 20px;
            }
            .page-footer .f-item-list{
                height: 55px;
                line-height: 55px;
                display: flex;
                justify-content: space-between;
            }
            .page-footer .f-item-list input{
                border:none;
                text-align: right;
            }
            .page-footer .f-item-list input::placeholder{
                text-align: right;
                font-size: 16px;
            }
            .page-footer .dateS{
                display: flex;
                justify-content: flex-end;
                align-items: center;
                padding-right: 12px;
            }
            /* ------ */
            .footer-btn{
                height: 98px;
                background: #F4F4F4;
                line-height: 98px;
            }
            .footer-btn .btn-sub{
                width: 335px;
                height: 48px;
                background: #0493F3;
                color:#fff;
                font-size: 18px;
                text-align: center;
                border-radius: 4px;
                margin: 0 auto;
                vertical-align:middle;
            }
            .issues-item{
                margin-bottom: 20px;
            }
            /* .mui-input-row:not(:nth-child(5)){
                border-bottom: 1px solid #EDEDED;
                
            } */
            .lable{
                position: relative;
                top: 10px;
            }
            .input-row-item{
                border-bottom: 1px solid #EDEDED;
            }
            /* .attachment .attachment-item{
                width: 100%;
                height: 55px;
                border: solid 0.5px #EDEDED;
                border-radius: 5px;
            } */
            .footer-btn{
                height: 98px;
                background: #F4F4F4;
                line-height: 98px;
            }
            .footer-btn .btn-sub{
                width: 335px;
                height: 48px;
                background: #0493F3;
                color:#fff;
                font-size: 18px;
                text-align: center;
                border-radius: 4px;
                margin: 0 auto;
                vertical-align:middle;
                line-height: 48px;
                display: inline-block;
            }
        </style>
</head>
<body>
    <!--页面主结构开始-->
		<div id="app" class="mui-views">
			<div class="mui-view">
				<div class="mui-navbar">
				</div>
				<div class="mui-pages">
				</div>
			</div>
		</div>
		<!--页面主结构结束-->
        <div id="mui-content" class="mui-page">
            <!--单页面标题开始-->
            <!-- <header class="mui-bar mui-bar-nav common-header">
                <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
                <h1 class="mui-title">新增问题</h1>
            </header> -->
            <!--页面标题栏结束-->
            <!-- 页面主要内容区开始 -->
            <div class="mui-page-content">
                <div class="mui-scroll-wrapper">
                    <div class="mui-scroll">
                        <div class="record-list">
                            <div class="mui-input-row input-row-item">
                                <label class="lable">项目名称</label>
                                <input type="text" class=" recordInp projectName" readonly="readonly" placeholder="这是项目名称">
                            </div>                       
                            <div class="mui-input-row input-row-item">
                                <label class="lable">项目编号</label>
                                <input type="text" class=" recordInp projectNo" readonly="readonly" placeholder="自动填充">
                            </div>
                            <div class="mui-input-row input-row-item">
                                <label class="lable"><span>*</span>安全教育名称</label>
                                <input type="text" class=" recordInp educationName"  placeholder="教育名称">
                            </div>
                            <div class="mui-input-row input-row-item">
                                <label class="lable"><span>*</span>培训地点</label>
                                <input type="text" class=" recordInp address"  placeholder="培训地点" style="width:100px;margin-right:20px;">
                                <span class="date-sideslipp"><img src="../../../img/local.png" style="width:18px;height:18px;position: absolute;right: 0px;top:20px;" alt=""></span>
                            </div>
                            <div class="mui-input-row input-row-item record-type day-record" style="border-bottom:1px solid #ededed">
                                <label class="lable"><span>*</span>培训类别</label>
                                <input type="text" class=" recordInp trainType"  placeholder="培训类别">
                            </div>
                            <div class="mui-input-row input-row-item date-item">
                                <label class="lable"><span>*</span>培训时间</label>
                                <input type="text" readonly="readonly" class=" recordInp dateSelect trainTime" placeholder="2021-04-19"/>
                                <span class="date-sideslip"><img src="../../../img/cal.png" style="width:16px;height:16px;position: absolute;right: 0px;top:22px;" alt=""></span>
                            </div>
                            
                            <div class="mui-input-row input-row-item">
                                <label class="lable">培训内容</label>
                                <input type="text" class=" recordInp dailyCheckPersonRealname" readonly="readonly" >
                            </div>
                        </div>
                        
                        <!-- <div class="issues-total">
                            <div class="issues-total-left">
                                <img src="../../../img/fujin-icon.png"
                       style="width: 13px;height: 14px;line-height: 14px;vertical-align:middle;margin-top: -2px"/>
                                <span class="issues-text">问题列表</span>:
                                <span class="total">0</span>
                            </div>  
                            <div class="issues-total-right">
                                <span class="mui-icon mui-icon-arrowdown top-bar hidden bar"></span>
                                <span class="mui-icon mui-icon-arrowup bottom-bar  bar"></span>
                            </div>
                        </div> -->
                        <div class="issues-list-item hidden">
                            
                        </div>
                        <div class="page-middle">
                            
                            <div class="page-bottom">
                                <!-- <div class="remark-text">
                                    培训内容
                                </div> -->
                                <textarea  class="remark" name="remark" id="remark" maxlength= 300 placeholder="请输入相关描述(300以内)" style="height:144px;width:100%;border:none"></textarea>
                            </div>
                            <div class="page-footer">
                                <div class="mui-input-row input-row-item" style="margin-bottom: 8px;">
                                    <label class="lable">附件</label>
                                    <input type="text" class=" recordInp upflie" readonly="readonly" value="上传文件" style="color:#0493F3;margin-right:20px;width:100px;font-size: 16px;margin-top:-2px;">
                                    <span class="date-sideslipp"><img src="../../../img/file_upload_icon.png" style="width:14px;height:12px;position: absolute;right: 0px;top:23px;" alt=""></span>
                                </div>
                                <div class="attachment">
                                    <div class="attachment-item" id="reformFile" >

                                    </div>
                                </div>
                                <div class="mui-input-row input-row-item">
                                    <label class="lable">填写人</label>
                                    <input type="text" class=" recordInp inputName" readonly="readonly" placeholder="法外狂徒">
                                </div>
                                <div class="mui-input-row input-row-item">
                                    <label class="lable">填写部门</label>
                                    <input type="text" class=" recordInp inputDepartmentFullname" readonly="readonly" placeholder="质检部">
                                </div>
                                <div class="mui-input-row input-row-item">
                                    <label class="lable">联系方式</label>
                                    <input type="text" class=" recordInp inputPhone" readonly="readonly" placeholder="123456789">
                                </div>
                                <div class="mui-input-row input-row-item date-item">
                                    <label class="lable" >填写日期</label>
                                        <input type="text" readonly="readonly" class=" recordInp  dateSelect-fill inputDate" placeholder="2021-04-19"/>
                                        <span class=""><img src="../../../img/cal.png" style="width:16px;height:16px;position: absolute;right: 0px;top:22px;" alt=""></span>
                                </div>                                
                            </div>
                            <div class="footer-btn">
                                <div class="btn-sub">提交</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
</body>
<script src="../../../js/mui.min.js"></script>
	<script src="../../../js/mui.view.js"></script>
	<script src="../../../js/mui.locker.js"></script>
	<script src="../../../js/mui.picker.min.js"></script>
	<script src="../../../js/mui.picker.js"></script>
	<script src="../../../js/mui.poppicker.js"></script>
    <script src="../../../js/qualityControl/qualityControl.js"></script>

	<script src="../../../js/app.js"></script>	
	<script src="../../../js/config.js"></script>
	<script src="../../../js/jquery.min.js"></script>
	<script src="../../../js/common.js"></script>
	<script src="../../../js/conservation.js"></script>
	<script src="../../../js/education.js"></script>
	<script src="../../../js/helper.js"></script>
	<script src="../../../js/uploadimage.js"></script>
	<script src="../../../js/s4.js"></script>
	<script src="../../../js/smutils.js"></script>
	<script src="../../../js/byte&string.js"></script>
	<script src="../../../js/ajaxhook.min.js"></script>
	<script src="../../../js/mui.zoom.js"></script>
	<script src="../../../js/mui.previewimage.js"></script>
<script>
     mui.init({});
		//初始化单页view
		var viewApi = mui('#app').view({
			defaultPage: '#mui-content'
		});
		//初始化单页的区域滚动
		mui('.mui-scroll-wrapper').scroll();
        var strAttachment = [{
			"groupId": '',
			"fileTokens": '',
			"fieldName": "attachment",
			"tableName": "SAFETY_EDUCATION_PLAN"
		}];
        var self;
            var isUpload = true
            // initCheckBox()
            var fullTime = ''
            var trainTypeNum = -1;
            var projectInfo = JSON.parse(localStorage.getItem('projectInfo') || "{}")
            var stateText = JSON.parse(localStorage.getItem('$state') || "{}")
            var date = new Date();
            var year = date.getFullYear();
            var month = date.getMonth() + 1;
            var day = date.getDate();
            var hour = date.getHours();
            var minute = date.getMinutes();
            var second = date.getSeconds();
            if (month < 10) {
                month = "0" + month;
            }
            if (day < 10) {
                day = "0" + day;
            }
            if(minute < 10){
                minute = "0" + minute
            }
            if(second < 10){
                second = "0" + second
            }
            var nowDate = year + "-" + month + "-" + day;
            var nowHour =hour + ":" + minute + ":" + second;
		mui.plusReady(function() {
            var self = plus.webview.currentWebview()
            $(".projectName").val(projectInfo.prjName)
            $(".projectNo").val(projectInfo.prjNo)
            $(".inputName").val(stateText.userInfo.realname)
            $(".inputDepartmentFullname").val(stateText.userInfo.departName)
            $(".inputPhone").val(stateText.userInfo.personMobilePhone)
            $(".inputDate").val(nowDate)
            $('.upflie').on('tap',function(){
                event.stopPropagation();
				if(isUpload){
					isUpload = false;
					let fileSuffix = 'jpg、png、jpeg、rar、zip、doc、docx、pdf、xls、xlsx';
					plusSelectFile(fileSuffix,function(data, path) {
						if (data.success) {
							console.log(JSON.stringify(data))
							strAttachment[0].fileTokens = data.result.fileTokens;
							var fileType = data.result.uploadFile.fileType;
							var name = path.substring(path.lastIndexOf("/") + 1, path.length);
							var iconPath="";
			
							if (fileType == '.jpg' || fileType == '.png' || fileType == '.jepg'||
								fileType == '.pdf' || fileType == '.doc' || fileType == '.docx'||
								fileType == '.xls' || fileType == '.xlsx' || fileType == '.rar'  || fileType == '.zip') {
								switch(fileType){
									case '.doc':
									case '.docx':
										iconPath='../../../img/commom/doc.png';
										break;
									case '.pdf':
										iconPath='../../../img/commom/pdf.png';
										break;
									case '.xls':
									case '.xlsx':
										iconPath='../../../img/commom/xlsx.png';
										break;
									case '.rar':
										iconPath='../../../img/commom/rar.png';
										break;
									case '.zip':
										iconPath='../../../img/commom/zip.png';
										break;	
								}
								app.toast("文件上传成功");
			
								plus.io.resolveLocalFileSystemURL(path, function(entry) {
									entry.file(function(file) {
										let fileSize = Math.floor(file.size / 1024);						
										var str = '';
										if(fileType == '.jpg' || fileType == '.png' || fileType == '.jepg'){
											str = '<div id="' + data.result.uploadFile.id + '" data-token="' + data.result.fileTokens +
												'" class="img_item">' +
												'		<img class="img_src imgCss" data-preview-src="" data-preview-group="1" src="' + path + '" style="width: 40px;height: 45px;"  />' +
												'		<span id="closeImg" class=" myImgClose mui-icon mui-icon-closeempty" style="    font-size: 16px;color: #888888;background: #E7E7E7;border-radius: 50%;"></span>' +

												'	</div>';
												$("#reformFile").css("text-align","left")
												$("#reformFile").css("height","120px")
										}else{
											 str = `<div class="fileContent-item"` +
												` data-token="` + data.result.fileTokens + `"` +
												`<div style="padding:12px 0 10px 0;display:flex;font-size:14px;">
																<div class="typeImg">
																	<img src=${iconPath} style="width: 40px;height: 45px;"></img>
																</div>
																<div class="fileContent-item-title" style="display:flex;flex-direction:column;margin-left:12px;font-size:14px;text-algin:left;">
																	<span class="titleSpan">` +
												name +
												`</span>
															<span class="fileSize" style="font-size:12px;">`+file.size+`KB</span>
														</div>
														<div class="removeFile" style="margin-left:160px;">
															<img src="../../../img/commom/del.png" style="width: 18px;height: 18px;"></img>
														</div>											
													</div>
												</div>`											
										}
										// $("#fileId").val(data.result.uploadFile.id);
										// $("#attachDiv").css("height","200px")
										$("#reformFile").append(str);
										$("#reformFile").show();
                                        // $("#reformFile").css("border","solid 0.5px #EDEDED")
										$(".upflie").attr("disabled", true);
									});
								}, function(e) {
									alert("文件获取失败:" + e.message);
								});
							} else {
								app.toast("文件必须为jpg、png、jpeg、rar、zip、doc、docx、pdf、xls、xlsx格式，请重新上传！");
							}
						} else {
							app.toast(data.message);
						}
					})
				} 
            });
            setTimeout(function(){
					isUpload = true
				},1000)
        })
        // 时间选择器
    $(".date-sideslip").on('tap',function() {
        var dtPicker = new mui.DtPicker({type:'date'}); 
        dtPicker.show(function (selectItems) { 
                var y = selectItems.y.text;  //获取选择的年
               var m = selectItems.m.text;  //获取选择的月
               var d = selectItems.d.text;  //获取选择的日
               var date = y + "-" + m + "-" + d ;

               $(".trainTime").val(date)  
        })
        
         
    })
    $(".trainType").on('tap',function(){
                var picker = new mui.PopPicker();
                picker.setData([
                    {value:'01',text:'班前教育'},
                    {value:'02',text:'项目部安全教育'},
                    {value:'03',text:'公司安全教育'},
                    {value:'04',text:'其他'},
                ]);
                picker.show(function (selectItems) {
                    $(".trainType").val(selectItems[0].text)
                    trainTypeNum = selectItems[0].value
                })
            
    })
    $(".btn-sub").on('tap',function(){
        if(strAttachment[0].groupId == ''){
            strAttachment[0].groupId = uuid()
        }
        console.log(strAttachment[0].groupId)
        if($(".educationName").val().trim() == ''){
            app.toast('安全教育名称不能为空')
            return
        }
        if($(".address").val().trim() == ''){
            app.toast('培训地点不能为空')
            return
        }
        if($(".trainType").val().trim() == ''){
            app.toast('培训类别不能为空')
            return
        }
        if($(".trainTime").val().trim() == ''){
            app.toast('培训时间不能为空')
            return
        }
        fullTime = $(".trainTime").val() + ' ' + nowHour
        console.log(fullTime)
        var params = {
            projectName:projectInfo.prjName,
            projectNo:projectInfo.prjNo,
            projectId:projectInfo.prjId,
            educationName:$(".educationName").val(),
            address:$(".address").val(),
            trainType:trainTypeNum,
            trainTime:fullTime,
            trainContent:$("#remark").val(),
            attachment:strAttachment[0].groupId,
            inputName:$(".inputName").val(),
            inputFullname:stateText.userInfo.realname,
            inputDepartment:stateText.userInfo.departName,
            inputDepartmentFullname:stateText.depart.departName,
            inputDate:nowDate + ' ' + nowHour,
            inputPhone:stateText.userInfo.personMobilePhone,
            strAttachment:JSON.stringify(strAttachment),
        }
        var type = 'post'
        var url = config.urls.baseUrl + config.actions.addEducationRecord
        getProject(url,params,type,function(data){
            console.log(JSON.stringify(data))
            if(data.success){
                reset()
                var extras = {}
                app.openPage("./successAdd.html", {
                              titleNView: {
                                titleText: '检查记录',
                                autoBackButton: false,										
                              }
                            },extras);
                app.toast(data.message)
            }else{
                app.toast('提交失败')
            }
        })
    })
    function reset (){
        $(".educationName").val('')
        $(".address").val('')
        $(".trainType").val('')
        $(".trainTime").val('')
        $("#remark").val('')
        // $("#reformFile").empty()
    }
    //运行init，继续返回并出触发名为reload的刷新事件：
    window.addEventListener('init', function(event) {
        var opener = plus.webview.currentWebview().opener();
        mui.fire(opener, 'reload');
        mui.back();
    });
</script>