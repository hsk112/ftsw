<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>内部签到</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<link href="http://gd.wiseom.cn/supermap/iclient-mapboxgl.min.css" rel="stylesheet" />
		<link href="http://gd.wiseom.cn/supermap/mapbox-gl-enhance.css" rel="stylesheet" />


		<link href="../../../css/common.css" rel="stylesheet" />
		<link href="../../../css/mui.min.css" rel="stylesheet" />
		<link href="../../../css/mui.picker.min.css" rel="stylesheet" />
		<style>
			.mui-col-xs-6 {
				text-align: left;
			}
			.mui-table-view-cell.mui-collapse.mui-active .arrow_right{
				transform: rotate(90deg);
				margin-left: 5px;
			}
			.mui-control-content .mui-loading {
				margin-top: 50px;
			}
			.mui-slider{
				height: 100vh;
			}
			.mui-slider .mui-segmented-control.mui-segmented-control-inverted .mui-control-item.mui-active {
				border-bottom: 2px solid #337BFC;
				color: #337BFC;
			}
		   .mui-table-view-cell.mui-collapse.mui-active + .www .arrow_right {
		        transform: rotate(90deg);
		        margin-left: 5px;
		      }
			.mui-slider .mui-segmented-control.mui-segmented-control-inverted~.mui-slider-group .mui-slider-item {
				border-bottom: 0;
			}
			.mui-slider .mui-segmented-control.mui-segmented-control-inverted .mui-control-item.mui-active{
				border-bottom: 0;
			}
			.mui-slider .mui-segmented-control.mui-segmented-control-inverted .mui-control-item.mui-active +.titleleft{
				border-bottom: solid 2px #337BFC;
				display: inline-block;
			}

			.mui-segmented-control .mui-control-item {
				line-height: 43px;
			}
			.mui-scroll {
				background: #FFFFFF;
			}

			.task-ul {
				padding: 0;
			}

			.task-li {
				border-bottom: 5px solid #F4F4F4;
				height: 110px;
				padding: 0 20px;
			}

			.task-item {
				/* height: 50px; */
				line-height: 50px;
				/* padding: 0 5px; */
			}

			.task-item-btn {
				width: 50%;
				float: left;
				text-align: right;
				white-space: nowrap;
				padding: 0 0 0 5px;
			}

			.task-item-btn span {
				padding: 5px 15px;
				border: 1px solid #347CFC;
				color: #347CFC;
				border-radius: 21px;
				font-size: 12px;
			}

			.task-item-running {
				color: #FF5656;
				font-size: 13px;
				text-align: right;
				/* margin-right: 20px; */
			}

			.task-item-finished {
				color: #29CC85;
				font-size: 13px;
				text-align: right;
				/* margin-right: 20px; */
			}

			.task-item-ischange {
				color: #FF7800;
				font-size: 13px;
				text-align: right;
				/* margin-right: 20px; */
			}
			.task-item_status{
				position: absolute;
				top: 8px;
				right: 5px;
			}

			.mui-navigate-left:after
			{
			    content: '\e472';
				left: 5px;
				bottom: 50px;
			}
			.object{
				display: flex;
				justify-content: space-between;
				margin: 8px 0;
			}
			.li-item{
				background-color:white;
			}
			.li-item-pull{
				background-color: #F4F4F4 !important;
			}
			.li-margin{
				margin-bottom: 13px;
				border-bottom: 1px solid #EDEDED;
				padding-bottom: 0px;
				font-size: 13px;
				padding-bottom: 10px;
			}
			.in-obj{
				font-weight: 400;
				color: #888888;
				margin-right: 7px;
			}
			.obj-title{
				color: #444444;
			}
			.bgc-white{
				background-color: white;
			}
			.bgc-grey{
				background-color: #F4F4F4;
			}
			.mui-navigate-r{
				background: #fff;
			}
			.icon-css{
				display: inline-block;
				vertical-align: top;
			}
			
			.task_title{
				display: inline-block;
				padding: 8px 0;
				color: #191515;
				font-size: 15px;
				font-weight: 500;
				width: 50%;
				word-break: break-all;
				white-space: pre-wrap;
			}
			.sec-line{
				color: #878787;
				font-size: 14px;
			}
			/* 	.arrow_right{
				transform: rotate(90deg);
			} */
			.ul-mar-bottom{
				margin-bottom: -18px;
			}
			.mui-table-view-cell>a:not(.mui-btn){
				margin: 0;
				padding:0;
			}
			.mui-table-view-cell.mui-active{
				background: #fff;
			}
			.mui-slider .mui-segmented-control.mui-segmented-control-inverted .mui-control-item.mui-active.titleleft{
				border-bottom: solid 3px #337BFC;
				display: inline-block;
			}
			.mui-slider .mui-segmented-control.mui-segmented-control-inverted .mui-control-item.mui-active.titleright{
				border-bottom: solid 3px #337BFC;
				display: inline-block;
			}
			.mui-slider .mui-segmented-control.mui-segmented-control-inverted .mui-control-item.mui-active .lb{
				border-bottom: solid 3px #337BFC;
				display: inline-block;
				font-weight: bold;
			}
			.mui-slider .mui-segmented-control.mui-segmented-control-inverted .mui-control-item.mui-active .dt{
				border-bottom: solid 3px #337BFC;
				display: inline-block;
				font-weight: bold;
			}
			.mui-slider .mui-segmented-control.mui-segmented-control-inverted~.mui-slider-group .mui-slider-item{
				    border-top: 7px solid #F4F4F4
			}
			.color888{
				color: #888888;
			}
			.ibh{
				display: inline-block;
				line-height: 28px;
			}

			.mui-table-view-cell{
				padding: 0!important;
			}

			#select_ul span{
				padding: 0;
			}
			
			.mapboxgl-ctrl-bottom-left {
				bottom: -999px;
				left: 0;
			}

			.btn-outlined{
				border:1px solid #337BFC;
				color: #337BFC;
			}
			.mui-btn.mui-active:enabled{
				background: #337BFC;
			}
			
			#meetTitle{
				margin: 0 20px 10px 20px;
				padding-top: 20px;
				display: flex;
				align-items: center;
				
			}
			
			.meeting{
				font-size: 16px;
				font-weight: bold;
				width: 90%;
				overflow: hidden;
				text-overflow: ellipsis;
				white-space: nowrap;
			}
			
			.info{
				text-align: left;
				margin: 0 20px;
				font-size: 14px;
			}
			
			.info div,.info span{
				padding: 0;
				height: 30px;
				line-height: 30px;
				color: #888888;
			}
			
			#meetWrapper{
				background-color: #FFFFFF;
				padding-bottom: 20px;
			}
			
			#sign-wrapper{
				z-index: 999;
				position: fixed;
				bottom: 30px;
				width: 100%;
			}
			
			.signin-btn{
				width: 280px;
				height: 40px;
				border-radius: 20px;
				font-size: 16px;
				margin: 0 auto;
			}
		</style>
	</head>

	<body>
		<!--页面主结构开始-->
		<div id="app" class="mui-views">
			<div class="mui-view">
				<div class="mui-navbar">
				</div>
				<div class="mui-pages">
				</div>
			</div>
		</div>
		<!--页面主结构结束-->
		<!--单页面开始-->
		<div id="mui-content" class="mui-page">
			<!--页面标题栏开始-->
			<!--页面标题栏结束-->
			<!--页面主内容区开始-->
			<div class="mui-page-content">
				<div id="scroll-content" class="mui-scroll-wrapper">
					<div class="mui-scroll">
						<div class="scroll-li">
							<div id="meetWrapper">

							</div>
							<!--页面主内容区结束-->
						</div>
					</div>
				</div>
				<div id="sign-wrapper">
					<button type="button" id="signin-btn" class="mui-btn mui-btn-primary signin-btn">签到</button>
				</div>
			</div>
	</body>

	<script type="text/javascript" src="http://gd.wiseom.cn/supermap/mapbox-gl-enhance.js"></script>
	<script type="text/javascript" src="http://gd.wiseom.cn/supermap/iclient-mapboxgl.min.js"></script>

	<script src="../../../js/jquery.min.js"></script>
	<script src="../../../js/mui.min.js"></script>
	<script src="../../../js/mui.view.js"></script>
	<script src="../../../js/mui.locker.js"></script>
	<script src="../../../js/common.js"></script>
	<script src="../../../js/app.js"></script>
	<script src="../../../js/config.js"></script>
	<script src="../../../js/mixed.js"></script>
	<script src="../../../js/s4.js"></script>
	<script src="../../../js/smutils.js"></script>
	<script src="../../../js/byte&string.js"></script>
	<script src="../../../js/ajaxhook.min.js"></script>
	<script src="../../../js/mui.picker.min.js"></script>
	<script src="../../../js/position.js"></script>
	<script src="../../../js/vconsole.min.js"></script>
	<script src="../../../js/infoQuery/mixedList.js"></script>
	<script src="../../../js/mui.pullrefresh.js"></script>
	<script src="../../../js/mui.init.pullrefresh.js"></script>
	<script src="../../../js/meeting/meeting.js"></script>
	<script src="../../../js/util/timeUtil.js"></script>

	<script>
		//初始化单页view
		var viewApi = mui('#app').view({
			defaultPage: '#mui-content'
		});
		// var vConsole = new VConsole();
		mui.init({
			swipeBack: true,

		});

		var meetData = [];
		var loadFlag = false;
		var listData = {};

		//初始化单页的区域滚动
		mui('.mui-scroll-wrapper').scroll();
		var pickerpxtop = null;
		mui.plusReady(function() {

			var self = plus.webview.currentWebview();
			// console.log(JSON.stringify(self))
			listData = self.Data
			initList(listData)
            var end = Date.parse(EndTime);
            var now = Date.parse(new Date());
            if(now > end){
                $("#signin-btn").html("会议已结束")
                // $("#signin-btn").disabled = true;
        	}
		});

		// methods
		var initDestoryData = function(data, callback) {
			for (let key in data) {
				if (data[key] == '' || data[key] == null) {
					data[key] = '未知'
				}
			}
			callback(data);
		}

		var EndTime;
		function initList(listData) {
			var str = ``;
			// console.log("1", JSON.stringify(listData))
			initDestoryData(listData, function(Data) {
				// console.log(JSON.stringify(Data))
				let startTime = Data.startTime.split(' ');
				let endTime = Data.endTime.split(' ');
				let holdDate = Data.conferenceTime.split(' ')
				let continueTime = holdDate[0] + ' ' + startTime[1] + '-' + endTime[1]
				// 会议人数
				let memberNum = Data.participant.split(',').length

				// console.log(JSON.stringify(Data))
                EndTime = endTime;
                startTime = Data.startTime.substring(0,16)
                endTime = Data.endTime.substring(0,16)
                var dur = DateDifference(startTime,endTime)//时间间隔
                // let conferenceTime = Data.conferenceTime.substring(0,16)
				str +=
					`
						<div id="meetTitle" class="mui-row">
							<div style="width: 95%; display: flex; text-align: left;">
								<div class="meeting">
									${Data.conferenceTitle}
								</div>
							</div>
						</div>
						<div class="info" style="margin-bottom: 15px;">
							<span>ID: ${Data.projectNo}</span>
						</div>
						<div class="info open-details" style="border-top: 1px solid #EDEDED;">
							<div class="mui-row" style="margin-top: 20px;">
								<div class="mui-col-sm-4 mui-col-xs-4">
									开始时间：
								</div>
								<div class="mui-col-sm-8 mui-col-xs-8" style="text-align: right">
									`+startTime+`
								</div>
							</div>
							<div class="mui-row">
								<div class="mui-col-sm-4 mui-col-xs-4">
									结束时间：
								</div>
								<div  class="mui-col-sm-8 mui-col-xs-8" style="text-align: right">
									`+endTime+`
								</div>
							</div>
							<div class="mui-row">
								<div class="mui-col-sm-4 mui-col-xs-4">
									会议时长：
								</div>
								<div class="mui-col-sm-8 mui-col-xs-8" style="text-align: right">
									`+dur+`
								</div>
							</div>
							<div class="mui-row">
								<div class="mui-col-sm-4 mui-col-xs-4">
									姓名：
								</div>
								<div class="mui-col-sm-8 mui-col-xs-8" style="text-align: right">
									${Data.inputFullname}
								</div>
							</div>
							<div class="mui-row">
								<div class="mui-col-sm-4 mui-col-xs-4">
									单位名称：
								</div>
								<div class="mui-col-sm-8 mui-col-xs-8" style="text-align: right">
								     <div style="width: 100%;white-space: nowrap; overflow-x: scroll;">
								     	${Data.inputDepartmentFullname}
								     </div>
								</div>
							</div>
							<div class="mui-row">
								<div class="mui-col-sm-4 mui-col-xs-4">
									联系电话：
								</div>
								<div class="mui-col-sm-8 mui-col-xs-8" style="text-align: right">
									${Data.inputPhone}
								</div>
							</div>
						</div>
					`
			})
			$('#meetWrapper').html(str);
		}
		
		var getToday = function() {
			let DATE = new Date();
			let year = DATE.getFullYear();
			let month = DATE.getMonth() + 1 < 10 ? '0' + (DATE.getMonth() + 1) : DATE.getMonth() + 1;
			let day = DATE.getDate() < 10 ? '0' + DATE.getDate() : DATE.getDate();
			let hour = DATE.getHours() < 10 ? '0' + DATE.getHours() : DATE.getHours();
			let minu = DATE.getMinutes() < 10 ? '0' + DATE.getMinutes() : DATE.getMinutes();
			let sec = DATE.getSeconds() < 10 ? '0' + DATE.getSeconds() : DATE.getSeconds();
			return year + '-' + month + '-' + day + ' ' + hour + ':' + minu + ':' + sec;
		}

		// JQ
		$('#signin-btn').on('tap', function() {

		    var end = Date.parse(EndTime);
            var now = Date.parse(new Date());
			if(now > end){
			    app.toast("会议已结束，无法签到")
				return;
			}
            // var start='';
            // if(now < start){
            //     app.toast("会议尚未开始，无法签到")
            //     return;
            // }

			// console.log("userInfo:"+JSON.stringify(app.userInfo()))
			// 信息整合
			var param = {
				meetingId: listData.guid,
				prjCode: listData.prjCode,
				unitFullname: app.userInfo().companyName,
				attendancePerson: app.userInfo().realname,
				signerSSignature: app.userInfo().realname,
				attendanceTime: getToday(),
                attdancePersonId: app.userInfo().perId

			}
			
			meetingSignIn(param, function(data){
                // 内部签到：{"success":true,"message":"添加成功！","result":null,"timestamp":1615255604282,"code":200}
                // console.log('内部签到param：'+JSON.stringify(param))
			    // console.log('内部签到：'+JSON.stringify(data))
				if(data.success){
                    app.openPage('./success.html', {
                        titleNView: {
                            titleText: '会议签到',
                            autoBackButton: true,
                            closePage: true,
                        }
                    })
				}else{
			        app.toast("签到异常，请稍后再试")
				}

			})
			
		})

		window.addEventListener('backInspection', function(e) { //执行刷新
			// location.reload();
			getList(pageNo, pageSize);
			getMapList();
			mui('#scroll1').scroll().scrollTo(0, 0, 0);
			mui('#contentList').scroll().scrollTo(0, 0, 0);
		});
	</script>

</html>
