<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>新增安全检查</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<link href="../../../css/mui.min.css" rel="stylesheet" />
		<link href="../../../css/mui.picker.min.css" rel="stylesheet" />
		<link href="../../../css/mui.poppicker.css" rel="stylesheet" />
		<link href="../../../css/common.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../../../css/mui.imageviewer.css" />
		<style>
			.mui-popover {
			height: 300px;
		}
		.mui-content {
			padding: 10px;
		}
		.bar-title{
			font-size: 14px;
			font-weight: 400;
			color: #888888;
		}
		.item-title{
			font-size: 14px;
			font-weight: 400;
			color: #444444;
		}
	.mui-icon-arrowright{
		color:#62666E;
		font-weight: 100 !important;
	}
	.inputCss{
		font-size: 16px;
		font-weight: 400;
		color: #1A1616;
		height: 30px;
	}
	.checkBoxCss{
		font-size: 16px;
		font-weight: 400;
		color: #000000;
	}
	.img_item{
		text-align: left;
		width: 72px;
		height: 100px;
		float: left;
		margin-right: 20px;
		position: relative;
	}
	.img_item .myImgClose{
			position: absolute;
			right: -5px;
			top: -5px;
		}
		.img_item img{
			width: 72px;
			height: 72px;
			border-radius: 5px;
			overflow: hidden;
		}
	.img_item .img_close {
		display: inline-block;
		background-color: #1da1f2;
		color: #FFF;
	}
		.bottom-item-btn {
			height: 100px;
			position: fixed;
			z-index: 999;
			width: 100%;
			background: #f2f2f2;
			bottom: 0px;
			padding-top: 30px;
		}
		.bottom-item-btn .item {
			width: 90%;
			float: left;
			text-align: center;
			padding: 0 14px;
			margin-left: 5%;
		}

		.bottom-item-btn .item div {
			border: 1px solid #337BFB;
			border-radius: 20px;
			height: 40px;
			line-height: 40px;
			font-size: 16px;
		}
		.file-item-box ul li{
			height: 30px;
			line-height: 30px;
			padding: 0;
			margin: 0;

		}
		.mui-table-view:after{ height:0}
		.mui-table-view:before{ height:0}
		.mui-table-view-cell:after{ height:0}
		.mui-table-view-cell:before{ height:0}
		.mui-table-view::-webkit-scrollbar {
			display: none;
		}
		.mui-table-view-cell{
			width: 100%;
			text-align: left;
		}
		.file_upload{
			padding: 3px 0;
			width: 90px;
			background: #337BFC;
			border: 1px solid #337BFC;
			border-radius: 26px;
		}
		.btn-label{
			font-size: 12px;
			font-weight: 400;
			color: #B1B1B1;
			line-height: 14px;
		}
		.file-name{
			width: 85%;
			margin-left: 5px;
			box-sizing: border-box;
			overflow: scroll;
			color: blue;
			float: left;
			white-space: nowrap;
		}
		.file-name{
			display: inline-block;
		}
		.file_close{
			float: right;
		}
		textarea::-webkit-input-placeholder{
		    color:#B1B1B1;
			font-size: 16px;
			font-weight: 400;
		}
	</style>
	</head>

	<body>
		<!--页面主结构开始-->
		<div id="app" class="mui-views">
			<div class="mui-view">
				<div class="mui-navbar">
				</div>
				<div class="mui-pages">
				</div>
			</div>
		</div>
		<div class="bottom-item-btn" id="bottom-item-btn">
			<!-- <div class="item" id="hold">
				<div style="background: #fff;color:#337BFC ;border:1px solid #337BFC">暂存</div>
			</div> -->
			<div class="item" id="submit">
				<div style="background: #337BFC;color: #fff">提交</div>
			</div>
		</div>
		<!--页面主结构结束-->
		<!--单页面开始-->
		<div id="mui-content" class="mui-page paish">
			<!--页面标题栏开始-->
			<!-- <header class="mui-bar mui-bar-nav common-header">
        <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
        <h1 class="mui-title">排水户登记</h1>
    </header> -->
			<!--页面标题栏结束-->
			<!--页面主内容区开始-->
			<div class="mui-page-content">
				<div id="scroll-content" class="mui-scroll-wrapper" style="margin-bottom: 100px;">
					<div class="mui-scroll">
						<div class="scroll-li" style="padding-bottom: 20px;">
							<div class="info-bar-content">
								<div class="info-bar-content-item">
									<div class="item-title">
										项目名称<span style="color: red;margin-left: 3px;">*</span>
									</div>
									<div class="mui-input-row item-input">
										<input id="projectId" required="true" readonly="true" type="text" class="inputCss" value="" placeholder="请输入项目id"
										 maxlength="100" style="display: none;">
										<input id="projectName" required="true" readonly="true" type="text" class="inputCss" value="" placeholder="请输入项目名称"
										 maxlength="100">
									</div>
								</div>
								<div class="info-bar-content-item">
									<div class="item-title">
										项目编号
									</div>
									<div class="mui-input-row item-input">
										<input id="projectNo" readonly="true" type="text" class="inputCss" value="" placeholder="自动填充" maxlength="500">
									</div>
								</div>
								<div class="info-bar-content-item isShow">
									<div class="item-title">
										检查项
										<span style="color: red;margin-left: 3px;">*</span>
									</div>
									<input id="checkItem" type="text" style="display: none;">
									<div class="mui-input-row item-input">
										<input id="checkItemName" readonly="readonly" required="true" type="text" value="" placeholder="请选择检查项" class="inputCss"
										 style="width:90%;">
										<span class="mui-icon mui-icon-arrowright"></sapn>
									</div>
								</div>
								<div class="info-bar-content-item isShow">
									<div class="item-title">
										检查日期
										<span style="color: red;margin-left: 3px;">*</span>
									</div>
									<div class="mui-input-row item-input">
										<input id="checkTime" class="inputCss" required="true" readonly="readonly" type="text" class="mui-input-clear"
										 placeholder="请选择检查日期" style="width: 90%;">
										<img src="../../../img/commom/time.png" style="width: 20px;height: 20px;float: right;margin-top: 8px;">
									</div>
								</div>
							</div>
							<div class="info-bar-content-item" style="height: 120px;border:none">
								<div class="item-title">
									问题描述
								</div>
								<div class="mui-input-row item-input">
									<textarea id="problems" type="text" maxlength="2000" rows="2" onkeyup="format_textarea(this)" placeholder="请输入问题描述,不超过2000字"
									 style="border:none;padding-left: 0;width: calc(100% - 25px);"></textarea>
									<span class="mui-icon mui-icon-closeempty" id="clear" style="position: relative;top: -50px;line-height:16px;width:16px;height:16px;font-size: 16px; color:#FFFFFF;border-radius: 50%;background:#999999;display: none;"></span>
								</div>
							</div>

							<div id="" style="background-color:#F4F4F4;height: 5px;border: none;">

								<div class="info-bar-content-item" style="height: 134px;">
									<div class="item-title" style="margin-bottom: 10px;">
										检查照片<span style="color: red;margin-left: 3px;">*</span>
									</div>
									<input id="pshPhotoInput" style="display: none;" />
									<div class="psh_img_list">
										<!-- 底下已经控制数据 -->
										<!-- <div class="img_item">
											<img class="img_src" src="../../img/commom/pz@2x.png" style="" />
											<div class="img_close">移除</div>
										</div>
										<div class="img_item">
											<img class="img_src" src="../../img/commom/pz@2x.png" style="" />
											<div class="img_close">移除</div>
										</div> -->
									</div>
									<div id="psh_photo" class="img_item">
										<img class="img_src" src="../../../img/commom/pz@2x.png" style="" />
									</div>
								</div>
								<div class="info-bar-content-item">
									<div class="item-title">
										检查人
									</div>
									<div class="mui-input-row item-input">
										<input id="inputFullname" type="text" class="inputCss" readonly="true" value="" placeholder="请输入检查人">
									</div>
								</div>
								<div class="info-bar-content-item">
									<div class="item-title">
										联系方式
									</div>
									<div class="mui-input-row item-input">
										<input id="inputPhone" readonly="true" type="text" class="inputCss" value="" placeholder="请输入联系方式">
									</div>
								</div>
								<div class="info-bar-content-item">
									<div class="item-title">
										填写部门
									</div>
									<div class="mui-input-row item-input">
										<input id="inputDepartmentFullname" readonly="true" type="text" class="inputCss" value="" placeholder="请输入填写部门">
									</div>
								</div>
								<div class="info-bar-content-item" style="border: none;">
									<div class="item-title">
										填写日期
									</div>
									<div class="mui-input-row item-input">
										<input id="inputDate" class="inputCss" type="text" readonly="true" placeholder="请选择填写日期" style="width: 90%;">
										<img src="../../../img/commom/time.png" style="width:16px;height:16px"></img>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!--页面主内容区结束-->
		</div>

	</body>
	<script src="../../../js/mui.min.js"></script>
	<script src="../../../js/mui.view.js"></script>
	<script src="../../../js/mui.locker.js"></script>
	<script src="../../../js/mui.picker.min.js"></script>
	<script src="../../../js/mui.picker.js"></script>
	<script src="../../../js/mui.poppicker.js"></script>

	<script src="../../../js/app.js"></script>
	<script src="../../../js/config.js"></script>
	<script src="../../../js/jquery.min.js"></script>
	<script src="../../../js/common.js"></script>
	<script src="../../../js/security.js"></script>
	<script src="../../../js/helper.js"></script>
	<script src="../../../js/uploadimage.js"></script>
	<script src="../../../js/s4.js"></script>
	<script src="../../../js/smutils.js"></script>
	<script src="../../../js/byte&string.js"></script>
	<script src="../../../js/ajaxhook.min.js"></script>
	<script src="../../../js/mui.zoom.js"></script>
	<script src="../../../js/mui.previewimage.js"></script>

	<!-- <script src="../../../js/vconsole.min.js"></script> -->
	<script>
		// var vConsole = new VConsole();

		mui.init({swipeBack:false});
		//初始化单页view
		var viewApi = mui('#app').view({
			defaultPage: '#mui-content'
		});
		var self;
		var strAttachment = [{
			groupId: "",
			fileTokens: "",
			fieldName: "checkPhoto",
			tableName: "SAFETY_CHECK"
		}]
		//初始化单页的区域滚动
		mui('.mui-scroll-wrapper').scroll();
		var userPicker = new mui.PopPicker();
		mui.plusReady(function() {

			initView()
			// 点击事件
			initDownSelect();
			//获取暂存信息
			// showData()

			var originalHeight = document.documentElement.clientHeight || document.body.clientHeight;
			window.onresize = function() {
				var resizeHeight = document.documentElement.clientHeight || document.body.clientHeight;
				//软键盘弹起与隐藏  都会引起窗口的高度发生变化
				if (resizeHeight * 1 < originalHeight * 1) { //resizeHeight<originalHeight证明窗口被挤压了
					// plus.webview.currentWebview().setStyle({
					// 	height: originalHeight + 75
					// });
					$("#scroll-content").css("margin","0")
					$("#bottom-item-btn").hide()
				}else{
					$("#scroll-content").css("margin-bottom","100px")
					$("#bottom-item-btn").show()
				}
			}
		});

		//界面元素控制
		var initView = function() {
			self = plus.webview.currentWebview();
			var date = new Date();
			var now = date.getFullYear() + "-" + (date.getMonth() + 1) + '-' + date.getDate()

			$("#projectId").val(self.projectId);
			$("#projectName").val(self.projectName);
			$("#projectNo").val(self.projectNo);
			$("#inputDate").val(now);
			$("#inputFullname").val(isEmp(app.userInfo().realname));
			$("#inputPhone").val(isEmp(app.userInfo().personMobilePhone));
			$("#inputDepartmentFullname").val(isEmp(app.userInfo().companyName) + "." + isEmp(app.userInfo().departName));


			//日期选择
			$("#checkTime").on("tap", function() {
				var that = $(this);
				plusDate(function(data) {
					that.val(data);
				});
			})

		}
		//拍照
		$("#psh_photo").on("tap", function() {
			plusSelectImage(function(data, path) {
				console.log(JSON.stringify(data))
				if (data.success) {
					strAttachment[0].fileTokens = data.result.fileTokens;
					var html = '<div id="' + data.result.uploadFile.id + '" data-token="' + data.result.fileTokens +
						'" class="img_item">' +
						'		<img class="img_src imgCss" data-preview-src="" data-preview-group="1" src="' + path + '" style=""  />' +
						'<span class=" myImgClose mui-icon mui-icon-closeempty" style="    font-size: 16px;color: #888888;background: #E7E7E7;border-radius: 50%;"></span>'+
						'	</div>';
					$(".psh_img_list").append(html);

					var count = $(".psh_img_list").children(".img_item").length;
					if (count == 1) { //处理上传的数量
						$("#psh_photo").hide();
					}
				} else app.toast(data.message)
			});
		});
		//删除图
		$(document).on("tap", ".myImgClose", function() {
			var that = $(this)
			mui.confirm("移除图片?", "提示", ['确定', '取消'], function(result) {
				if (parseInt(result.index) == 0) {
					that.parent().remove();
					strAttachment[0].fileTokens = '';
					var count = $(".psh_img_list").children(".img_item").length;
					if (count < 1) {
						$("#psh_photo").show();
					}
				}
			})
		});

		//图片预览
		$(document).on('tap', '.img_src', function() {
			mui.previewImage();
		});


		// 点击事件
		var initDownSelect = function() {
			// 检查项
			$("#checkItemName").on("tap", function() {
				var extras = {
					multiSelect: false,
					type: 1
				}
				app.openPage("../../commom/checkItem.html", {
					titleNView: {
						titleText: '选择检查项',
						autoBackButton: true
					}
				}, extras);
				//移除
				window.removeEventListener('returnSelect', checkItemBack, false);
				// 赋值
				window.addEventListener('returnSelect', checkItemBack, false);

			})

			//检查项回调
			var checkItemBack = function(data) {
				if (data.detail[0] != undefined) {
					console.log(JSON.stringify(data.detail[0]))
					$("#checkItemName").val(data.detail[0].title)
					$("#checkItem").val(data.detail[0].value)
				}
				//移除
				window.removeEventListener('returnSelect', checkItemBack, false);
			}
		}

		//清空textarea
		$("#clear").on("tap", function(event) {
			$("#problems").val("");
			$(this).hide()
		});

		//暂存
		$("#hold").on("tap", function(event) {
			app.toast("开发中")
			// app.toast("暂存成功")
			// mui.fire(plus.webview.currentWebview().opener(), 'reload1');
			// app.openPage("../submitted.html", {
			// 	titleNView: {
			// 		titleText: '暂存安全检查成功',
			// 		autoBackButton: true,
			// 	}
			// });
		});


		//提交
		$("#submit").on("tap", function(event) {
			if (validateRequiredFields()) {
				if (strAttachment[0].fileTokens == '') {
					app.toast("请上传检查照片")
					return;
				}
				var formData = saveCheckForm();
				console.log(JSON.stringify(formData))
				addCheckForm(formData, function(data) {
					if (data.success) {
						app.toast("新增成功");
						mui.fire(plus.webview.currentWebview().opener(), 'reload1');
						app.openPage("../submitted.html", {
							titleNView: {
								titleText: '新增安全检查成功',
								autoBackButton: true,
							}
						});
					} else app.toast("新增失败");
				});
			}
		});
		//重新加载
		var reloadAddress = function(data) {
			window.location.reload();
		}

		//组装表单
		function saveCheckForm() {
			var formData = {};
			formData.projectName = $("#projectName").val();
			formData.prjCode = self.prjCode;
			formData.projectNumber = self.projectNo;
			formData.projectId = $("#projectId").val();
			formData.checkItem = $("#checkItem").val();
			formData.checkItemName = $("#checkItemName").val();
			formData.checkTime = (new Date($("#checkTime").val())).Format("yyyy-MM-dd hh:mm:ss");
			formData.checkPhoto = guid();
			formData.inputName = app.userInfo().personName;
			formData.inputDepartment = app.userInfo().personDepartmentId;
			formData.inputFullname = $("#inputFullname").val();
			formData.inputPhone = $("#inputPhone").val();
			formData.inputDepartmentFullname = $("#inputDepartmentFullname").val();
			formData.inputDate = (new Date()).Format("yyyy-MM-dd hh:mm:ss");
			formData.problems = $("#problems").val();
			strAttachment[0].groupId = formData.checkPhoto;
			formData.strAttachment = JSON.stringify(strAttachment);
			return formData;
		}


		// 对Date的扩展，将 Date 转化为指定格式的String
		// 月(M)、日(d)、小时(h)、分(m)、秒(s)、季度(q) 可以用 1-2 个占位符，
		// 年(y)可以用 1-4 个占位符，毫秒(S)只能用 1 个占位符(是 1-3 位的数字)
		// 例子：
		// (new Date()).Format("yyyy-MM-dd hh:mm:ss.S") ==> 2006-07-02 08:09:04.423
		// (new Date()).Format("yyyy-M-d h:m:s.S") ==> 2006-7-2 8:9:4.18

		Date.prototype.Format = function(fmt) { // author: meizz
			var o = {
				"M+": this.getMonth() + 1, // 月份
				"d+": this.getDate(), // 日
				"h+": this.getHours(), // 小时
				"m+": this.getMinutes(), // 分
				"s+": this.getSeconds(), // 秒
				"q+": Math.floor((this.getMonth() + 3) / 3), // 季度
				"S": this.getMilliseconds() // 毫秒
			};
			if (/(y+)/.test(fmt))
				fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
			for (var k in o)
				if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" +
					o[k]).substr(("" + o[k]).length)));
			return fmt;
		}

		function format_textarea(obj) {
			if (/^\s+$/gi.test(obj.value)) {
				obj.value = '';
			}
			if (obj.value.length > 0) {
				$("#clear").show();
				if (obj.value.length >= 2000) {
					obj.value = obj.value.slice(0, 2000);
					app.toast("问题描述不可大于2000个字！")
				}
			} else $("#clear").hide();
		}
	</script>

</html>
