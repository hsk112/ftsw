<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>新增安全检查表单</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <link href="../../../css/mui.min.css" rel="stylesheet"/>
  <link href="../../../css/mui.picker.min.css" rel="stylesheet"/>
  <link href="../../../css/mui.poppicker.css" rel="stylesheet"/>
  <link href="../../../css/common.css" rel="stylesheet"/>
  <link href="../../../css/ps.css" rel="stylesheet"/>
  <link rel="stylesheet" type="text/css" href="../../../css/mui.imageviewer.css"/>


  <link href="http://gd.wiseom.cn/supermap/iclient-mapboxgl.min.css" rel="stylesheet"/>
  <link href="http://gd.wiseom.cn/supermap/mapbox-gl-enhance.css" rel="stylesheet"/>

  <style>
    .mui-icon-arrowright {
      color: #62666E;
      font-weight: 100 !important;
      width: 16px;
      padding-top: 7px;
    }

    .content {
      overflow: hidden;
      height: calc(100vh - 100px);
    }

    .mui-table-view:before {
      height: 0;
      background-color: #FFFFFF;
    }

    .mui-table-view:after {
      height: 0;
      background-color: #FFFFFF;
    }

    .info-bar-content-item {
      font-size: 14px;
      padding: 10px 0;
      margin: 0 20px;
    }

    .info-bar-content-item .item-title {
      text-align: left;
      color: #888888;
      padding: 0;
      margin: auto 0;
    }

    .info-bar-content-item .item-input {
      text-align: right;
      color: #161515;
      padding-right: 0;
    }

    .mui-checkbox.mui-left label {
      font-size: 14px;
    }

    .page-bottom {
      display: flex;
      padding: 0 20px;
      height: 100px;
      background-color: white;

    }

    .page-bottom button {
      flex: 1;
      margin-top: 30px;
      border-radius: 5px;
      border-color: #0493F3;
      font-size: 16px;
      height: 40px;
      border-width: thin;
    }

    .btn-temp-save {
      color: #0493F3;
      background-color: #FFFFFF;
      margin-right: 15px;
    }

    .btn-agree {
      color: #FFFFFF;
      background-color: #0493F3;
      border: none;
    }

    .img-right-arrow {
      width: 7px;
      height: 12px;
      margin-left: 5px;
    }

    .bor {
      border: 1px dashed #E0E0E0;
      margin-top: 10px;
      border-radius: 5px;
    }

    .paish .mui-checkbox.mui-left label, .mui-radio.mui-left label {
      padding: 11px 0;
      width: 35px;
      text-align: right;
    }

    .mui-checkbox input[type=checkbox]:before, .mui-radio input[type=radio]:before {
      color: #0493F3;
      font-size: 22px;
    }

    /*		单选框*/
     
    .radio-item {
      width: 50%;
    }

    .radio_inline label {
      /*width: 20%;*/
      /*padding-left: 40px;*/
      /*padding-right: 20px;*/
      padding: 0;
      width: 40px;
      height: 22px;
      margin-left: 20px;
      font-size: 16px;
    }

    .radio_inline input[type=radio] {
      width: 15%;
      right: auto;
    }

    /*//换个样式*/
    .change {
      display: flex;
      align-items: center;
    }

    .change .mui-radio input[type='radio']:checked:before {
      content: '\e442';
      color: #0493F3;
      font-size: 22px;
    }

    .mui-radio input[type=radio] {
      top: 0;
    }

    .clear-red-star {
      margin-left: 16px;
    }


    .file_item {
      text-align: left;
      display: flex;
      align-items: center;
    }

    .mui-btn-blue, .mui-btn-primary, input[type=submit] {
      color: #007aff;
      border: 1px solid #fff;
      background-color: #fff;
    }

  </style>
</head>
<body style="margin: 0;">
<!--页面主结构开始-->
<div id="app" class="mui-views">
  <div class="mui-view">
    <div class="mui-navbar">
    </div>
    <div class="mui-pages">
    </div>
  </div>
</div>
<!--页面主结构结束-->
<!--单页面开始-->
<div id="mui-content" class="mui-page ps" style="background-color: #ffffff;">
  <div id="scroll-wrapper-home" style="height: calc(100vh - 65px);">
    <div class="info-bar-content">

      <div class="info-bar-content-item">
        <div class="item-title">
          <span>*</span>项目名称：
        </div>
        <div class="mui-input-row item-input">
          <input id="projectName" required="true" placeholder="项目名称"/>
        </div>
      </div>


      <div class="info-bar-content-item">
        <div class="item-title">
          <span style="color: white">*</span>项目编号：
        </div>
        <div class="mui-input-row item-input">
          <span id="pjNum">自动填充</span>
        </div>
      </div>

      <div class="info-bar-content-item">
        <div class="item-title">
          <span>*</span>检查项：
        </div>
        <div id="correlationForm" class="mui-input-row item-input">
          <span id="checkItemName">请选择检查项</span>
          <img src="../../../img/arrow-right-gray.png" class="img-right-arrow"/>
        </div>
      </div>


      <div class="info-bar-content-item">
        <div class="item-title">
          <span>*</span>检查日期：
        </div>
        <div class="mui-input-row item-input">
          <span id="checkTime">请选择日期</span>
          <img id="processingDemandsImg" src="../../../img/cal.png"
               style="width: 16px;height: 16px;margin: auto 0px auto 5px"/>
        </div>
      </div>



      <div class="info-bar-content-item">
        <div class="item-title">
          <span style="color: white">*</span>问题描述：
        </div>
      </div>
      <div class="info-bar-content-item">
        <textarea placeholder="请输入问题描述（200字以内）" required="true" maxlength="200"
                  style="min-height: 100px;text-align: start;border: none;color: #191515;font-size: 14px;padding: 15px 0" id="problemDesc"></textarea>
      </div>




      <div class="info-bar-content-item">
        <div class="item-title">
          <span>*</span>检查照片：
        </div>
        <div class="bor" style="text-align: right">
          <div id="updateManagePhoto" style="display: flex;flex-direction: column;padding: 10px">
            <img src="../../../img/add-img@2x.png" style="width: 20px;height: 20px;margin: 8px auto 10px auto">
            <span id="up" style="color: #0493F3;font-size: 18px;text-align: center;margin-bottom: 8px">上传图片</span>
          </div>
          <img id="managePhoto" class="arrow-down-img" alt="1" src=""
               style="display: none;width: 80px">
          <!--          <img class="arrow-down-img" alt="1" src="../../../img/problemImg.png">-->
        </div>
      </div>


      <div class="info-bar-content-item">
        <div class="item-title">
          <span style="color: white">*</span>填写人：
        </div>
        <div class="mui-input-row item-input">
          <span id="inputFullname">自动填充</span>
        </div>
      </div>
      <div class="info-bar-content-item">
        <div class="item-title">
          <span style="color: white">*</span>联系方式：
        </div>
        <div class="mui-input-row item-input">
          <span id="inputPhone">自动填充</span>
        </div>
      </div>
      <div class="info-bar-content-item">
        <div class="item-title">
          <span style="color: white">*</span>填写部门：
        </div>
        <div class="mui-input-row item-input">
          <span id="inputDepartmentFullname">自动填充</span>
        </div>
      </div>
      <div class="info-bar-content-item">
        <div class="item-title">
          <span style="color: white">*</span>填写日期：
        </div>
        <div class="mui-input-row item-input">
          <span id="inputDate">自动填充</span>
        </div>
      </div>





      <div class="page-bottom">
        <button class="btn-agree">提交</button>
      </div>
    </div>
    <!--    </div>-->
    <!--    </div>-->
  </div>
</div>

</body>

<!--<script src="../../../js/mui.previewimage.js"></script>-->
<!--<script src="../../../js/numberBox.js"></script>-->
<script src="../../../js/vconsole.min.js"></script>
<script src="../../../js/mui.min.js"></script>
<script src="../../../js/mui.view.js"></script>
<script src="../../../js/mui.locker.js"></script>
<script src="../../../js/mui.picker.min.js"></script>
<script src="../../../js/mui.picker.js"></script>
<script src="../../../js/mui.poppicker.js"></script>

<script src="../../../js/app.js"></script>
<script src="../../../js/config.js"></script>
<script src="../../../js/jquery.min.js"></script>
<script src="../../../js/common.js"></script>
<script src="../../../js/helper.js"></script>
<script src="../../../js/uploadimage.js"></script>
<script src="../../../js/s4.js"></script>
<script src="../../../js/smutils.js"></script>
<script src="../../../js/byte&string.js"></script>
<script src="../../../js/ajaxhook.min.js"></script>
<script src="../../../js/mui.zoom.js"></script>
<script src="../../../js/bscroll.js"></script>
<script src="../../../js/workSpace/addNormalFormItem.js"></script>
<script src="../../../js/conservation.js"></script>
<script src="../../../js/inspection/dailyInspection.js"></script>

<script type="text/javascript" src="http://gd.wiseom.cn/supermap/mapbox-gl-enhance.js"></script>
<script type="text/javascript" src="http://gd.wiseom.cn/supermap/iclient-mapboxgl.min.js"></script>
<script type="text/javascript" src="http://gd.wiseom.cn/mobile-lib/mobile-lib.umd.js"></script>
<script>
    // var vConsole = new VConsole();

  



    //初始化单页view
    var viewApi = mui('#app').view({
        defaultPage: '#mui-content'
    });

    var userPicker = new mui.PopPicker();

    var mask = mui.createMask(function () {
        return mask.clickClose;
    });

    let param = {
      guid: "",
    }

    let postParam = {
      prjCode: '',
      projectId: '',
      projectName: '',
      projectNumber: '',
      checkItem:'',
      checkTime:'',
      problems:'',
      checkPhoto:'',
      inputFullname:'',
      inputPhone:'',
      inputDepartmentFullname:'',
      inputDepartment:'',
      inputDate:'',
      checkItemName:'',
      strAttachment:''
    }

    let MissionParam ={
      projectId: ''
    }
															
    console.log("plusReady==========================================================");
    mui.plusReady(function () {

      var self = plus.webview.currentWebview();
      projectInfo=JSON.parse(localStorage.getItem("projectInfo"))
      postParam.prjCode = projectInfo.prjCode
      postParam.projectId = projectInfo.prjId
      postParam.projectName = projectInfo.prjName
      postParam.inputFullname = app.userInfo().personName
      postParam.inputPhone = app.userInfo().personMobilePhone
      postParam.inputDepartmentFullname = app.userInfo().companyName
      postParam.inputDate = getNowFormatDate()


      $('#projectName').val(projectInfo.prjName)
      $('#inputFullname').text(app.userInfo().personName)
      $('#inputDepartmentFullname').text(app.userInfo().companyName)
      $('#inputPhone').text(app.userInfo().personMobilePhone)
      $('#inputDate').text(getYMD())
      MissionParam.projectId = projectInfo.prjId
      setMissionDetail(MissionParam);

        mui('.mui-scroll-wrapper').scroll({
            scrollY: true, //是否竖向滚动
            scrollX: false, //是否横向滚动
            startX: 0, //初始化时滚动至x
            startY: 0, //初始化时滚动至y
            indicators: true, //是否显示滚动条
            deceleration: 0.0006, //阻尼系数,系数越小滑动越灵敏
            bounce: true //是否启用回弹
        });
       

    });


    //获取当前时间
    function getNowFormatDate() {
      var date = new Date();
      var seperator1 = "-";
      var seperator2 = ":";
      var month = date.getMonth() + 1;
      var strDate = date.getDate();
      var hour = date.getHours()
      var m = date.getMinutes()
      var s = date.getSeconds()
      if (month >= 1 && month <= 9) {
        month = "0" + month;
      }
      if (strDate >= 0 && strDate <= 9) {
        strDate = "0" + strDate;
      }
      if (hour >= 0 && hour <= 9) {
        hour = "0" + hour;
      }
      if (m >= 0 && m <= 9) {
        m = "0" + m;
      }
      if (s >= 0 && s <= 9) {
        s = "0" + s;
      }

      var currentdate = date.getFullYear() + seperator1 + month + seperator1 + strDate
              + " " + hour + seperator2 + m
              + seperator2 + s;
      return currentdate;
    }

    function getYMD(){
      var date = new Date();
      var seperator1 = "-";
      var seperator2 = ":";
      var month = date.getMonth() + 1;
      var strDate = date.getDate();
      if (month >= 1 && month <= 9) {
        month = "0" + month;
      }
      if (strDate >= 0 && strDate <= 9) {
        strDate = "0" + strDate;
      }
      var currentdate = date.getFullYear() + seperator1 + month + seperator1 + strDate
      return currentdate;
    }

    function getHMS(){
      var date = new Date();
      var seperator1 = "-";
      var seperator2 = ":";
      var month = date.getMonth() + 1;
      var strDate = date.getDate();
      var hour = date.getHours()
      var m = date.getMinutes()
      var s = date.getSeconds()
      if (month >= 1 && month <= 9) {
        month = "0" + month;
      }
      if (strDate >= 0 && strDate <= 9) {
        strDate = "0" + strDate;
      }
      if (hour >= 0 && hour <= 9) {
        hour = "0" + hour;
      }
      if (m >= 0 && m <= 9) {
        m = "0" + m;
      }
      if (s >= 0 && s <= 9) {
        s = "0" + s;
      }

      var currentdate =  hour + seperator2 + m
              + seperator2 + s;
      return currentdate;
    }


    //获取项目编号
    function setMissionDetail(param) {
      console.log(JSON.stringify(param))

      getMissionDetail(param,function (data) {
        $('#pjNum').text(data.result.prjNo)
        postParam.projectNumber = data.result.prjNo
      })
    }

    // 检查项
    $("#checkItemName").on("tap", function() {
      var extras = {
        multiSelect: false,
        type: 1
      }
      app.openPage("../../commom/checkItem.html", {
        titleNView: {
          titleText: '选择检查项',
          autoBackButton: true
        }
      }, extras);
      //移除
      window.removeEventListener('returnSelect', checkItemBack, false);
      // 赋值
      window.addEventListener('returnSelect', checkItemBack, false);

    })

    //检查项回调
    var checkItemBack = function(data) {
      if(data.detail[0] != undefined){
        console.log(JSON.stringify(data.detail[0]))
        $("#checkItemName").text(data.detail[0].title)
        postParam.checkItemName = data.detail[0].title
        postParam.checkItem = data.detail[0].value
      }
      //移除
      window.removeEventListener('returnSelect', checkItemBack, false);
    }


    //照片
    $("#up").on("tap", function() {
      plusSelectImage(function(data, path) {
        console.log(JSON.stringify(data))
        if (data.success) {
          strAttachment[0].fileTokens = data.result.fileTokens;
          var html = '<div id="' + data.result.uploadFile.id + '" data-token="' + data.result.fileTokens +
                  '" class="img_item">' +
                  '		<img class="img_src imgCss" data-preview-src="" data-preview-group="1" src="' + path + '" style=""  />' +
                  '<span class=" myImgClose mui-icon mui-icon-closeempty" style="    font-size: 16px;color: #888888;background: #E7E7E7;border-radius: 50%;"></span>'+
                  '	</div>';
          $(".psh_img_list").append(html);

          var count = $(".psh_img_list").children(".img_item").length;
          if (count == 1) { //处理上传的数量
            $("#psh_photo").hide();
          }
        } else app.toast(data.message)
      });
    });
    //删除图
    $(document).on("tap", ".myImgClose", function() {
      var that = $(this)
      mui.confirm("移除图片?", "提示", ['确定', '取消'], function(result) {
        if (parseInt(result.index) == 0) {
          that.parent().remove();
          strAttachment[0].fileTokens =  '';
          var count = $(".psh_img_list").children(".img_item").length;
          if (count < 1) {
            $("#psh_photo").show();
          }
        }
      })
    });

    //图片预览
    $(document).on('tap', '.img_src', function() {
      mui.previewImage();
    });

    window.addEventListener('touchmove', function (e) {
        var target = e.target;
        if (target && target.className === 'problemTypeItem') {//textarea阻止冒泡
            e.stopPropagation();
        }
    }, true);



    //关闭遮罩层
    function closeMask() {
        console.log('关闭遮罩层' + sharew.id);
        //避免出现特殊情况，确保分享页面在初始化时关闭
        if (!sharew) {
            sharew = plus.webview.getWebviewById("goods/add_to_cart.html");
            console.log(sharew.id);
        }
        if (sharew) {
            sharew.hide('slide-out-bottom', 300);
            //sharew = null;
        }
        var ws = plus.webview.currentWebview();
        console.log('关闭遮罩层' + ws.id);
        ws.setStyle({mask: "none"});
    }

    mask.clickClose = false;

    function maskClose() {
        mask.clickClose = true;
        mask.close();
    }

    function maskShow() {
        mask.clickClose = false;
        mask.show();
    }


    //提交
    $(".btn-agree").on('tap',function () {


      //要优化
      var isTrue = true
      if($('#checkItemName').text()=='请选择检查项'){
          app.toast('请选择检查项')
          isTrue = false
      }else if( $('#checkTime').text()=='请选择日期'){
        app.toast('请选择日期')
        isTrue = false
      }else if(photoParm.groupId==''){
        app.toast('请上传图片')
        isTrue = false
      }


      postParam.checkTime = $('#checkTime').text() + " " +getHMS()
          postParam.problems = $("#problemDesc").val();
          var strAttachment = new Array();
          strAttachment.push(photoParm);
          postParam.strAttachment = JSON.stringify(strAttachment);

          console.log(JSON.stringify(postParam))

      if(photoParm.groupId==''){
        app.toast('请上传图片')
        isTrue = false
      }

      if (isTrue) {
        addSafetyInspectionForm(postParam, function (data) {
          if (data.success) {
            app.toast("提交成功")
            mui.back()
          } else {
            app.toast("提交失败")
          }
        });
      }


    })

    //必填验证
    function validateRequiredFields() {

      var isVali = true;
      $('input[required="true"],textarea[required="true"]').filter(':visible').each(function(i, requiredField) {
        if ($(requiredField).val() == '') {
          app.toast($(requiredField).attr('placeholder'));
          isVali = false;
          return isVali;
        }
      });
      $('input[type="checkbox"][required="true"]').filter(':visible').each(function(i, requiredField) {
        let checkVal = $("input[name='" + $(requiredField).attr('name') + "']:checked").val();
        if (isEmpty(checkVal) || checkVal === undefined) {
          app.toast($(requiredField).attr('placeholder'));
          isVali = false;
          return isVali;
        }
      });
      return isVali;
    }




    var photoParm = {
      groupId: '',
      fileTokens: '',
      fieldName: 'checkPhoto',
      tableName: 'SAFETY_CHECK'
    }

    //整体图片上传（未完成的）
    $("#updateManagePhoto").on("tap", function () {
        // if(tmpBtnStatus=='false'){ return;}
        plusSelectImage(function (data, path) {
            console.log(JSON.stringify(data))
            if (data.success) {
                $("#managePhoto").show();
                $("#updateManagePhoto").hide();
                $("#managePhoto").attr("src", path);
                photoParm.groupId = data.result.uploadFile.id;
                postParam.checkPhoto = data.result.uploadFile.id;
                photoParm.fileTokens = data.result.fileTokens;
                // }
            } else app.toast(data.message)
        });
    });



    // 选择时间
    $('#checkTime').on('tap', function () {
        var that = $(this);
        plusDateWithDate(function (data) {
            var now = data.getFullYear() + "-" + preZero((data.getMonth() + 1), 2) + "-" + preZero(data.getDate(), 2);
            that.text(now);
            $('#processingDemandsImg').hide();
        });
    })


    //子页面添加：

    mui.init({
      beforeback: function() {
        //获得父页面的webview
        var list = plus.webview.currentWebview().opener();
        //触发父页面的自定义事件(refresh),从而进行刷新
        mui.fire(list, 'refresh');
        //返回true,继续页面关闭逻辑
        return true;
      }
    });


</script>
</html>
