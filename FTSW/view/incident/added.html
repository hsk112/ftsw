
<!DOCTYPE html>
<html>
 
<head>
	<meta charset="utf-8">
	<title>新增事件</title>
	<meta name="viewport"
		content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
 
	<link href="../../css/mui.min.css" rel="stylesheet" />
	<link href="../../css/common.css" rel="stylesheet" />
	<link rel="stylesheet" href="../../css/incidents/added.css">
	<link rel="stylesheet" href="../../css/mui.picker.css">
	<link rel="stylesheet" href="../../css/mui.poppicker.css">
	<link href="../../css/mui.picker.min.css" rel="stylesheet" />
	<link href="http://gd.wiseom.cn/supermap/iclient-mapboxgl.min.css" rel="stylesheet" />
	<link href="http://gd.wiseom.cn/supermap/mapbox-gl-enhance.css" rel="stylesheet" />
	<style>
		.mui-input-group {
			padding: 0 20px;
		}
 
		.info-bar-content-item {
			display: flex;
			justify-content: space-between;
			align-items: center;
			height: 55px;
			margin: 0;
		}
      /*  1*/
		.info-bar-content-item .item-title {
			width: 120px;
			color: #262626;
			font-size: 16px;
			padding: 0;
		}
 
 
		.info-bar-content-item .item-input input {
			text-align: right;
			font-size: 16px;
			/*width: 80%;*/
			/*padding-right: 32px;*/
 
		}
 
 
		.mui-input-row {
			height: 30px;
			text-align: right;
			border-bottom: 1px solid #EDEDED;
 
		}
 
		.mui-input-row label {
			width: auto !important;
 
 
		}
 
		input[type=text] {
			height: 30px;
		}
 
		.clear-red-star {
			margin-left: 16px;
		}
 
		.red-star {
			color: red;
			margin-left: 3px;
			margin-right: 5px;
		}
 
		.mui-numbox [class*=numbox-btn] {
			width: 0;
		}
 
		.mui-numbox .mui-numbox-input {
			text-align: right;
			border: none !important;
 
			/*border-right: none !important;*/
		}
 
		.right-input-date {
			display: flex;
			align-items: center;
		}
 
		.right-input-date .inputCss {
			width: 90%;
			height: 20px;
			margin-bottom: 0;
			margin-right: 5px;
		}
 
		.right-input-date img {
			width: 16px;
			height: 16px;
		}
 
		/* 表单 */
		.mui-input-group {
			padding: 0 20px;
		}
 
		.mui-input-group:before {
			position: absolute;
			top: 0;
			right: 0;
			left: 0;
			height: 1px;
			content: '';
			-webkit-transform: scaleY(.5);
			transform: scaleY(.5);
			background-color: transparent;
		}
 
		.mui-input-group .mui-input-row:after {
			position: absolute;
			right: 0;
			bottom: 0;
			left: 15px;
			height: 1px;
			content: '';
			-webkit-transform: scaleY(.5);
			transform: scaleY(.5);
			background-color: transparent;
		}
 
		.mui-input-row label {
			font-family: 'Helvetica Neue', Helvetica, sans-serif;
			line-height: 1;
			float: none;
			width: 100%;
			padding: 0;
		}
 
		/* 事件弹框样式 */
		.mui-input-row .mui-btn {
			line-height: 1;
			float: none;
			width: 100%;
			padding: 0;
			font-size: 16px;
			
		}
 
		.mui-btn-block {
			font-size: 17px;
			display: block;
			width: 100%;
			margin-bottom: 0px;
			padding: 0;
			text-align: right;
		}
 
 
 
		/* input框 */
		.mui-input-row label~input {
			text-align: right;
			padding: 0;
			width: 100%;
			font-size: 16px;
			/* color: #B1B1B1; */
		}
 
		/* 日期弹出框样式 */
		.mui-dtpicker-header {
			display: flex;
			justify-content: space-around;
		}
 
		/*  */
		.info-bar-content-item {
			font-size: 14px;
			/* padding: 10px 0; */
			/* margin: 0 20px; */
		}
 
		.info-bar-content-item .item-title {
			text-align: left;
			color: #262626;
			padding: 0;
			margin: auto 0;
		}
 
		.info-bar-content-item .item-input {
			text-align: right;
			color: #161515;
			padding-right: 0;
		}
 
		.mui-checkbox.mui-left label {
			font-size: 14px;
		}
 
		.page-bottom {
			display: flex;
			padding: 0 20px;
			height: 100px;
			background-color: white;
 
		}
 
		.page-bottom button {
			flex: 1;
			margin-top: 30px;
			border-radius: 5px;
			border-color: #0493F3;
			font-size: 16px;
			height: 40px;
			border-width: thin;
		}
 
		.btn-temp-save {
			color: #0493F3;
			background-color: #FFFFFF;
			margin-right: 15px;
		}
 
		.btn-agree {
			color: #FFFFFF;
			background-color: #0493F3;
			border: none;
		}
 
		.img-right-arrow {
			width: 7px;
			height: 12px;
			margin-left: 5px;
		}
 
		.uplode {
			/* border: 1px dashed #E0E0E0; */
			/* display: flex; */
			/* flex: ; */
			/* margin-top: 10px;
			border-radius: 5px; */
		}
 
		.paish .mui-checkbox.mui-left label,
		.mui-radio.mui-left label {
			padding: 11px 0;
			width: 35px;
			text-align: right;
		}
 
		.mui-checkbox input[type=checkbox]:before,
		.mui-radio input[type=radio]:before {
			color: #0493F3;
			font-size: 22px;
		}
 
		/*		单选框*/
 
		.radio-item {
			width: 50%;
		}
 
		.radio_inline label {
			/*width: 20%;*/
			/*padding-left: 40px;*/
			/*padding-right: 20px;*/
			padding: 0;
			width: 40px;
			height: 22px;
			margin-left: 26px;
			font-size: 16px;
		}
 
		.radio_inline input[type=radio] {
			/* width: 15%; */
			right: auto;
		}
 
		/*//换个样式*/
		.change {
			display: flex;
			align-items: center;
		}
 
		.change .mui-radio input[type='radio']:checked:before {
			content: '\e442';
			color: #0493F3;
			font-size: 22px;
		}
 
		.mui-radio input[type=radio] {
			top: 0;
		}
 
		.mui-checkbox input[type=checkbox],
		.mui-radio input[type=radio] {
			width: 20px !important;
		}
	</style>
</head>
 
<body>
	<!--页面主结构开始-->
	<div id="app" class="mui-views">
		<div class="mui-view">
			<div class="mui-navbar">
 
			</div>
			<div class="mui-pages">
			</div>
		</div>
	</div>
	<!--页面主结构结束-->
	<!--单页面开始-->
	<div id="mui-content" class="mui-page">
		
		<!--页面主内容区开始-->
		<div class="mui-input-group">
			<div class="mui-input-row">
				<label class="themeT " id="eventname">事件名称</label>
				<input class="iptOne" type="text" placeholder="请输入事件名称" value="">
			</div>
			<div class="mui-input-row">
				<label class="themeT">事件编号</label>
				<input type="text"  id="eventnumber" disabled class="eventbh" placeholder="自动回填">
			</div>
			<div class="mui-input-row displayflex">
				<label class="themeT">事件来源</label>
				<input type="text" class="input-right formSource eventSour" placeholder="请选择事件来源 >" required="required">
 
			</div>
			
			<div class="mui-input-row displayflex" id="data_time" style="display: flex;">
				<label class="lebals themeT">发生日期</label>
				<div class="xuanze" style="display: flex;align-items: center;">
					<input type="text" readonly="readonly" class="mui-input-clear recordInp dateSelect" id="eventtime"
						style="border: none; text-align: right;padding: 0;" placeholder="请选择日期" /><img
						src="../../img/commom/time.png" style="width: 16px;height: 16px;margin-left: 6px; "
						 />
				</div>
			</div>
			<div class="mui-input-row displayflex">
				<label class="themeT">天气</label>
				<input type="text" placeholder="请选择天气 >" class="mui-btn mui-btn-block weather" style="color:#000;">
 
			</div>
 
			<div class="mui-input-row tabs">
				<label class=" themeT">事件类型</label>
				<div class="item-checkbox">
					<div class="mui-input-row change">
						<div class="radio_inline mui-radio" style="display: flex;">
							<div class="radio-item">
								<input name="eventType" type="radio" id="initialDesignOne" value="1" class="radios active" data-toggle="tab">
								<label for="initialDesignOne" style="margin-right: 10px;text-align: right">积水</label>
 
								<input name="eventType" type="radio" id="initialDesignTwo" value="2" data-toggle="tab">
								<label for="initialDesignTwo" style="text-align: right">溢流</label>
 
								<input name="eventType" type="radio" id="initialDesigntree" value="3" data-toggle="tab">
								<label for="initialDesigntree" style="text-align: right">冒溢</label>
 
							</div>
						</div>
					</div>
				</div>
			</div>
			
			<div class="menu">
				<div class="tab" style="display: none;">
					<div class="mui-input-row">
						<label class="themeT">所需人数</label>
						<input type="number" class="eventnumber inputOne" placeholder="请输入所需人数">
					</div>
					<div class="mui-input-row">
						<label class="themeT">积水深度(cm)</label>
						<input type="number" placeholder="请输入积水深度" class="floodDepth inputTwo">
					</div>
					<div class="mui-input-row displayflex">
						<label class="themeT">设施编号</label>
						<input type="text" class="mui-btn mui-btn-block  inputTwo facilityNoJ" placeholder="自动回填" readonly="readonly" disabled>
					</div>
				</div>
					
				<div  class="tab" style="display: none;">
					<div class="mui-input-row displayflex">
						<label class="themeT">设施类型</label>
						<input type="text" placeholder="请选择设施类型 >" class="mui-btn mui-btn-block deviceTypeY inputOne" disabled >
					
					</div>
					<div class="mui-input-row displayflex">
						<label class="themeT">设施编号</label>
						<input type="text" class="mui-btn mui-btn-block  inputTwo facilityNoY" placeholder="自动回填" readonly="readonly" disabled>
					</div>
					
				</div>
				
				<div  class="tab" style="display: none;">
					<div class="mui-input-row displayflex">
						<label class="themeT">设施类型</label>
						<input type="text"  class="mui-btn mui-btn-block deviceTypeM inputOne" placeholder="请选择设施类型 >" readonly="readonly">
					</div>
					<div class="mui-input-row displayflex">
						<label class="themeT">设施编号</label>
						<input type="text" class="mui-btn mui-btn-block  inputTwo facilityNoM" placeholder="自动回填" readonly="readonly" disabled>
					</div>
					
				</div>
				
			</div>
			<div class="mui-input-row displayflex timePlace">
				<label class="themeT">事件地点</label>
				<input type="text" placeholder="请选择事件地点" id="searchInput" style="padding-left: 5px;" readonly="readonly" ><img
					src="../../img/local.png" alt="" style=" height: 15px;margin-left: 6.5px;;" id="discoveryAddr"
					class="eventsite inputThree">
			</div>
			
			<div class="mui-input-row">
				<label class="themeTS">上报人</label>
				<input type="text" placeholder="请输入上报人姓名" id="reportRealName">
			</div>
			<div class="mui-input-row">
				<label class="themeTS">上报人联系方式</label>
				<input type="number" placeholder="请输入上报人联系方式" class="reportPersonPhone">
			</div>
 
			<div style="display: flex;align-items: center;
			padding: 10px 0;
			border-bottom: 1px solid #EDEDED;justify-content: space-between;">
 
				<!-- 上传图片 -->
				<div class="item-title ;" style="width: 90px;">
					<span style="color: white; width: 80px;">*</span>上传附件：
				</div>
				<div class="uplode"
					style="text-align: right;width:calc(100% - 90px);display: flex; justify-content: space-between;">
					<div id="tp"  class="qua_img_list img_item"
						style="width: 80px;height: 80px;display: flex; align-items: center;">
					</div>
 
 
					<div id="qs_photo" class="img_item"
						style="display: flex;flex-direction: column; align-items: center; width: 80px;height: 80px;text-align: center;  border: 1px dashed #ccc;">
						<img src="../../img/add-img@2x.png"
							style="width: 10px;height: 10px;margin: 16px auto 10px auto">
						<span id="up" style="color: #0493F3;font-size: 16px;white-space:nowrap;">上传图片</span>
					</div>
 
				</div>
 
			</div>
			<!--  -->
			<div class="mui-input-row tabs">
				<label class=" themeT">是否发送工单至运维负责人</label>
				<div class="item-checkbox">
					<div class="mui-input-row change">
						<div class="radio_inline mui-radio" style="display: flex;">
							<div class="radio-item">
								
 
								<input name="send" type="radio" id="isSend" value="1" data-toggle="tab">
								<label for="initialDesignTwo" style="text-align: right">是</label>
 
								<input name="send" type="radio" id="notSend" value="0" data-toggle="tab">
								<label for="initialDesigntree" style="text-align: right">否</label>
 
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="mui-input-row displayflex problem" style="display: none;">
				<label class="themeT">问题类型</label>
				<input type="text" placeholder="请选择问题类型 >" class="mui-btn mui-btn-block problemType" id ="problemType" style="color:#000;" >
 
			</div>
			<!--  -->
			<div class="mui-input-row displayflex">
				<label class="themeT">运维负责人</label>
				<!-- <input type="text" value="请选择运维负责人 >" id='showUserPicker4' class="mui-btn mui-btn-block"> -->
				<p id='showUserPicker4'>
					<!-- <input type="text"id="approverFullname" placeholder="请选择运维负责人 >" style="padding: 0;"> -->
					<span id="approverFullname" class="dutyUserName">请选择负责人</span>
 
					<!-- <span class="mui-icon mui-icon-arrowright "></span>>号 -->
			</div>
			<div class="mui-input-row displayflex">
				<label class="themeT ">负责人联系方式</label>
				<input type="number" placeholder="负责人联系号码" class="dutyUserPhone">
			</div>
 
 
			<div class="info-bar-content-item mui-input-row">
				<div class="item-title">
					<span style="color: red ;width: 20px; display: inline-block;">*</span>危害程度
				</div>
				<div class="item-checkbox">
					<div class=" change">
						<div class="radio_inline mui-radio" style="display: flex;">
							<div class="radio-item">
								<input name="harmLevel" type="radio" id="radioOne" value="3" class="radios">
								<label for="radioOne" style="margin-right: 10px;text-align: right">高</label>
								<input name="harmLevel" type="radio" id="radioTwo" value="2">
								<label for="radioTwo" style="text-align: right">中</label>
								<input name="harmLevel" type="radio" id="radioTree" value="1">
								<label for="radioTree" style="text-align: right">低</label>
								<input name="harmLevel" type="radio" id="radiofour" value="0">
								<label for="radiofour" style="text-align: right">待定</label>
							</div>
						</div>
					</div>
				</div>
			</div>
 
			<div class="mui-input-row">
				<label class="themeTS">事件描述</label>
 
			</div>
			<textarea type="text" name="te" id="" cols="30" rows="10" placeholder="请输入事件描述(300字以内)"
				class="eventDescription"></textarea>
			
			<div class="mui-button-row displayflex">
				<div class="btn-item" style="background: #F4F4F4;"></div>
				<div class="inspection_submit"
					style="background: #337BFC;color: #fff;width: 100%;margin: 0 auto;line-height: 40px;margin-bottom: 20px;border-radius: 5px;">提交</div>
			</div>
		</div>
 
 
	<!--页面主内容区结束-->
	</div>
 
</body>
<!-- <script src="../../js/helper.js"></script> -->
<script src="../../js/jquery.min.js"></script>
<script>window.FastClick = true;</script>
<script src="../../js/mui.min.js"></script>
<script src="../../js/mui.view.js"></script>
<script src="../../js/mui.locker.js"></script>
<script src="../../js/common.js"></script>
<script src="../../js/app.js"></script>
<script src="../../js/config.js"></script>
<script src="../../js/maintain.js"></script>
<script src="../../js/uploadimage.js"></script>
<script src="../../js/s4.js"></script>
<script src="../../js/smutils.js"></script>
<script src="../../js/byte&string.js"></script>
<script src="../../js/ajaxhook.min.js"></script>
<script src="../../js/timer.js"></script>
<script src="../../js/vconsole.min.js"></script>
<script src="../../js/incident/incident.js"></script>
<script src="../../js/mui.poppicker.js"></script>
<script src="../../js/mui.picker.min.js"></script>
<script src="../../js/mui.picker.js"></script>
<script src="../../js/workSpace/addNormalFormItem.js"></script>
<script src="../../js/qualityControl/qualityControl.js"></script>
<script type="text/javascript" src="http://gd.wiseom.cn/supermap/mapbox-gl-enhance.js"></script>
<script type="text/javascript" src="http://gd.wiseom.cn/supermap/iclient-mapboxgl.min.js"></script>
<script type="text/javascript" src="http://gd.wiseom.cn/mobile-lib/mobile-lib.umd.js"></script>
<script src="../../js/mui.locker.js"></script>
<script src="../../js/mui.zoom.js"></script>
<script src="../../js/mui.previewimage.js"></script>
<script src="../../js/position.js"></script>

<script>

var vConsole = new VConsole();
$(function ()
{
　　$(".tabbox li").click(function ()
　　{
　　　　//获取点击的元素给其添加样式，讲其兄弟元素的样式移除
　　　　$(this).addClass("active").siblings().removeClass("active");
　　　　//获取选中元素的下标
　　　　var index = $(this).index();
　　　　$(this).parent().siblings().children().eq(index).addClass("active")
　　　　.siblings().removeClass("active");
　　});
});





	// var vConsole = new VConsole();
	
	var date = new Date();
            var year = date.getFullYear();
            var month = date.getMonth() + 1;
            var day = date.getDate();
            if (month < 10) {
                month = "0" + month;
            }
            if (day < 10) {
                day = "0" + day;
            }
            var nowDate = year + "-" + month + "-" + day;
 
	var deviceType1 = -1
	var deviceType2 = -1
	var isSendNum = -1	
	var problemNum = -1	
	var strAttachment = [{
		groupId: '',
		fileTokens: '',
		fieldName: "attachment",
		tableName: "attachment"
	}]
	mui.init({});
	//初始化单页view
	var viewApi = mui('#app').view({
		defaultPage: '#mui-content',
	});
	//初始化单页的区域滚动
	// mui('.mui-scroll-wrapper').scroll();
	// mui.ready(function () {
 
	// });

	var stateText = localStorage.getItem('$state') || "{}";
	stateText = JSON.parse(stateText)
	var date = new Date();
	var year = date.getFullYear();
	var month = date.getMonth() + 1;
	var day = date.getDate();
	var CheckTypeIndex = null
	var weatherNO = null
	if (month < 10) {
		month = "0" + month;
	}
	if (day < 10) {
		day = "0" + day;
	}
	var nowDate = year + "-" + month + "-" + day;
	var arr = []
	var eventTypeObj = {}
	var eventbhV;
	var deviceTypeArr = []
	var deviceDataList 
	var deviceTypeIndex = -1
	mui.plusReady(function(){
		var self = plus.webview.currentWebview()
		var currentDayObj = self.currentDayObj
		var param = {}
		var type = 'get'
		var url = config.urls.baseUrl + config.actions.gatDeviceType
		getProject(url,param,type,function(deviceData){
			if(deviceData.success){
				deviceData = deviceData.result.records
				deviceDataList = deviceData
				for(var i=0;i<deviceDataList.length;i++){
					var obj = {
						value:i,
						text:deviceDataList[i].deviceTypeName
					}
					deviceTypeArr.push(obj)
				}
			}else{
				app.toast('网络异常，请稍后再试')
			}
		})
		for(var i=0;i<currentDayObj.length;i++){
			console.log(currentDayObj[i].occurTime)
			if(currentDayObj[i].occurTime == nowDate){
				arr.push(currentDayObj[i].occurTime)
			}
		}
		console.log('arr='+JSON.stringify(arr))
		if(arr.length == 0 ){
			eventbhV = 'F-SJD-'+ nowDate.substring(0,4) + nowDate.substring(5,7) + nowDate.substring(8,10) +'-'+ '001' 
			
		}else if(arr.length > 0 && arr.length< 10){
			arr.length = arr.length + 1
			eventbhV = 'F-SJD-'+ nowDate.substring(0,4) + nowDate.substring(5,7) + nowDate.substring(8,10) +'-' +'00' + arr.length
		}else if(arr.length >=10 && arr.length<100){
			eventbhV = 'F-SJD-'+ nowDate.substring(0,4) + nowDate.substring(5,7) + nowDate.substring(8,10) +'-' +'0' + arr.length
		}else if(arr.length > 99){
			arr.length = arr.length + 1
			eventbhV = 'F-SJD-'+ nowDate.substring(0,4) + nowDate.substring(5,7) + nowDate.substring(8,10) +'-' + arr.length
		}
		
		$(".eventbh").val(eventbhV)
		if(checkNum == -1){
					$("#searchInput").attr('disabled','desabled')
					
				}
		
	})	
	(function ($, doc) {
		$.init();
		$.ready(function () {
			/**
			 * 获取对象属性的值
			 * 主要用于过滤三级联动中，可能出现的最低级的数据不存在的情况，实际开发中需要注意这一点；
			 * @param {Object} obj 对象
			 * @param {String} param 属性名
			 */
			var _getParam = function (obj, param) {
				return obj[param] || '';
			};
		});
		// 日期控件
	})(mui, document);
	$('#data_time').on('tap', function () {
		console.log('111')
		var dtPicker = new mui.DtPicker({ type: 'date' });
		dtPicker.show(function (selectItems) {
			var y = selectItems.y.text;  //获取选择的年
			var m = selectItems.m.text;  //获取选择的月
			var d = selectItems.d.text;  //获取选择的日
			var date = y + "-" + m + "-" + d;
			console.log(date)
			$(".dateSelect").val(date)
		})
	})
	// 请选择事件来源
	$(".formSource").on("tap", function () {
		var picker = new mui.PopPicker();
		picker.setData([
			{ value: '1', text: '巡检' },
			{ value: '2', text: '投诉' },
			{ value: '3', text: '第三方' }
 
		]);
		picker.show(function (selectItems) {
			$(".formSource").val(selectItems[0].text)
			CheckTypeIndex = selectItems[0].value
		})
	})
	// 请选择问题类型
	$("#problemType").on("tap", function () {
		console.log('???')
		var picker = new mui.PopPicker();
		picker.setData([
			{ value: '0', text: '设备检修' },
			{ value: '1', text: '隐患巡检' },
			{ value: '2', text: '水质报警' },
	        { value: '3', text: '投诉处理' },
	        { value: '6', text: '水务调度' },
		]);
		picker.show(function (selectItems) {
			$("#problemType").val(selectItems[0].text)
			problemNum = selectItems[0].value
		})
	})
	$(".deviceTypeM").on("tap", function () {
		console.log('123')
		var picker = new mui.PopPicker();
		picker.setData(deviceTypeArr);
		picker.show(function (selectItems) {
			$(".deviceTypeM").val(selectItems[0].text)
			deviceTypeIndex = selectItems[0].value
			deviceType2 = deviceDataList[deviceTypeIndex].deviceType
			$("#searchInput").removeAttr('disabled')
			
		})
	})
	// 天气
	$(".weather").on("tap", function () {
		var picker = new mui.PopPicker();
		picker.setData([
			{
				value: '0',
				text: '晴'
			}, {
				value: '1',
				text: '多云'
			}, {
				value: '2',
				text: '阴'
			}, {
				value: '3',
				text: '阵雨'
			}, {
				value: '4',
				text: '雷阵雨'
			}, {
				value: '5',
				text: '雷阵雨伴有冰雹'
			}, {
				value: '6',
				text: '雨夹雪'
			}, {
				value: '7',
				text: '小雨'
			}, {
				value: '8',
				text: '中雨'
			}, {
				value: '9',
				text: '大雨'
			}, {
				value: '10',
				text: '暴雨'
			}, {
				value: '11',
				text: '大暴雨'
			}, {
				value: '12',
				text: '特大暴雨'
			}, {
				value: '13',
				text: '阵雪'
			}, {
				value: '14',
				text: '小雪'
			}, {
				value: '15',
				text: '中雪'
			}, {
				value: '16',
				text: '大雪'
			}, {
				value: '17',
				text: '暴雪'
			}, {
				value: '18',
				text: '雾'
			}, {
				value: '19',
				text: '冻雨'
			}, {
				value: '20',
				text: '沙尘暴'
			}
 
		]);
		picker.show(function (selectItems) {
			$(".weather").val(selectItems[0].text)
			weatherNO = selectItems[0].value
		})
	})
	//上传图片
	
	$("#qs_photo").on("tap", function () {
		plusSelectImage(function (data, path) {
			console.log(JSON.stringify(data))
			if (data.success) {
				strAttachment[0].groupId = data.result.uploadFile.id
				strAttachment[0].fileTokens += data.result.fileTokens + ',';
 
 
				var html = '<div id="' + data.result.uploadFile.id + '" data-token="' + data.result.fileTokens +
                    '" class="img_item" style="position:relative">' +
                    '		<img class="img_src imgCss" data-preview-src="" data-preview-group="1" src="' + path + '" style="width:78px;height:78px;"  />' +
                    '<span class=" myImgClose mui-icon mui-icon-closeempty" style="    font-size: 16px;color: #888888;background: #E7E7E7;border-radius: 50%;position:absolute;right:0px;"></span>'+
                    '	</div>';
				$("#tp").append(html);
				console.log(html)
 
				var count = $(".qua_img_list").children().length;
				if (count == 2) { //处理上传的数量
					$("#qs_photo").hide();
				}
				$(".myImgClose").each(function () {
					$(this).on('tap', function (e) {
						$(this).parent().hide()
						strAttachment[0].fileTokens = ''
						if (count == 2) {
							$("#qs_photo").show()
						}
					})
 
				})
			} else app.toast(data.message)
		});
	});
	
	// 选择地点
	function initMap(arr) {
		// 地图开启==================================================================================================================================================================================
		// 初始化地图容器
		const MobileContainer = window['mobile-lib'].MobileContainer;
		const mobileContainer = new MobileContainer({
			serverUrl: config.urls.serverDomain,
			options: { minZoom: 10 },
			style: 'color',
			initCallback: () => {
				console.log("地图初始化完成")
			}
		});
		const layerSelections = window['mobile-lib'].layerSelections;
		const mapData = window['mobile-lib'].MapData({
			serverUrl: config.urls.serverDomain,
			style: 'color'
		});
		mobileContainer.on('load', () => {
			getCurrentPosition();
			
			mobileContainer.enableCenterAddress(true);
			// mobileContainer.setQuery({NAME: 'ps_dischargeWr'});//加载排水户
			mobileContainer.setQuery(...arr)
			mobileContainer.showAnnotation(true);
		});
 
		var getCurrentPosition = function () {
			plus.geolocation.getCurrentPosition(function (position) {
				//坐标修正
				var point = coordtransform.gcj02towgs84(position.coords.longitude, position.coords.latitude);
				var Lon = point[0]; //获取经度
				var Lat = point[1]; //获取纬度
				
				console.log("latlng:" + Lat + "," + Lon);
				mobileContainer.flyTo([Lon, Lat], {
					zoom: 12
				});
				
			})
		}
 
		//点击地图 定位
		mobileContainer.on('click', data => {
			if (data) {
				// flag = true;
				console.log('点击地图:click')
				// clearGlobalItem();
				mobileContainer.enableCenterAddress(true);
				mobileContainer.markAddress(data.lngLat.lng, data.lngLat.lat);
				mobileContainer.flyTo([data.lngLat.lng, data.lngLat.lat]);
			} else {
				// flag = false;
				// clearGlobalItem();
				app.toast('当前选择不在可选范围内，请重新选择');
			}
		});
		//地图取消
		$("#map_cancel").on('tap', function () {
			console.log("取消");
			maskClose();
		})
 
		//地图确认
		$('#map_confirm').on('tap', function () {
			var address = $("#searchInput").val();
			$("#discoveryAddr").text(address)
			maskClose()
		})
 
		function maskClose() {
			mask.clickClose = true;
			mask.close();
		}
		//显示地图信息
		mobileContainer.on('showAddress', data => {
			console.log("showAddress" + JSON.stringify(data.addressComponent));
			var point = {
				'lng': data.location.lon,
				'lat': data.location.lat
			};
			Point = point;
			// globalSetItem(GlobalKey.point, JSON.stringify(point));//选中地图点
 
			var city = data.addressComponent.city ? (data.addressComponent.city) : '';
			var county = data.addressComponent.county ? (data.addressComponent.county) : '';
			var road = data.addressComponent.road ? data.addressComponent.road : '';
			var poi = data.addressComponent.poi ? data.addressComponent.poi : '';
			var address = city + county + road + poi;
			$("#searchInput2").val(address);
			$("#searchInput").val(address);
			console.log('内容='+JSON.stringify(data.addressComponent))
			$("#searchInput2").show();
			$("#searchInput").show();
			$(".facilityNoY").val('device_flood_7')
			$(".facilityNoM").val('device_flood_7')
			// maskClose();
			// globalSetItem(GlobalKey.address, address);//保存选中的地址
		});
		// 地图结束==================================================================================================================================================================================
	}
 
	//关闭遮罩层
	function closeMask() {
		console.log('关闭遮罩层' + sharew.id);
		//避免出现特殊情况，确保分享页面在初始化时关闭
		if (!sharew) {
			sharew = plus.webview.getWebviewById("goods/add_to_cart.html");
			console.log(sharew.id);
		}
		if (sharew) {
			sharew.hide('slide-out-bottom', 300);
			//sharew = null;
		}
		var ws = plus.webview.currentWebview();
		console.log('关闭遮罩层' + ws.id);
		ws.setStyle({ mask: "none" });
	}
 
	// mask.clickClose = false;
 
 
	var mask = mui.createMask(function () {
		return mask.clickClose;
	});
	$('#searchInput').on('tap', function () {
		var arrJh = [{NAME: 'DEVICE_FLOOD'}]
		var arrYl = [{NAME: 'DEVICE_SPECIAL_POINT'},{POINT_CODE:'041008'}]
		var arrMy = [{NAME:'DEVICE_POINT_INFO'}]
		//,{ NAME: 'DEVICE_PS_RIVER_RODE' }, { NAME: 'GIS_RIVER_NAME' }, { NAME: 'DEVICE_PS_SECTION'}
		if(checkNum == 1){
			console.log("选择地图");
			setTimeout(function(){
				maskShow();
				addMapSelector();
				initMap(arrJh);
			},100)
		}
		if(checkNum == 2){
			console.log("选择地图");
			setTimeout(function(){
				maskShow();
				addMapSelector();
				initMap(arrYl);
			},100)
		}
		if(checkNum == 3){
			console.log("选择地图");
			setTimeout(function(){
				maskShow();
				addMapSelector();
				initMap(arrMy);
			},100)
		}
	})
	function maskShow() {
		mask.clickClose = false;
		mask.show();
	}
 
	// 弹出地图
	var addMapSelector = function () {
		// 先清空
		$(".mui-backdrop").empty();
		var map = '<div id="map" class="mapboxgl-map" style="z-index: 7;position:absolute;left:0px;top:0px;right:0px;width:80%;height:78vh;margin: 10% 10%">' +
			'<!--搜索-->' +
			'<div id="searchBar" class="mui-input-row" style="position: fixed;z-index: 6;width: 80%;margin: 10%;margin-left:0px;height: 40px; ">' +
			// '<img src="../../../img/commom/search1@2x.png" alt="" id="search_icon" style="width: 16px;position: fixed;top: 31px;left: 31px;">' +
			'<input readonly style="border: none;background-color: white;padding: 10px;font-size: 16px;text-align: left;display: none;width:100%;" id="searchInput2"></div>' +
			'</div>' +
			'<div style="bottom: 8%;margin-left: 10%;width: 80%;display: flex;position: absolute;background-color: white;height: 35px;">' +
			'<span style="flex: 1;text-align: center;line-height: 35px;border-right: 1px solid #eee" id="map_confirm">确认</span>' +
			'<span style="flex: 1;text-align: center;line-height: 35px;" id="map_cancel">取消</span>' +
			'</div>';
		$(".mui-backdrop").append(map);
	}
 
	// 受理人选择
	var extras = {}
	$('#showUserPicker4').on('tap', function () {
		app.openPage("../commom/organ.html", {
			titleNView: {
				titleText: '选择人员',
				autoBackButton: true
			}
		}, extras); 
		var checkPersonBack = function (data) {
			console.log(JSON.stringify(data.detail))
			if (data.detail[0] != undefined) {
				console.log(JSON.stringify(data.detail[0]));
				$("#approverFullname").text(data.detail[0].realname);
				console.log(JSON.stringify(data.detail[0]))

				// var url =  config.urls.baseUrl + config.actions.getPhoneById
				// var param = {refId:data.detail[0].id}
				// var type = 'post'
				// getProjectPost(url,param,type,function(data){
				// 	console.log('phone='+JSON.stringify(data))
				// })
				var url =  config.urls.baseUrl + config.actions.getPhoneByPersonName
				var params = {personName:data.detail[0].realname}
				var type = 'get'
				getProject(url,params,type,function(data){
					console.log('111')
					if(data.success){
						console.log(data.result.records[0].personMobilePhone)
						$(".dutyUserPhone").val(data.result.records[0].personMobilePhone)
					}
				})

				// submitParam.resAuditorName = data.detail[0].realname
				// submitParam.resAuditorUsername = data.detail[0].username
			}
			//移除
			window.removeEventListener('returnSelect', checkPersonBack, false);
		}
 
		//移除
		window.removeEventListener('returnSelect', checkPersonBack, false);
		// 赋值
		window.addEventListener('returnSelect', checkPersonBack, false);
	})
	
	$(".inspection_submit").on("tap", function (event) {
		if($(".iptOne").val() == ''){
			app.toast('请填写事件名称')
			return
		}
		if($(".eventbh").val() == ''){
			app.toast('请填写事件编号')
			return
		}
		if($(".eventSour").val() == ''){
			app.toast('请填写事件来源')
			return
		}
		if($("#eventtime").val() == ''){
			app.toast('请选择发生日期')
			return
		}
		if($(".weather").val() == ''){
			app.toast('请选择天气状态')
			return
		}
		if(checkNum == '-1'){
			app.toast('请选择事件类型')
			return
		}else if(checkNum == 1){
			if($(".eventnumber").val() == ''){
				app.toast('请输入所需人数')
				return
			}
			if($(".floodDepth").val() == ''){
				app.toast('请输入积水深度')
				return
			}
			if($("#searchInput").val() == ''){
				app.toast('请选择事件地点')
				return
			}
		}else if(checkNum == 2){
			if($(".deviceTypeY").val() == ''){
				app.toast('请选择设施类型')
				return
			}
			// if($(".facilityNoY").val() == ''){
			// 	app.toast('请输入设施编号')
			// 	return
			// }
			
		}else if(checkNum == 3){
			if($(".deviceTypeM").val() == ''){
				app.toast('请选择设施类型')
				return
			}
			// if($(".facilityNoM").val() == ''){
			// 	app.toast('请选择设施编号')
			// 	return
			// }
			
		}
		if($("#searchInput").val() == ''){
			app.toast('请选择事件地点')
			return
		}
		if($(".reportPersonPhone").val() != ''){
			var isTrue = checkPhone($(".reportPersonPhone").val())
			if(!isTrue){
				app.toast('请输入正确的上报人联系方式')
				return
			}
		}
		if(isSendNum == -1){
			app.toast('请选择是否发送工单之运维负责人')
			return
		}else if(isSendNum == 1){
			if(problemNum == -1){
				app.toast('请选择问题类型')
			}
		}
		if($(".dutyUserName").html() == '请选择运维负责人'){
			app.toast('请选择运维负责人')
			return
		}
		if($(".dutyUserPhone").val() == ''){
			app.toast('请填写负责人联系方式')
			return
		}
		if(harmLevel == '-1'){
			app.toast('请选择危害程度')
			return
		}
		
		var loginUser=localStorage.getItem('$state')
		var obj=JSON.parse(loginUser).userInfo
		var obj2=JSON.parse(loginUser).depart
		var eventTypes=["积水","溢流","冒溢"]
		var harm=["高","中","低","待定",]
		var params = {
			// createBy:obj.createBy,//填写人
			// createTime:obj.createTime.split(" ")[0],//填写日期
			// updateBy:obj2.updateBy,//处理人
			// donePerson:obj2.donePerson,
			// updateTime:obj2.updateTime.split(" ")[0], //处理时间

			eventName:$(".iptOne").val(),//事件名称
			eventNo:$(".eventbh").val(),//事件编号
			eventSource:CheckTypeIndex, //事件来源1
			// eventSource:$(".eventSour").val(picker[index]), //事件来源
			
			eventLocation:$("#searchInput").val(), //事件地点1
			occurTime:$(".dateSelect").val(), //发生日期1
			weather:weatherNO,//天气:1
			eventType:checkNum, //事件类型
			reportRealName:$("#reportRealName").val(),//上报人姓名1
			reportPersonPhone:$(".reportPersonPhone").val(),//上报人联系方1式
			dutyRealName:$(".dutyUserName").text(),//选择负责人1
			dutyUserPhone:$(".dutyUserPhone").val(),//选择负责人联系方式1
			harmLevel:harmLevel,//危害程度1
			eventDescription:$(".eventDescription").val(),//事件描述1
			repairOrder:isSendNum,//是否发送工单之运维负责人
			inputRealName:stateText.userInfo.realname,//填写人
			handlingState:isSendNum,//状态
			inputTime:nowDate,
			deviceGuid: 'device_flood_7',
			
		}
		if(checkNum == 1){
			params.number = $(".eventnumber").val()//所需人数1
			params.floodDepth = $(".floodDepth").val()//积水水深度1
		}
		if(checkNum == 2){
			deviceType1 = 3
			params.deviceType = deviceType1
		}
		if(checkNum == 3){
			params.deviceType = deviceType2
		}
		params.strAttachment = strAttachment
		if(params.strAttachment[0].groupId == '' ){
			params.strAttachment[0].groupId = uuid()
		}
		if(isSendNum == 1){
			params.probType = problemNum
		}
		params.attachment = params.strAttachment[0].groupId
		params.summaryAttachment = uuid()
		params.strAttachment.push({
			'groupId':params.summaryAttachment,
			'fileTokens':"",
			'fileName':'attachment',
			'tableName':'attachment'
		})
		console.log(JSON.stringify(params))
		// console.log(params.eventSource)
		
		//调接口
		var url = config.urls.baseUrl + config.actions.gettjevent
            // console.log(JSON.stringify(params),'222222222222222')
			var type = "post"
            getWork(url,params,"post",function(data){
                console.log(JSON.stringify(data))
                if(data.success){
							app.toast(data.message);
							plus.webview.currentWebview().opener().reload();
                            mui.back()
							// app.openPage("addSuccess.html", {
                            //       titleNView: {
                            //         titleText: '检查记录',
                            //         autoBackButton: true,										
                            //       }
                            //     });
						}else app.toast("新增失败");
            })
		// var eventName = $(".iptOne").val() || ''//事件名称
		// var eventNo = $(".eventbh").val() || ''//事件编号
		// var eventSource = $(".eventSour").val() || ''//事件来源
		// var eventLocation = $(".eventsite").val() || ''//事件地点
		// var dateSelect = $(".dateSelect").val() || ''//发生日期
		// var weather = $(".weather").val() || ''//天气
		// var initialDesign = $("radios") //事件类型
		// var number = $(".eventnumber").val() || ''//所需人数
		// var floodDepth = $(".floodDepth").val() || ''//深水深度
		// var reportRealName = $(".reportRealName").val() || ''//上报人姓名
		// var reportPersonPhone = $(".reportPersonPhone").val() || ''//上报人联系方式
		// var wenti = $(".wenti").val() || ''//问题图片
		// var dutyUserName = $(".dutyUserName").text() || ''//选择负责人
		// var dutyUserPhone = $(".dutyUserPhone").text() || ''//选择负责人联系方式
		// var harmLevel = $(".harmLevel").text() || ''//危害程度
		// var eventDescription = $(".eventDescription").val() || ''//事件描述
		// var data = {eventName, eventNo, eventSource, dateSelect,weather,floodDepth,number,reportPersonPhone,dutyUserName,dutyUserPhone,eventDescription }
 
		// console.log(860, data);
	});
	
	var checkNum = -1
	var harmLevel = -1
	$(`input[name='eventType']`).each(function(index){
			$(this).on('click',function(e){
				if($(this).prop('checked')){
					checkNum = $(this).val()
					$(".menu").children().eq(index).css('display','block').siblings().css('display','none')
				}else{
					checkNum = -1
				}
				if(checkNum == 1){
					$(".facilityNoJ").val('')
					$(".deviceTypeM").val('')
					$("#searchInput").val('')
					$("#searchInput").removeAttr('disabled')
				}	
				if(checkNum == 2){
					$(".deviceTypeM").val('')
					$("#searchInput").val('')
					$("#searchInput").removeAttr('disabled')
					$(".deviceTypeY").val('排放口')
					deviceType1 = 4
				}else{
					$(".deviceTypeY").val('') 
					deviceType1 = -1
				}
				if(checkNum == 3){
					$(".facilityNoM").val('')
					$(".deviceTypeM").val('')
					$("#searchInput").val('')		
					if(deviceType2 == -1){
						console.log('111')
						$("#searchInput").attr('disabled','desabled')
					}
						
						
						
					
				}
			})				
	})
	$(`input[name='harmLevel']`).each(function(index){
			$(this).on('click',function(e){
				if($(this).prop('checked')){
					harmLevel = $(this).val()
				}else{
					harmLevel = -1
				}
			})
				
	})
	$(`input[name='send']`).each(function(index){
			$(this).on('click',function(e){
				if($(this).prop('checked')){
					isSendNum = $(this).val()
				}else{
					isSendNum = -1
				}
				if(isSendNum == 1){
					$(".problem").show()
				}else{
					$(".problem").hide()
				}
			})		
	})
	//验证电话号码
	function checkPhone(phone) {
	//手机号
	if (!(/^1[3456789]\d{9}$/.test(phone))) {
		return false;
	}
	return true;
}
	//图片预览
	$(document).on('tap', '.img_src', function() {
				mui.previewImage();
			}); 
</script>
 
</html>