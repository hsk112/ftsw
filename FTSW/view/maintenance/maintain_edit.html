<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/common.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../../css/mui.imageviewer.css" />
		<style>
			.mui-input-row {
				position: relative;
				float: left;
				width: 100%;
				text-align: left;
				clear: none;
			}

			.mui-checkbox input[type=checkbox]:before,
			.mui-radio input[type=radio]:before {
				font-size: 25px;
			}

			.mui-checkbox.mui-left label,
			.mui-radio.mui-left label {
				padding-left: 50px;
				font-size: 16px;
			}

			.info-bar-title {
				height: 40px;
				background: #f6f4f7;
				font-size: 15px;
				text-align: left;
				color: #8e8e8e;
				line-height: 40px;
				padding: 0 18px;
			}

			.info-bar-content {
				height: 470px;
			}

			.info-bar-content-item {
				height: 240px;
				margin: 0px 18px;
				/* border-bottom: 1px solid #eee; */
			}

			.info-bar-content-item .item-title {
				text-align: left;
				padding: 20px 0px 0px;
				font-size: 14px;
			}


			.bottom-btn {
				width: 100%;
			}

			/*
			.mui-scroll-wrapper {
			} */

			.object {
				display: flex;
				justify-content: space-between;
				margin: 8px 0;
				color: #444444;
			}

			.mui-checkbox.mui-left label {
				padding-left: 0;
			}

			.mui-backdrop {
				background: rgba(0, 0, 0, 0.1);
			}

			.img_item {
				float: left;
				text-align: left;
				width: 72px;
				height: 72px;
				margin-right: 20px;
			}

			.img_item::after {
				clear: both;
				content: '';
				display: block;
				width: 0;
				height: 0;
				visibility: hidden;
			}

			.img_item img {
				width: 72px;
				height: 72px;
			}


			.info-bar-content-item {
				border: 0;
			}

			.img_close {
				/* position: relative;
				top: -84px;
				left: 64px; */
				position: absolute;
				top: 0;
				right: 0;
				margin: -5px -6px 0 0;
				width: 18px;
				height: 18px;
				line-height: 18px;
				text-align: center;
				border-radius: 50%;
				background: #E7E7E7;
			}

			.btn-item div {
				margin: 0;
				border: 1px solid #337BFC;
				height: 40px;
				border-radius: 50px;
			}

			.in-obj {
				color: #888;
				font-weight: 400;
			}

			.obj-title {
				font-weight: 400;
				color: #444444;
			}


			span[new] {
				display: inline-block;
				position: relative;
				left: -20px;
				top: 5px;
				width: 20px;
				height: 20px;
				border-radius: 50%;
				border: 1px solid #999;
				margin-right: -10px;
			}
		</style>
	</head>

	<body style="background: #F4F4F4;">
		<!--页面主结构开始-->
		<div id="app" class="mui-views">
			<div class="mui-view">
				<div class="mui-navbar">
				</div>
				<div class="mui-pages">
				</div>
			</div>
		</div>
		<!--页面主结构结束-->
		<!--单页面开始-->
		<div id="mui-content" class="mui-page">
			<!--页面标题栏开始-->
			<!-- <header class="mui-bar mui-bar-nav common-header">
				<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
				<h1 class="mui-title">养护内容</h1>
				<div class="mui-pull-right header-btn">
					<img src="../img/commom/nfc@2x.png" />
					<img src="../img/commom/lixz@2x.png" />
				</div>
			</header> -->
			<!--页面标题栏结束-->
			<!--页面主内容区开始-->
			<div class="mui-page-content">
				<div class="mui-scroll-wrapper" style="background: #FFFFFF;">
					<div class="mui-scroll">
						<div class="scroll-li">
							<div style="background: #F4F4F4;">
								<div class="mui-collapse-content li-item-pull" id="object">
									<div>
										<div id="objHeader" style="padding: 0 18px;background: #ffffff;border-bottom: 5px solid #F4F4F4;">
											<div class="object">
												<div><span class="in-obj">养护对象：</span><span class="obj-title" id="maintainObj">加载中</span></div>
												<div class="type-inspection"><img src="../../img/commom/dzx.png" alt=""></div>
											</div>
											<div class="object" style="text-align:left;">
												<div style="width:100%;">
													<span class="in-obj">养护内容：</span>
													<div class="obj-title" style="width:70%;word-break: break-all;display:inline-block;vertical-align:top;" id="maintContent">加载中</div>
												</div>
											</div>
											<div class="object" style="text-align:left;">
												<div style="width:100%;">
													<span class="in-obj">养护频次：</span>
													<div class="obj-title" style="width:70%;display:inline-block;vertical-align:top;" id="maintFrequency_dictText">加载中</div>
												</div>
											</div>
											<div class="object">
												<div>
													<span class="in-obj">截止日期：</span>
													<span class="obj-title" style="text-align:left;" id="endDate">加载中</span>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>

							<div id="inspectDetail" style="margin:0;">
								<div class="scroll-li">
									<div class="info-bar-content-item qz_fj" style="width: 100%;text-align: left;margin-left:20px;height: 120px;">
										<div class="item-title in-obj" style="margin-bottom:10px;font-weight: 400;color: #444444;">
											现场照片
										</div>
										<input id="fileId" style="display: none;" />
										<div class="photo_list" id="photo_list">
											<!-- 底下已经控制数据 -->
											<!-- <div class="img_item" style="position: relative;">
												<img class="img_src" src="../../img/commom/pz@2x.png" style="" />
												<div class="img_close" style=""><span style="color:#888888;height: 8px;width: 8px;">x</span></div>
											</div> -->
										</div>
										<div id="photo" class="img_item">
											<img class="img_src" src="../../img/commom/pz@2x.png" style="" />
										</div>
									</div>
									<div class="info-bar-content-item">
										<div class="item-title" style="margin-bottom: 10.5px;">
											<span>备注</span>
										</div>
										<div class="mui-input-row item-input">
											<textarea id="remark" rows="3" onkeyup="format_input(this)" style="height: 80px;" class="mui-input-clear inputCss"
											 placeholder="请输入备注" maxlength="50"></textarea>
										</div>
									</div>
								</div>

							</div>
						</div>
					</div>

				</div>


			</div>

			<!--页面主内容区结束-->
		</div>
		<div id="textFrame" class="scroll-li" style="display:none;width: 100%;height:100px;background: rgba(0,0,0,0.5);position: fixed;bottom: 0;z-index: 999;"></div>
		<div id="texthtml" class="scroll-li" style="width: 100%;background: #F4F4F4;position: fixed;bottom: 0;z-index: 99;">
			<div class="bottom-btn" style="background: #F4F4F4;width: 100%;padding: 20px 0;">
				<div class="btn-item" style="background: #F4F4F4;">
					<div name="submit" style="background: #337BFC;color: #fff;width: 80%;margin-left: 10%;line-height: 40px;">提交</div>
				</div>
			</div>
		</div>

	</body>


	<script src="../../js/jquery.min.js"></script>
	<script src="../../js/mui.min.js"></script>
	<script src="../../js/mui.view.js"></script>
	<script src="../../js/mui.locker.js"></script>
	<script src="../../js/app.js"></script>
	<script src="../../js/common.js"></script>
	<script src="../../js/config.js"></script>
	<script src="../../js/maintain.js"></script>
	<script src="../../js/uploadimage.js"></script>
	<script src="../../js/s4.js"></script>
	<script src="../../js/smutils.js"></script>
	<script src="../../js/byte&string.js"></script>
	<script src="../../js/ajaxhook.min.js"></script>
	<script src="../../js/mui.zoom.js"></script>
	<script src="../../js/mui.previewimage.js"></script>
	<script src="../../js/helper.js"></script>
	<script src="../../js/vconsole.min.js"></script>
	<script>
		// var vConsole = new VConsole();
		var self;
		//图片附件
		var imgAttachment = [{
			"groupId": "",
			"fileTokens": "",
			"fieldName": "maint_log_detail", //照片
			"tableName": "attachment"
		}];
		//提交参数
		var param = {
			guid: "",
			remark: "",
			attachment: "",
			strAttachment: []
		}
		var contentList = [] //养护内容列表
		var currentContent = {} //当前的养护内容
		var maintainObj = ""; //养护对象
		var endTime = "";
		var self;
		var isEnd = true; //是否养护完成
		
		$("body").delegate("div[name=submit]", "tap", function(e) {
			// attach();
			//附件			
			param.guid = currentContent.guid;
			param.remark = $("#remark").val()
			param.attachment = imgAttachment[0].groupId;
			param.strAttachment = JSON.stringify(imgAttachment);
			contentList = contentList.filter(item => {
				return item.guid != currentContent.guid;
			})
			if(isEnd == true && imgAttachment[0].fileTokens == '') isEnd = false; //没有上传照片
			var dataList = [];
			var listData = self.listData;
			listData.forEach(item => {
				if (parseInt(item.status) == 0) {
					if (item.guid == currentContent.guid) {
						dataList.push(param)
					} else {
						var attach = [{
							"groupId": "",
							"fileTokens": "",
							"fieldName": "maint_log_detail", //照片
							"tableName": "attachment"
						}];
						var li = {
							guid: item.guid,
							strAttachment: JSON.stringify(attach),
							attachment: '',
							remark: ''
						};
						dataList.push(li)
					}
				}

			})

			var url = config.urls.baseUrl + config.actions.commitTask;
			var params = {
				dataList: JSON.stringify(dataList)
			}
			
			app.showLoader();
			$.ajax(url, {
				data: params,
				dataType: 'json', //服务器返回json格式数据
				type: 'post', //HTTP请求类型
				headers: {
					"X-Access-Token": app.sessionId(),
					"Content-Type": "application/x-www-form-urlencoded"
				},
				timeout: config.settings.requestTimeOut, //超时时间设置为10秒；
				success: function(data) {
					console.log("response:" + JSON.stringify(data))
					if (data.success) {
						console.log(JSON.stringify(self.listData))
						self.listData[currentContent.objNo - 1].status = 1;

						var extra = {
							workPackageName: plus.webview.currentWebview().workPackageName,
							contentList: contentList,
							mainObj: plus.webview.currentWebview().mainObj,
							objStat: plus.webview.currentWebview().objStat,
							index: plus.webview.currentWebview().index,
							datalist: self.listData,
							isEnd : isEnd
						};
						console.log(JSON.stringify(extra))

						app.hideLoader();
						app.toast("提交成功，正在跳转...")
						setTimeout(function() {
							app.openPage('maintain_end.html', {
								titleNView: {
									titleText: self.workPackageName,
									autoBackButton: true,
								},
								'popGesture': 'none'
							}, extra);
						}, 1000)
					} else {
						app.toast("提交失败，数据异常，请重试！")
						setTimeout(function() {
							app.hideLoader();
						}, 1000)
					}
				},
				error: function(xhr, type, errorThrown) {
					dealingWithErrorRequest(errorThrown);
					app.hideLoader();
					app.toast('网络异常,请稍后再试');
				}
			});
		});

		mui.init({
			beforeback: function() {
				var list = plus.webview.currentWebview().opener();
				//refresh是A页面自定义事件
				mui.fire(list, 'aaa');
				mui.fire(list, 'backInspection');
				mui.fire(list, 'toInfo');
				//返回true,继续页面关闭逻辑
				return true;
			}
		});
		//初始化单页view
		var viewApi = mui('#app').view({
			defaultPage: '#mui-content'
		});
		//初始化单页的区域滚动
		mui('.mui-scroll-wrapper').scroll();
		mui.plusReady(function() {
			self = plus.webview.currentWebview();
			maintainObj = self.maintainObj;
			contentList = self.contentList; //获取养护内容列表
			endTime = self.endTime;
			currentContent = self.currentContent;
			if (currentContent == undefined) {
				currentContent = contentList[i]
			}
			// console.log(JSON.stringify(self.listData))
			self.setStyle({
				titleNView: {
					titleText: self.workPackageName,
				}
			});
			// console.log("当前养护内容：" + JSON.stringify(currentContent))
			$("#maintainObj").html(isEmp(currentContent.maintainObj));
			$("#maintContent").html(isEmp(currentContent.maintainContent))
			getDicText(currentContent.maintFrequency, 'ZHSW.INSPECT.TASK_FREQUENCY', function(data) {
				$('#maintFrequency_dictText').text(isEmp(data));
			})
			$("#endDate").html(endTime != "" ? endTime : (new Date()).Format("yyyy-MM-dd"))

			//拍照
			$("#photo").on("tap", function() {
				var that = $(this);
				plusSelectImage(function(data, path) {
					console.log(JSON.stringify(data));
					if (data.success) {
						var thisId = that.attr("id");
						var name = "";
						imgAttachment[0].groupId = getGroupId();
						imgAttachment[0].fileTokens = data.result.fileTokens;
						var html = '<div id="' + data.result.uploadFile.id + '" data-token="' + data.result.fileTokens + '" name="' +
							name + '"' +
							'" class="img_item" style="position:relative;">' +
							'		<img class="img_src" src="' + path + '" style="" data-preview-src="" data-preview-group="1"  />' +
							'		<input type="hidden" name="' + name + '" value="' + data.result.uploadFile.savePath + '">' +
							'		<span class="img_close mui-icon mui-icon-closeempty"  name="' + data.result.uploadFile.savePath +
							'" style="width: 16px;height: 16px;position:relative;top:-88px;left:64px;font-size: 16px;color: #888888;background: #E7E7E7;border-radius: 50%;"></span>'+
							'	</div>';
						that.prev().append(html);
						var count = that.prev().children(".img_item").length;
						if (count >= 1) { //处理上传的数量
							that.hide();
						}
					} else {
						app.toast(data.message);
					}
				});
			});
			//删除图
			$(document).on("tap", ".img_close", function() {
				var that = $(this)
				mui.confirm("移除该图片?", "提示", ['确定', '取消'], function(result) {
					if (parseInt(result.index) == 0) {
						var count = that.parent().parent().children(".img_item").length - 1;
						var photoObj = that.parent().parent().next();
						// var thisId = photoObj.attr("id");
						// var delPath = that.attr("name");
						if (count < 1) {
							photoObj.show();
						}
						that.parent().remove();
						imgAttachment[0].groupId = '';
						imgAttachment[0].fileTokens = '';
					}
				})
			});
			//图片预览
			$(document).on('tap', '.img_src', function() {
				mui.previewImage();
			});

			var clientHeight = document.documentElement.clientHeight || document.body.clientHeight;
			$('body').height($('body')[0].clientHeight);
			window.onresize = function() {
				var nowClientHeight = document.documentElement.clientHeight || document.body.clientHeight;
				if (clientHeight > nowClientHeight) {
					$('#texthtml').css('display', 'none')
				} else {
					$('#texthtml').css('display', 'block')
					//键盘收起的事件处理
				}
			};
		});

		//附件组装
		var attach = function() {
			var imagefileTokens = '';
			$("[data-token]").each(function(index) {
				var imgID = $(this).attr("id");
				var name = $(this).attr("name");
				var token = $(this).attr("data-token");
				imagefileTokens = imagefileTokens + "," + token;
			});
			imagefileTokens = imagefileTokens.length > 0 ? imagefileTokens.substring(1, imagefileTokens.length) :
				imagefileTokens;
			console.log("imagefileTokens:" + imagefileTokens);
			imgAttachment.forEach((img, index, array) => {
				if (img.fieldName == 'maintenance_log_detail') {
					let groupId = getGroupId();
					param.attachment = groupId;
					img.groupId = groupId;
					img.fileTokens = imagefileTokens;
				}
			})
		}
		//生成groupId
		function getGroupId() {
			return 'xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
				var r = Math.random() * 16 | 0,
					v = c == 'x' ? r : (r & 0x3 | 0x8);
				return v.toString(16);
			});
		}

		Date.prototype.Format = function(fmt) { // author: meizz
			var o = {
				"M+": this.getMonth() + 1, // 月份
				"d+": this.getDate(), // 日
				"h+": this.getHours(), // 小时
				"m+": this.getMinutes(), // 分
				"s+": this.getSeconds(), // 秒
				"q+": Math.floor((this.getMonth() + 3) / 3), // 季度
				"S": this.getMilliseconds() // 毫秒
			};
			if (/(y+)/.test(fmt))
				fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
			for (var k in o)
				if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" +
					o[k]).substr(("" + o[k]).length)));
			return fmt;
		}

		window.addEventListener('return1', function(e) { //监听返回
			// contentIdList.splice(0,1)
			app.showLoader()
			if (contentList.length == 0) {
				app.toast("养护已全部完成，即将返回列表！");
				setTimeout(function() {
					app.hideLoader()
					var view = plus.webview.getWebviewById("view/maintenance/maintain_index.html");
					mui.fire(view, 'close');
					plus.webview.currentWebview().close('none'); //关闭
				}, 1000)
				return;
			}
			setTimeout(function() {
				app.hideLoader()
				app.toast("已跳转至下一养护内容！");
			}, 1000)
			$("#photo_list").html("");
			$("#photo").show();
			currentContent = contentList[0];

			$("#remark").val("")
			$("#maintainObj").html(isEmp(currentContent.maintainObj));
			$("#maintContent").html(isEmp(currentContent.maintainContent))
			getDicText(currentContent.maintFrequency, 'ZHSW.INSPECT.TASK_FREQUENCY', function(data) {
				$('#maintFrequency_dictText').text(isEmp(data));
			})
			$("#endDate").html(endTime != "" ? endTime : (new Date()).Format("yyyy-MM-dd"))

			console.log("剩余养护内容：" + JSON.stringify(contentList));
			console.log("剩余养护内容个数：" + contentList.length);
		});
		window.addEventListener('close', function(e) { //监听关闭
			var view = plus.webview.getWebviewById("view/maintenance/maintain_index.html");
			var list = plus.webview.currentWebview().opener();
			mui.fire(view, 'backInspection');
			mui.fire(list, 'backInspection');
			plus.webview.currentWebview().close('none'); //关闭
		});

		function format_input(obj) {
			obj.value = obj.value.replace(
				/[\|\!|\！|\,|\，|\。|\.\……|\?|\？|\-|\——|\"|\“|\”|\:|\：|\、|\+|\*|\/|\<|\>|\《|\》|\;|\；|\(|\)|\（|\）|\~|\@|\#|\$|\%|\^|\&|\{|\}|\[|\s|\]]/g,
				'');
			var num = 50;
			if (obj.value.length >= num) {
				obj.value = obj.value.slice(0, num);
				// obj.focus();				
				app.toast("备注仅允许输入50位以内的中文、英文或数字！")
			}
		}
	</script>

</html>
