<!doctype html>
<html>

	<head>
		<meta charset="utf-8">

		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=10,user-scalable=yes" />
		<link href="../../css/common.css" rel="stylesheet" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/mui.picker.min.css" rel="stylesheet" />

		<style>
			body {
				margin: 0;
			}

			#showPdf {
				/*margin-top: 50px;*/
				/*height: 100%;*/
				height: calc(100vh - 48px);
			}

			#showPdf #pdfContainer {
				/*height: 100vh;*/
				height: calc(100vh - 48px);
			}

			.monthBtn {
				width: 50px;
				margin: 10px auto;
				text-align: center;
				display: inline-block;
				border-left: 1px solid #EDEDED;
			}

			#monthBtn1 {
				border-left: none !important;
			}

			#scrollWrapper {
				text-align: left;
				white-space: nowrap;
				color: #888888;
			}

			.monthWrapper {
				border-bottom: 1px solid #EEEEEE;
				width: 100%;
				/*overflow-x: scroll;*/
				/*position: fixed;*/
				background-color: #F4F4F4;
				/*top: 0;*/
				/*left: 0;*/
				opacity: 1;
				/*line-height: 40px;*/
				/*padding: 5px 5px 5px 10px;*/
				/*text-align: left;*/
				color:#666666;
				font-size: 14px;
				/*font-weight: 400;*/
				display: flex;
				align-items: center;
				height: 48px;
			}

			.home-item{
				/*border-radius: 15px 15px 0 0;*/
				position: fixed;
				bottom: 0px;
				left: 0px;
				width: 100%;
				background-color: #FFFFFF;
				z-index: 99;
			}
			.mui-backdrop {
			    position: fixed;
			    top: 0;
			    right: 0;
			    bottom: 0;
			    left: 0;
			    z-index: 98;
			    background-color: rgba(0,0,0,0.2);
			}
			.bottom-item{
				line-height: 50px;
				border-bottom: 1px solid #EDEDED;
				/*margin: 0 10px;*/
				font-size: 16px;
				/*font-weight: bold;*/
				color: #262626;
			}
			#downloadBtn {
				color: #0493F3;
			}

			/* 弹窗日期样式修改 */
			.mui-dtpicker-header {
				height: 50px;
			}
			.mui-dtpicker-header button {
				border: none;
				background-color: white;
				color: #0493F3;
				font-size: 16px;
			}
			.mui-dtpicker-header button:first-child {
				/*margin-right: 73%;*/
				position: absolute;
				left: 0;
				color: #262626;

			}
			/* 弹窗日期样式修改 */
			.mui-dtpicker {
				background-color: white;
			}
			.mui-dtpicker-title {
				display: none;
			}
			.mui-dtpicker .mui-picker {
				background-color: white;
			}
		</style>
	<body>
		<!--页面主结构开始-->
		<div id="app" class="mui-views">
			<div class="mui-view">
				<div class="mui-navbar">
				</div>
				<div class="mui-pages">
				</div>
			</div>
		</div>
		<div class="home-item" style="display: none;" id="home-item">
			<div class="bottom-item" id="downloadBtn">下载</div>
			<!-- <div class="bottom-item" id="openWPS">打开WPS</div> -->
			<!-- <div class="bottom-item">其他软件打开</div> -->
			<div class="bottom-item" id="cancelBtn">取消</div>
		</div>
		<!--页面主结构结束-->

		<!-- 页面主内容开始 -->
		<div id="mui-content">
			<!-- 页面标题栏开始 -->
			<!-- 			<div id="monthWrapper">
				<div id="scrollWrapper"></div>
			</div> -->
			<div id="dateSelect" class="monthWrapper">
<!--				<label>时间筛选：</label>-->
<!--				<input id="selDate" readonly="readonly" placeholder="默认上个月" -->
<!--					   style="border-radius: 20px;border: 1px solid #DEDEDE;width: 70%;padding:2px 40px 2px 20px;line-height: 30px;" />-->
<!--				<img src="../../img/commom/time1.png" style="width:16px;height:16px;position: absolute;left: 80%;top:17px;"></img>-->

				<input id="selDate" readonly="readonly" placeholder="2021-03"
					   style="width: 75px; border: none;margin-left: 20px;background-color: transparent;line-height: 30px;" />
				<img src="../../img/arrowDownBlack.png" style="width: 9px;height: 7px;" alt="">

			</div>
			<div id="showPdf">
				<!-- pdf展示区域 -->
				<iframe id="pdfContainer" src="" width="100%" frameborder="0"></iframe>
			</div>

		</div>
		<!-- 页面标题栏结束 -->
		<script src="../../js/jquery.min.js"></script>
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/mui.view.js"></script>
		<script src="../../js/mui.locker.js"></script>
		<script src="../../js/common.js"></script>
		<script src="../../js/config.js"></script>
		<script src="../../js/app.js"></script>
		<script src="../../js/s4.js"></script>
		<script src="../../js/smutils.js"></script>
		<script src="../../js/byte&string.js"></script>
		<script src="../../js/ajaxhook.min.js"></script>
		<script src="../../js/mui.picker.min.js"></script>
		<script src="../defects/web/viewer.js"></script>
		<script src="./build/pdf.js" type="text/javascript"></script>
		<script src="../../js/supervision.js"></script>
		<!--<script src="../../js/vconsole.min.js"></script>-->
		<script type="text/javascript">
			// var vConsole = new VConsole();
			mui.init({
				swipeBack: false
			});

			var self;
			var viewApi = mui('#app').view({
				defaultPage: '#mui-content'
			});
			var isShow = false;
			var Year; //选择查看的年份
			var currentYear; //当前年份
			var currentMonth; //当前月份
			var mask = mui.createMask();
			var dtPicker = "";
			var url = ""; //pdf的路径
			var path = "";
			var fileName = ''; //存储文件名，用于复制到粘贴板
			/*参数：'datetime'-完整日期视图(年月日时分)
			        'date'--年视图(年月日)
			        'time' --时间视图(时分)
			        'month'--月视图(年月)
			        'hour'--时视图(年月日时)
			*/
			// dtPicker = new mui.DtPicker({
			// 	type: 'month',
			// 	beginDate: new Date(2020, 00), //设置开始日期
			// 	endDate: new Date(currentYear, currentMonth - 1), //设置结束日期
			// });
			//页面初始化完成渲染

			mui.plusReady(function() {
				self = plus.webview.currentWebview();
				var curr = new Date();
				currentYear = curr.getFullYear();
				currentMonth = curr.getMonth() + 1;
				dtPicker = new mui.DtPicker({
					type: 'month',
					beginDate: new Date(2020, 00), //设置开始日期
					endDate: new Date(currentYear, currentMonth - 1), //设置结束日期
				});
				self.setStyle({
					scalable: true,
					titleNView: {
						buttons: [{
							"color": "white",
							"colorPressed": "gray",
							"float": "right",
							"fontWeight": "200",
							"fontSize": "8px",
							"fontSrc": "../../fonts/iconfont.ttf",
							"text": '● ● ●',
							"onclick": function() {
								isShow = !isShow;
								if (isShow) {
									$("#home-item").show();
									mask.show()
								} else {
									$('#home-item').hide();
									mask.close();
								}
							},
							"width": "60px",
						}],
					}
				});
				// initMonth();
				initPDFopen();
			});

			// 选择日期
			$("#selDate").click(function() { // selDate , dateSelect
				dtPicker.show(function(selectItems) {
					var y = selectItems.y.text; //获取选择的年
					var m = selectItems.m.text; //获取选择的月
					var date = y + "-" + m;
					Year = y;
					$("#selDate").val(date);
					selectMonth(m);
				})
			});

			var initPDFopen = function() {
				app.toast("加载PDF文件中")

				var date = new Date();
				Year = date.getFullYear();
				var Month = date.getMonth()

				if (Month <= 0) {
					Year = Year - 1;
					Month = 11
				}
				selectMonth(Month);
			}

			var selectMonth = function(month) {
				var beginTime;
				var endTime;
				var Month = month;
				var btnId = "month" + month;
				$("#selDate").val(Year + "-" + month);

				console.log(currentYear)
				console.log(Year)
				console.log(currentMonth)
				console.log(Month)
				if (currentYear >= Year && currentMonth != Month) {
					//获取本年本月的第一天日期
					var date = new Date(Year, month - 1, '01');
					//设置日期
					date.setDate(1);
					//设置月份
					date.setMonth(month);
					//获取本月的最后一天
					cdate = new Date(date.getTime() - 1000 * 60 * 60 * 24);
					endTime = Year + "-" + Month + "-" + cdate.getDate();
				} else {
					var today = new Date().getDate();
					var endTime = Year + "-" + Month + "-" + today;
				}
				beginTime = Year + "-" + Month + "-" + "01";
				var loginUser = app.userInfo().realname

				getPDFResourse({
					beginTime,
					endTime,
					month,
					loginUser
				});

			}

			var getPDFResourse = function(params) {
				url = config.urls.baseUrl + config.actions.monthReport + "?beginTime=" + params.beginTime + "&endTime=" +
					params.endTime +
					"&month=" + params.month + "&loginUser=" + params.loginUser;

				console.log(url)
				$("#pdfContainer").attr("src", "../defects/web/viewer.html?file=" + encodeURIComponent(url));
				// dtPicker.hide()
			}

		$("#gcjg").on('tap', function () {
			clearGlobalItem();
			console.log("进入工程管理")
			var extras = {menuAuth: getSubMenuAuthWithID("gcjg")}
			app.openPage("view/engineering/overview/projectList.html", {
				titleNView: {
					titleText: '工程建管',
					autoBackButton: true,
				}
			}, extras);
		});

			//点击下载按钮
			$(document).on("click", "#downloadBtn", function() {
				isShow = false;
				$('#home-item').hide();
				mask.close();
				if (path == "") {
					createDownloadTask();
				} else {
					app.toast("下载完成，文件保存路径：" + path)
					// $("#openWPS").trigger("tap"); //触发打开wps事件
					plus.runtime.openFile("/storage/emulated/0/" + path, {}, function (e) { //调用第三方应用打开文件

					});
				}
			})

			//打开wps
			$("#openWPS").on('tap', function() {
				isShow = false;
				$('#home-item').hide();
				mask.close();
				openWPS();
			})

			function openWPS() {
				var btnArray = ['否', '是']; //弹框消息确认是否打开附件
				mui.confirm('是否打开WPS？', '打开WPS', btnArray, function(e) {
					if (e.index == 1) { //打开附件
						// app.toast("正在打开WPS,请稍后。")
						copyName(fileName) //复制文件名到粘贴板
						// plus.runtime.openFile(fe.filename, {}, function(e) { //调用第三方应用打开文件
						plus.runtime.launchApplication({
							pname: "cn.wps.moffice_eng" //wps包名，用来检测是否安装wps
						}, function(e) {
							app.toast("检查到您未安装WPS,请先下载安装。")
						});
						// });
					}
				})
			}

			function createDownloadTask() {
				app.toast("正在下载");

				console.log("URL:"+url);
				dtask = plus.downloader.createDownload(url, {}, function(d, status) {
					// console.log(JSON.stringify(d))
					if (status == 200) { // 下载成功
						var fileSaveUrl = plus.io.convertLocalFileSystemURL(d.filename);
						console.log(fileSaveUrl)
						moveFile(fileSaveUrl)
					} else { //下载失败
						plus.downloader.clear();
						app.toast("下载失败");
					}
				});
				dtask.start();
			}

			function moveFile(filePath) {
				plus.io.resolveLocalFileSystemURL('file:///storage/emulated/0/DownLoad/', function(picDE) {
						plus.io.resolveLocalFileSystemURL(filePath, function(fileEntry) {
							var timestamp = Date.parse(new Date());
							fileEntry.moveTo(picDE, "月报" + timestamp + ".pdf", function(fe) {
								path = fe.fullPath.replace("/storage/emulated/0/", '')
								console.log("月报" + timestamp)
								fileName = "月报" + timestamp;
								app.toast("下载完成，文件保存路径：" + path)
								// window.location = "KingsoftOfficeApp://";
								plus.runtime.openFile("/storage/emulated/0/" + path, {}, function (e) { //调用第三方应用打开文件

								});
								// openFile()
							}, function(error1) {
								console.log(JSON.stringify(error1));
								app.toast('下载失败')
							});
						}, function(error2) {
							console.info("error2:" + error2.message);
						});
					},
					function(error3) {
						console.info("error:" + error3.message);
					});
			}

			function copyName(name) {
				if (mui.os.android) {
					var Context = plus.android.importClass("android.content.Context");
					var main = plus.android.runtimeMainActivity();
					var clip = main.getSystemService(Context.CLIPBOARD_SERVICE);
					plus.android.invoke(clip, "setText", name);
				} else {
					var UIPasteboard = plus.ios.importClass("UIPasteboard");
					var generalPasteboard = UIPasteboard.generalPasteboard();
					// 设置/获取文本内容:
					generalPasteboard.setValueforPasteboardType(name, "public.utf8-plain-text");
					var value = generalPasteboard.valueForPasteboardType("public.utf8-plain-text");
				}
			}
			mui.back = function() {
				self.close()
			}

			// function openFile() {
			// 	var Intent = plus.android.importClass('android.content.Intent')
			// 	var intent = new Intent();
			// 	var Bundle = plus.android.importClass('android.os.Bundle');
			// 	var bundle = new Bundle();
			// 	bundle.putString("OpenMode", "ReadMode");
			// 	bundle.putBoolean("SendCloseBroad", true);
			// 	bundle.putString("ThirdPackage", "com.android.settings");
			// 	bundle.putBoolean("ClearBuffer", true);
			// 	bundle.putBoolean("ClearTrace", true); //这部分都是一些参数 ，wps官网上有解释，大家自己可以去看
			// 	intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
			// 	intent.setAction("android.intent.action.VIEW");
			// 	intent.setAction("android.intent.action.EDIT");
			// 	intent.setType("application/pdf"); //这两个参数时重点，小弟我开始没有设置这两个参数，"cn.wps.moffice_i18n"这个版本的wps始终无法打开pdf文档，最后通过反编译才找到这两东东的
			// 	intent.setClassName("cn.wps.moffice_i18n", "cn.wps.moffice.documentmanager.PreStartActivity"); //包名  类名  不多说
			// 	File file = null;
			// 	if (Locale.getDefault().getLanguage().equals("en")) { //语言判断
			// 		file = new File("/" + name);
			// 	} else if (Locale.getDefault().getLanguage().equals("th")) {
			// 		file = new File(name);
			// 	}
			// 	if (file == null || !file.exists()) {
			// 		return false;
			// 	}
			// 	Uri uri = Uri.fromFile(file);
			// 	intent.setData(uri);
			// 	intent.putExtras(bundle);

			// 	try {
			// 		getActivity().startActivity(intent);
			// 	} catch (Exception e) {
			// 		e.printStackTrace();
			// 		return false;
			// 	}
			// 	return true;
			// }
		</script>
	</body>

</html>
