<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>排水户-列表</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/common.css" rel="stylesheet" />
		<style>
		.view-content-item{
			height: auto;
			margin: 0px 20px;
			border-bottom: 1px solid #EDEDED;
		}

		.view-content-item .view-title{
			font-size:14px;
			color:#444444;
			text-align: left;
			padding:20px 0px 20px 0;

		}

		.bottom-btn{
			width: 100%;
			height: 100px;
			background: #f6f4f7;
			line-height: 100px;
			position: absolute;
			bottom: 0;
			z-index: 99;
		}
		.btn-item{
			width: 100%;
			float: left;

		}

		.btn-item div{
			margin: 0 auto;
			border: 1px solid #337BFC;
			width: 85%;
			height: 40px;
			line-height: 40px;
			border-radius: 50px;
			margin-top: 30px;

		}

		.view-select{
			text-align: left;
			color: #191515;
			font-size: 16px;
			margin-bottom: 21px;
		}

		.search-tip {
			display: block;
		}

		.search-tip span{
			font-size:14px;
			color:rgba(51,123,252,1);
		}

		.search-tip img{
			width: 14px;
		}

		.select-query-list{
			border-bottom: 1px solid #eee;
			height: 40px;
			margin-top: 15px;
		}

		.select-query-list-title{
			width: 70%;
			float: left;
			text-align: left;
			overflow: hidden;
			text-overflow: ellipsis;  
			white-space: nowrap; 
		}

		.select-query-list-img-status{
			width: 30%;float: left;
		}
		.select-query-list-img-status img{
			width: 50px;
		}

		.item-state {
			width: 30%;
			float: left;
			text-align: right;
			padding: 0 0 0 5px;
		}
		.item-state span {
			padding: 5px 15px;
			color: #337BFC;
			font-size: 12px;
		}

		.no-data {
			line-height: 100px;
			display: inline-block;
			width: 100%;
			text-align: center;
			font-size: 16px;
			color: #999;
		}
	</style>
	</head>

	<body>
		<!--页面主结构开始-->
		<div id="app" class="mui-views">
			<div class="mui-view">
				<div class="mui-navbar">
				</div>
				<div class="mui-pages">
				</div>
			</div>
		</div>
		<!--页面主结构结束-->
		<!--单页面开始-->
		<div class="bottom-btn">
			<div class="btn-item" id="psh_add">
				<div style="background: #337BFC;color: #fff;">排水户登记</div>
			</div>
		</div>		
		<div id="mui-content" class="mui-page">
			<!--页面标题栏开始-->
			<!-- <header class="mui-bar mui-bar-nav common-header">
				<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
				<h1 class="mui-title">排水户列表</h1>
			</header> -->
			<!--页面标题栏结束-->
			<!--页面主内容区开始-->
			<div class="mui-page-content">
				<div class="mui-scroll-wrapper" style="margin-bottom: 100px;background-color: #FFFFFF;">
					<div class="mui-scroll" >
						<div class="search-bar">
							<div class="search-item">
								<div class="search-icon">
									<img src="../../img/commom/search1@2x.png" />
								</div>
								<div class="search-input">
									<div class="mui-input-row" style="text-align: left;">
										<input id="searchInput" type="text" style="width: 90%;" class="mui-input-clear" placeholder="请输入排水户名称">
									</div>
								</div>
							</div>
						</div>
						<div class="scroll-li">
							<div class="view-content" id="maplocation">
								<div class="view-content-item">
									<div class="view-title">
										门牌地址
									</div>
									<div id="addressSelect" class="view-select">
										<!-- 福田区/福田街道事处/福保社区工作站/绒花路/94号(富华里） -->
									</div>
								</div>
							</div>
						</div>
						<div style="background: #F4F4F4;height: 5px;"></div>
						<div class="scroll-li">
							<div class="view-content">
								<div class="view-content-item" id="psh-items">
									<div class="view-title search-tip">
										<img src="../../img/commom/dz@2x.png" />
										<span id="num">
											该门牌地址下共有排水户：0
										</span>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!--页面主内容区结束-->
		</div>

	</body>
	<script src="../../js/mui.min.js"></script>
	<script src="../../js/mui.view.js"></script>
	<script src="../../js/mui.locker.js"></script>

	<script src="../../js/app.js"></script>
	<script src="../../js/config.js"></script>
	<script src="../../js/jquery.min.js"></script>
	<script src="../../js/common.js"></script>
	<script src="../../js/paishuihu.js"></script>
	<script src="../../js/s4.js"></script>
	<script src="../../js/smutils.js"></script>
	<script src="../../js/byte&string.js"></script>
	<script src="../../js/ajaxhook.min.js"></script>
	<!-- <script src="../../js/vconsole.min.js"></script> -->
	<script type="text/javascript">
		// var vConsole = new VConsole();
		mui.init({swipeBack:false});
		//初始化单页view
		var viewApi = mui('#app').view({
			defaultPage: '#mui-content'
		});

		//初始化单页的区域滚动
		mui('.mui-scroll-wrapper').scroll();
		
		var address = "";
		var listData = [];
		var total;
		mui.plusReady(function() {
			var self = plus.webview.currentWebview();
			self.setStyle({  
			    titleNView: {  
			      buttons: [{
			      	float: 'right',
					width:'80',
			      	fontSize: '17', 
			      	text: '全部' ,
					onclick:done
			      }]
			    }  
			});
			address = globalGetItem(GlobalKey.address);
			var psh = globalGetItem(GlobalKey.psh);
			if (psh) {
				var pshItem = JSON.parse(psh);
				address = pshItem.address
				console.log(pshItem.address)
			}
			
			
			queryPSHByMapLocation(address);
		});
		
		//全部排水户
		var done = function(){
			var extras = { point : plus.webview.currentWebview().point}
			app.openPage("paish_alllist.html", {
				titleNView: {
					titleText: '排水户',
					autoBackButton: true,
				}
			},extras);
		}
		
		//根据门牌地址查询排水户
		var queryPSHByMapLocation = function(address, name){
			var address_text = globalGetItem(GlobalKey.address);
			$("#addressSelect").html(address_text);
			getPshByAddress(address, name, function(data) {
				console.log("address:"+address);
				var testStr = "&nbsp;&nbsp;";
				console.log(JSON.stringify(data));
				total = data.result.total;
				if(!name) $("#num").html("该门牌地址下共有排水户：" + total);
				if(total > 0) {
					// $("#psh-items").css("border-bottom","1px solid #eee")
					listData = data.result.records;
					$(".select-query-list").remove();
					for (var i = 0; i < total; i++) {
						var state = "";
						/*if(0== parseInt(data.result.records[i].state)){
                            state = '<img src="../../img/commom/wsh@2x.png" />';
                        } else if(1== parseInt(data.result.records[i].state)|| 2== parseInt(data.result.records[i].state)){
                            state = '<img src="../../img/commom/ysh@2x.png" />';
                        }*/
						if(parseInt(data.result.records[i].state) == 0) {
							state = '<span>暂存</span>	';
						} else if(parseInt(data.result.records[i].state) == 1) {
							state = '<span>流转中</span>	';
						} else if(parseInt(data.result.records[i].state) == 2) {
							state = '<span>已完成</span>	';
						}
						str = '<div class="select-query-list" data-index="'+ i +'">' +
								'      <div class="select-query-list-title">' +
								'      	' + (i + 1) + testStr + data.result.records[i].dischargerName + '' +
								'      </div>' +
								// '      <div class="select-query-list-img-status">' +
								'      <div class="item-state">' +
								state +
								'       </div> ' +
								'     </div>'
						$("#psh-items").append(str)
					}
					$(".select-query-list").each(function() {
						$(this).click(function() {
							let index = $(this).attr("data-index")
							queryByGuid(listData[index].guid, function (data) {
								if (data.result) {
								    console.log("排水户信息byGuid:"+JSON.stringify(data.result))
									globalSetItem(GlobalKey.id, listData[index].guid);//选中排水户的id
									var extras = {
										data: data.result,
										returnUrl: 'paish_list.html'
									}
									app.openPage("paish_showOne.html", {
										titleNView: {
											titleText: '查看排水户',
											autoBackButton: true,
										}
									}, extras);
								} else {
									app.toast('网络异常,无法获取排水户信息,请稍后再试');
								}
							})
						});
					});
				} else {
					let noData = '<div class="no-data">暂无数据</div>'
					$("#psh-items").css("border","none");
					$("#psh-items").html(noData)
				}
			})
		}

		$("#searchInput").bind('input propertychange', function() {
			let inputData = $("#searchInput").val();
			if(inputData.length == 0) $("#psh-items").html('')
			queryPSHByMapLocation(address, inputData);
		})

		//清除
		$(".search-input").on("tap", ".mui-icon-clear", function() {
			queryPSHByMapLocation(address);
			$("#psh-items").html('')
		})

		$("#maplocation").on("tap", function() {
			var extras = {}
			app.openPage("paish_viewAddress.html", {
				titleNView: {
					titleText: '门牌地址定位',
					autoBackButton: true,
				}
			},extras);
		});
		// //选择门牌定位返回
		// window.addEventListener('resultMapSelect', function(data) {
		// 	map = data.detail.map;
		// 	point = data.detail.point;
		// 	queryPSHByMapLocation(map.addressComponent.address)
		// });

		$("#psh_add").on("tap", function() {
            // var point ={"lng":114.04416918754578,"lat":22.553064823150635}
						
            var point = plus.webview.currentWebview().point
			app.openPage("paish_viewAddress.html", {
				titleNView: {
					titleText: '排水户登记',
					autoBackButton: true,
				}
			}, { returnUrl: 'paish_list.html' ,type: 'add',point:point});
		});
		
	</script>

</html>
