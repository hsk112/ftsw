<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>排水户-信息</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/mui.picker.min.css" rel="stylesheet" />
		<link href="../../css/mui.poppicker.css" rel="stylesheet" />
		<link href="../../css/common.css" rel="stylesheet" />
		<style>
			.options-box {
				position: absolute;
				top: 0;
				z-index: 10;
				display: flex;
				padding: 1rem 1rem 1.5rem;
				width: 100%;
				height: 10vh;
				background-color: #fff;
			}
			.options-box span{
				font-size: 14px;
				color: #999;
			}
			.options-box .active {
				color: #337BFC;
				font-size: 16px;
			}
			.options {
				flex: 1;
				text-align: center;
			}
			.content-box {
				position: relative;
				margin-top: 10vh;
				height: 90vh;
			}
			.paish .info-bar-content-item .item-title {
				padding: 15px 0px;

			}
			.paish .info-bar-content-item {
				height: 186px;
			}
			.item-box {
				margin-bottom: 10px;
				padding: 0.5rem 0 0;
				border: 1px solid #EEEEEE;
			}
			.item-content {
				margin-bottom: 0.5rem;
				text-align: left;
				color: #999999;
				font-size: 1rem;
				margin-left: 10px;
			}
			.item-no-data {
				width: 100%;
				height: 112px;
				line-height: 112px;
				text-align: center;
				color: #999;
				font-size: 16px;
			}

		</style>
	</head>

	<body>
		<!--页面主结构开始-->
		<div id="app" class="mui-views">
			<div class="mui-view">
				<div class="mui-navbar">
				</div>
				<div class="mui-pages">
				</div>
			</div>
		</div>
		<!--页面主结构结束-->
		<!--单页面开始-->
		<div id="mui-content" class="mui-page paish">
			<!--页面标题栏开始-->
			<!-- <header class="mui-bar mui-bar-nav common-header">
				<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
				<h1 class="mui-title">排水户登记</h1>
			</header> -->
			<!--页面标题栏结束-->
			<!--页面主内容区开始-->
			<div class="mui-page-content">
				<div class="options-box">
					<span id="showOne" class="options">基本信息</span>
					<span>|</span>
					<span id="showSec" class="options">证照信息</span>
					<span>|</span>
					<span id="showThe" class="options active">排口信息</span>
					<span>|</span>
					<span id="showFou" class="options">扩展信息</span>
				</div>
				<div class="content-box">
					<div class="mui-scroll-wrapper" id="wrapper">
						<div class="mui-scroll" id="content">
							<div class="scroll-li">
								<div class="bar-title">
									排水构筑物信息
								</div>
								<div class="info-bar-content">
									<div class="info-bar-content-item">
										<div class="item-title psgzw">
							
										</div>
										<div id="info1" class="mui-input-row item-input" style="margin-bottom: 13px;  ">
											<div class="item-no-data">暂无数据</div>
										</div>
									</div>
								</div>
							</div>
							<div class="scroll-li">
								<div class="bar-title">
									接驳管信息
								</div>
								<div class="info-bar-content">
									<div class="info-bar-content-item">
										<div class="item-title pcg">
											<!-- 地图选择接驳管 -->
										</div>
										<div id="info2" class="mui-input-row item-input" style="margin-bottom: 13px;">
											<div class="item-no-data">暂无数据</div>											
										</div>
									</div>
								</div>
							</div>
							<div class="scroll-li">
								<div class="bar-title">
									接驳井情况
								</div>
								<div class="info-bar-content">
									<div class="info-bar-content-item">
										<div class="item-title jcj">
											<!-- 地图选择接驳井 -->
										</div>
										<div id="info3" class="mui-input-row item-input" style="margin-bottom: 13px;">
											<div class="item-no-data">暂无数据</div>
										</div>
									</div>
									<div class="info-bar-content-item" style="height: 95px;">
										<div class="item-title">审批人</div>
										<input id="approverUsername" style="display: none;"/>
										<div class="mui-input-row item-input">
											<input id="approverFullname" style="height:20px" type="text" readonly>
										</div>
									</div>
								</div>
							</div>
							<div class="bottom-btn" >
								<!--<div class="btn-item" id="psh_update">-->
								<div class="btn-item" id="back">
									<div style="color: #337BFC;margin-top: 15px;">返 回</div>
								</div>
								<div class="btn-item" id="psh_add">
									<div style="background: #337BFC;color: #fff;margin-top: 15px;">新增排水户</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!--页面主内容区结束-->
		</div>
	</body>

	<script type="text/javascript" src="http://gd.wiseom.cn/supermap/mapbox-gl-enhance.js"></script>
	<script type="text/javascript" src="http://gd.wiseom.cn/supermap/iclient-mapboxgl.min.js"></script>
	<script src="http://gd.wiseom.cn/mobile-lib/mobile-lib.umd.js"></script>

	<script src="../../js/mui.min.js"></script>
	<script src="../../js/mui.view.js"></script>
	<script src="../../js/mui.locker.js"></script>
	<script src="../../js/mui.picker.min.js"></script>
	<script src="../../js/mui.poppicker.js"></script>

	<script src="../../js/app.js"></script>
	<script src="../../js/config.js"></script>
	<script src="../../js/jquery.min.js"></script>
	<script src="../../js/common.js"></script>	
	<script src="../../js/paishuihu.js"></script>
	<script src="../../js/helper.js"></script>
	<script src="../../js/uploadimage.js"></script>
	<script src="../../js/s4.js"></script>
	<script src="../../js/smutils.js"></script>
	<script src="../../js/byte&string.js"></script>
	<script src="../../js/ajaxhook.min.js"></script>
	<script>
		var self;

		mui.init({swipeBack:false});
		//初始化单页view
		var viewApi = mui('#app').view({
			defaultPage: '#mui-content'
		});

		//初始化单页的区域滚动
		mui('.mui-scroll-wrapper').scroll();

		const mapData = window['mobile-lib'].MapData({
			serverUrl: config.urls.serverDomain,
			style: 'color'
		});

		mui.plusReady(function() {
			self = plus.webview.currentWebview();

			// 页面选择
			initPageSelect();

			// 赋值
			initData();
		});

		// 页面选择
		var initPageSelect = function() {
			$("#psh_update").on("tap", function() {
				// app.openPage("paish_stepOne.html", {
				// 	titleNView: {
				// 		titleText: '排水户登记',
				// 		autoBackButton: true,
				// 	}
				// }, { returnUrl: 'paish_showThe.html'  ,type : 'edit'});
				globalSetItem(GlobalKey.psh, JSON.stringify(self.data));
				globalSetItem(GlobalKey.isSelectPsh, "true");
				// console.log(JSON.stringify(globalGetItem(GlobalKey.psh)))
				app.openPage("paish_viewAddress.html", {
					titleNView: {
						titleText: '门牌地址',
						autoBackButton: true,
					}
				}, { returnUrl: 'paish_showOne.html' ,type : 'edit'});
			});

			$("#psh_add").on("tap", function() {
				globalSetItem(GlobalKey.psh, JSON.stringify(self.data));
				globalSetItem(GlobalKey.isSelectPsh, "true");
				app.openPage("addPaishuihu.html", {
					titleNView: {
						titleText: '新增排水户',
						autoBackButton: true,
					}
				}, { returnUrl: 'paish_showThe.html'  ,type : 'add'});
			});

			$("#showOne").on("tap", function() {
				app.openPage("paish_showOne.html", {
					titleNView: {
						titleText: '查看排水户',
						autoBackButton: true,
					}
				}, { data: self.data, returnUrl: self.returnUrl });
			});

			$("#showSec").on("tap", function() {
				app.openPage("paish_showSec.html", {
					titleNView: {
						titleText: '查看排水户',
						autoBackButton: true,
					}
				}, { data: self.data, returnUrl: self.returnUrl });
			});
		}

		// 赋值
		var initData = function () {		
			getPshConn(self.data.guid, function (data) {
				console.log(JSON.stringify(data))
				if(data.success){
					let obj = data.result;				
					if (obj.structures && obj.structures.length > 0) {
						$('#info1').hide();
						let px = obj.structures.length * 160 +50 + 'px';
						$('.psgzw').parent().css('height', px);
						for(let i = 0;i< obj.structures.length;i++) {	
							let item = obj.structures[i];
							var expNo = "构建物编号: " + item.expNo;
							if (item.expNo == null) expNo = "构建物编号: 无";
							//尺寸大小
							var size = "尺寸(m*m*m): " + item.size;
							if (item.size == null) size = "尺寸(m*m*m): 无";
							//排水预处理方式
							var treatmentMethod = "排水预处理方式: " + item.treatmentMethod;
							if (item.treatmentMethod == null) treatmentMethod = "排水预处理方式: 无";
							//排水预处理能力
							var treatmentCapacity = "排水预处理能力: " + item.treatmentCapacity;
							if (item.treatmentCapacity == null) treatmentCapacity = "排水预处理能力: 无";
							//埋深
							var burDepth = "埋深(m): " + item.burDepth;
							if (data.result.burDepth == null) burDepth = "埋深(m): 无";

							var htmlStr = '<div class="item-box">' +
									'<div class="item-test-item">' +expNo+
									'</div>' +
									'<div class="item-test-item">' +burDepth+
									'</div>' +
									'<div id="itTreatment" class="item-content">' +
									size +
									'</div>' +
									'<div class="item-content">' +
									treatmentCapacity +
									'</div>' +
									'<div class="item-content">' +
									treatmentMethod +
									'</div>' +
									'</div>';
							$(".psgzw").append(htmlStr);							
						}
					}
					if (obj.disChargeLine && obj.disChargeLine.length > 0) {					
						$('#info2').hide();
						// console.log(obj.disChargeLine.length)
						let px = obj.disChargeLine.length * 136 +50 + 'px';
						// console.log(px)
						$('.pcg').parent().css('height', px);
						for(let i = 0;i< obj.disChargeLine.length;i++) {						
							let item = obj.disChargeLine[i];
							//管线种类
							var lineType_textValue = "管线种类: " + item.lineType_textValue;
							if (item.lineType_textValue == null) lineType_textValue = "管线种类:无";
							var ePointExpNo = "终点管线编号: " + item.ePointExpNo;
							if (item.ePointExpNo == null) ePointExpNo = "终点管线编号:无";
							//断面尺寸(mm)
							var spec = "断面尺寸(mm): " + item.spec;
							if (item.spec == null) spec = "断面尺寸(mm): 无"
							//终点管线埋深(m)
							var eDeep = "终点管线埋深(m): " + item.eDeep;
							if (item.eDeep == null) eDeep = "终点管线埋深(m): 无"
							//材质
							var lineMaterial = "材质: " + item.lineMaterial_dictText;
							if (item.lineMaterial_dictText == null) lineMaterial_dictText = "材质: 无"

							var htmlStr = '<div class="item-box">' +
									'<div class="item-content">' +
									ePointExpNo +
									'</div>' +
									'<div class="item-content">' +
									'<div style="width:50%;margin-right: 20px;display:inline-block">' + lineType_textValue + '</div>' +
									'<div style="width:40%;display:inline-block">' + lineMaterial + '</div>' +
									'</div>' +
									'<div id="itLine" class="item-content">' +
									spec +
									'</div>' +
									'<div class="item-content">' +
									eDeep +
									'</div>' +
									'</div>';
							$(".pcg").append(htmlStr);
						}
					}
					if (obj.transportWell && obj.transportWell.length > 0) {
						$('#info3').hide();
						let px = obj.transportWell.length * 136 +50 + 'px';
						$('.jcj').parent().css('height', px);
						for(let i = 0;i< obj.transportWell.length;i++) {
							let item = obj.transportWell[i];
							//接驳井编号
							var expNo = "接驳井编号: " + item.expNo;
							if (item.expNo == null) expNo = "接驳井编号: 无";
							//接驳井类型
							var chamberType_dictText = "接驳井类型: " + item.chamberType_dictText;
							if (item.chamberType_dictText == null) chamberType_dictText = "接驳井类型: 无";
							//井盖尺寸(mm)
							var pointSize = "井盖尺寸(mm): " + item.pointSize;
							if (item.pointSize == null) pointSize = "井盖尺寸(mm): 无";
							//井深(m)
							var pointDepth = "井深(m): " + item.pointDepth;
							if (item.pointDepth == null) pointDepth = "井深(m): 无";
							//井盖材质
							var materialType_dictText = "井盖材质: " + item.materialType_dictText;
							if (item.materialType_dictText == null) materialType_dictText = "井盖材质: 无";
							//接入管数
							var pointPipes = "接入管数: " + item.pointPipes;
							if (item.pointPipes == null) pointPipes = "接入管数: 无";

							var htmlStr = '<div class="item-box">' +
									'<div class="item-content">' + expNo +							
									'</div>' +
									'<div class="item-content">' +									
									'<div style="width:50%;margin-right: 20px;display:inline-block">' + pointPipes + '</div>' +
									'<div style="width:40%;display:inline-block">' + chamberType_dictText + '</div>' +
									'</div>' +
									'<div class="item-content">' +
									'<div style="width:50%;margin-right: 20px;display:inline-block">' + materialType_dictText + '</div>' +
									'<div style="width:40%;display:inline-block">' + pointDepth + '</div>' +
									'</div>'+
									'<div id="itManhole" class="item-content">' +
									pointSize +
									'</div>' +
									'</div>';
									
							$(".jcj").append(htmlStr);
						}
					}				
				}else app.toast("获取失败")
			})
			if(self.data.approverFullname) $("#approverFullname").val(self.data.approverFullname);
			else $("#approverFullname").val('无');		
		}

		mui.back = function () {
			let url = self.returnUrl;
			popToTarget(url);
		}
		window.addEventListener('backShowInfo', function(e) { //执行刷新
			// location.reload();
			
			queryByGuid(self.data.guid, function(data){				
				if (data.success && data.result!=null){		
					console.log(333333333)
					globalSetItem(GlobalKey.address, data.result.address );
										
					var point = {
						'lng':data.result.longitude,
						'lat':data.result.latitude
					}
					
					self.data = data.result;
					globalSetItem(GlobalKey.point, JSON.stringify(point));//选中地图点
					globalSetItem(GlobalKey.isSelectPsh, "true");//是否设置排水户
					globalSetItem(GlobalKey.psh, JSON.stringify(data.result));//保存选中的排水户
					globalSetItem(GlobalKey.id, self.data.guid);//选中排水户的id
					
					initPageSelect();
					
					// 赋值
					initData();
				
					mui('#wrapper').scroll().scrollTo(0,0,100);
				} else {
					clearGlobalItem();
					globalSetItem(GlobalKey.isSelectPsh, "false");//是否设置排水户					
				}
				
			});
		});
        $("#back").on('tap',function(){
            let url = self.returnUrl;
            popToTarget(url);
        })
	</script>
</html>
