<!doctype html>
<html>

	<head>
		<meta charset="utf-8">
		<title>档案-预览</title>
		<!-- <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" /> -->
		<meta name="viewport" id="viewport" content="width=device-width, initial-scale=1,minimum-scale=1,maximum-scale=10,user-scalable=yes">
		<link href="css/mui.css" rel="stylesheet" />
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/jquery.min.js"></script>
		<!-- <script src="./build/pdf.js" type="text/javascript"></script> -->
		<script src="../../js/app.js"></script>
		<script src="../../js/config.js"></script>
		<script src="../../js/conservation.js"></script>
		<script src="../defects/web/viewer.js"></script>
		<!-- <script src="web/viewer.js"></script> -->
		<style>
			body{
				margin: 0;
			}
			#showPdf{
				height: 100%;
			}
			#showPdf #pdfContainer{
				height: 100vh;
			}
			.dialog{
				background: rgba(0,0,0,0.3);
				width: 100vw;
				height: 100vh;
				position: fixed;
				left: 0;
				top: 0;
				text-align: left;
				z-index: 10;
			}
			.dialog_div{
				width:90%;
				height: 180px;
				background: #FFFFFF;
				border-radius: 14px;
				position: absolute;
				top: 30%;
				z-index: 999;
				border: 1px solid #DEDEDE;
				left: 5%;
			}
			.icon{
				display: inline-block;
				width: 30px;
				height: 30px;
				background: #337BFC;
				border-radius: 50%;
				font-size: 22px;
				color:#FFFFFF;
			}
			.span1{
				width: 30px;
				line-height: 30px;
				padding-left: 8px;
				padding-top: 6px;
			}
			.span2{
				display: inline-block;
				line-height: 40px;
			}
			.cancelBtn{
				display: inline-block;
				text-align: center;
				border: 1px solid #337BFC;
				border-radius: 40px;
				color: #337BFC;
				width: 100px;
				margin-bottom:30px;
				line-height: 40px;
			}
			.printBtn{
				display: inline-block;
				text-align: center;
				border-radius: 40px;
				background: #337BFC;
				color: #fff;
				width: 100px;
				margin-left: 10%;
				line-height: 40px;
			}
			li{
				list-style-type:none;
				line-height: 30px;
				border-bottom: 1px solid #EDEDED ;
				padding-top: 10px;
			}
			.num{
				padding-right: 10px;
				font-size: 14px;
				font-weight: 400;
				color: #191515;
				vertical-align: top;
			}
			.deviceName{
				width: 90%;
				overflow: hidden;
				text-overflow: ellipsis;  
				white-space: nowrap; 
				display: inline-block;
			}
			.mui-backdrop {
			    position: fixed;
			    top: 0;
			    right: 0;
			    bottom: 0;
			    left: 0;
			    z-index: 98;
			    background-color: rgba(0,0,0,0.2);
			}
			.home-item{
				border-radius: 15px 15px 0 0;
				position: fixed;
				bottom: 0px;
				left: 0px;
				width: 100%;
				background-color: #FFFFFF;
				z-index: 99;
			}
			.bottom-item{
				line-height: 50px;
				border-bottom: 1px solid #DEDEDE;
				margin: 0 10px;				
				font-size: 16px;
				font-weight: bold;
				color: #191515;
				text-align: center;
			}
			/* 自定义 */
			.toolbar {
				display: none !important;
			}
			#viewer {
				width: 100%;
				height: 100%;
			}
		</style>
	</head>

	<body>
		<div class="home-item" style="display: none;" id="home-item">
			<div class="bottom-item" id="downloadBtn">下载</div>
			<!-- <div class="bottom-item" id="printBtn">打印</div> -->
			<div class="bottom-item" id="cancelButton">取消</div>
		</div>
		
		<div id="showPdf">
			<iframe id="pdfContainer" src="" width="100%" frameborder="0"></iframe>
		</div>
<!-- 		<div style="margin:20px;border: 1px solid #EDEDED !important;">
		<div style="padding:10px;border-bottom: 1px solid #EDEDED !important;">
			<div class="mui-title" id='search' style="text-align: center;">
				<img src="../../img/commom/search1@2x.png" style="height: 20px;width: 20px;"/>
				<span style="font-size: 16px;font-weight: 500;color: #999999;vertical-align: top;">搜索蓝牙设备</span>
			</div>
		</div>
		<div class="mui-content mui-content-padded" style="margin:20px;margin-top: 0;">
			<div id="loading" style="text-align: center;font-size: 16px;font-weight: 400;color: #999999;">搜索中...</div>
			<ul id="list" class="mui-table-view mui-table-view-chevron" style="margin-block-start: 0;padding-inline-start: 0px;height: 180px;overflow-y: auto;">
			</ul>
		</div>
		</div> -->
		<div class="dialog" id="dialog" style="display: none;">
			<div class="dialog_div">
				<!-- <div style="padding:30px;">
					<div class="icon">
						<span class="span1">√</span>
					</div>
					<div class="span2">打印成功，是否上传签字照片？</div>
				</div> -->
				<span style="margin-left: 20px;">文档地址：</span>
				<input id="pdfUrl" readonly="true" type="text" value="" style="border: 2px solid #EDEDED;height: 30px;width: 60%;margin-top:30px;border-radius: 10px;padding: 1px 5px;" />
				<div style="text-align: center;margin-top:30px">
					<div id="cancel" class="cancelBtn">关闭</div>
					<!-- <div id="toPrint" class="printBtn">上传</div> -->
					<div id="toCopy" class="printBtn">复制</div>
				</div>
			</div>
		</div>

		<script src="../../js/common.js"></script>
		<script src="../../js/vconsole.min.js"></script>
		<script src="../../js/s4.js"></script>
		<script src="../../js/smutils.js"></script>
		<script src="../../js/byte&string.js"></script>
		<script src="../../js/ajaxhook.min.js"></script>
		<script>
			// var vConsole = new VConsole();
			var url;
			var self;
			var isPrint = false;
			var isShow = false;
			var mask = mui.createMask();
			var path = ''
			//页面初始化完成渲染
			mui.init({
				swipeBack: false,
				beforeback: function() {
					popToTarget('proDetail.html');
				},
			});
			mui.plusReady(function() {
				// var proData = JSON.parse(plus.webview.currentWebview().proData);
				// console.log(proData)
				self = plus.webview.currentWebview();
				self.setStyle({
					scalable: true,
					titleNView: {
						buttons: [{
							"color": "white",
							"colorPressed": "gray",
							"float": "right",
							"fontWeight": "200",
							"fontSize": "8px",
							"fontSrc": "../../fonts/iconfont.ttf",
							"text": '● ● ●',
							"onclick": function() {
								isShow = !isShow;
								if (isShow) {
									$("#home-item").show();
									mask.show()
								} else {
									$('#home-item').hide();
									mask.close();
								}
							},
							"width": "60px",
						}],
					}
				});
				console.log("cnm")
				var proData = JSON.parse(plus.webview.currentWebview().proData);
				console.log(JSON.stringify(proData))
				var archId = proData.arch
				// main = plus.android.runtimeMainActivity();
				// BluetoothAdapter = plus.android.importClass("android.bluetooth.BluetoothAdapter");
				// UUID = plus.android.importClass("java.util.UUID");
				// uuid = UUID.fromString("00001101-0000-1000-8000-00805F9B34FB");
				// BAdapter = BluetoothAdapter.getDefaultAdapter();
				// scan(); //00:15:82:96:B4:9E

				// var url1=config.urls.baseUrl + "sys/common/view/ecidi/2ea696dc70284b4a8cae2675c3204a7a.docx" ;

				// if (self.projectId) {
				// 	url = config.urls.baseUrl + config.actions.previewPdf + '?guid=' + self.guid + '&projectId=' + self.projectId +
				// 		'&fileType=0'
				// 	console.log("if (self.projectId)");
				// 	console.log("======url");
				// 	console.log(url);
				//
				// 	$("#pdfContainer").attr("src", "../defects/web/viewer.html?file=" + encodeURIComponent(url));
				// 	console.log("pdfContainer.attr-src","../defects/web/viewer.html?file=" + encodeURIComponent(url));
				//
				// }
				// else
				if (archId) {
					url = config.urls.baseUrl + 'file/uploadFile/previewFileById?id=' + archId;
					console.log(url)
					$("#pdfContainer").attr("src", "../defects/web/viewer.html?file=" + encodeURIComponent(url));
					// console.log(" else if (self.guid)");
					// getFileForm({
					// 	superviseId: self.guid
					// }, function(data) {
					// 	console.log(JSON.stringify(data))
					// 	if (data.result != null) {
					// 		findFilesByGroupId({
					// 			groupId: data.result.superviseFile
					// 		}, function(data1) {
					//
					// 		});
					// 	}
					// });
				}
				// else {
				// 	console.log("==== else ");
				// 	url = config.urls.baseUrl + 'file/uploadFile/previewFileById?id=' + self.fileId;
				// 	console.log(url);
				// 	$("#pdfContainer").attr("src", "../defects/web/viewer.html?file=" + encodeURIComponent(url));
				// }

				$('#printBtn,#downloadBtn').on('tap', function() {
					print();
					$('#cancelButton').trigger("click");
				});
				
				$('#cancel').on('tap', function() {
					$('#dialog').hide();
					$("#viewport").attr("content",
						"width=device-width, initial-scale=1,minimum-scale=1,maximum-scale=10,user-scalable=yes")
					self.setStyle({
						scalable: true
					});
				});

				$('#toCopy').on('tap', function() {
					var txt = $("#pdfUrl").val();
					var i = txt.lastIndexOf("/");
					var j = txt.lastIndexOf(".") == -1?txt.length:txt.lastIndexOf(".");
					var name = txt.substring(i + 1, j);
					console.log(name)
					if(mui.os.android) {  
						var Context = plus.android.importClass("android.content.Context");  
						var main = plus.android.runtimeMainActivity();  
						var clip = main.getSystemService(Context.CLIPBOARD_SERVICE);  
						plus.android.invoke(clip, "setText", name);  
					} else {  
						var UIPasteboard = plus.ios.importClass("UIPasteboard");  
						var generalPasteboard = UIPasteboard.generalPasteboard();  
						// 设置/获取文本内容:  
						generalPasteboard.setValueforPasteboardType(name, "public.utf8-plain-text");  
						var value = generalPasteboard.valueForPasteboardType("public.utf8-plain-text");  
					}				
					app.toast("内容已复制到剪切板")
					$('#dialog').hide();
					$("#viewport").attr("content",
						"width=device-width, initial-scale=1,minimum-scale=1,maximum-scale=10,user-scalable=yes")
					self.setStyle({
						scalable: true
					});
				});

				// $('#toPrint').on('tap', function() {
				// 	console.log("上传。")
				// 	$("#viewport").attr("content",
				// 		"width=device-width, initial-scale=1,minimum-scale=1,maximum-scale=10,user-scalable=yes")
				// 	$('#dialog').hide();
				// 	self.setStyle({
				// 		scalable: true
				// 	});
				// 	app.openPage("./uploadImg.html", {
				// 		titleNView: {
				// 			titleText: '上传签字照片',
				// 			autoBackButton: true
				// 		}
				// 	}, {
				// 		returnUrl: 'proDetail.html'
				// 	});
				// })
			}); // mui.plusReady end

			function print() {
				// var domain = window.location.href;
				// var i = domain.lastIndexOf("view/")
				// domain = domain.substring(0, i + 4)
				// var src = $("#pdfContainer").attr("src");
				// src = src.substring(2, src.length);
				// var txt = domain + src;
				// $("#pdfUrl").val(txt)
				$("#viewport").attr("content",
					"width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no")
				// $('#dialog').show();
				app.toast("正在下载");
				if (isPrint == false) {
					isPrint = true; //防止多次点击重复下载
					createDownloadTask();
				} else {
					plus.runtime.openFile(path, {}, function (e) { //调用第三方应用打开文件
					    app.toast("下载完成，文件保存路径：" +  $("#pdfUrl").val())	
					});
				}

				self.setStyle({
					scalable: false
				});
			}

			function createDownloadTask() {			

				// var url = config.urls.baseUrl + 'file/uploadFile/previewFileById?id=' + self.fileId; // 下载文件地址
				console.log(url)
				dtask = plus.downloader.createDownload(url, {}, function(d, status) {
					// console.log(JSON.stringify(d))
					if (status == 200) { // 下载成功
						var fileSaveUrl = plus.io.convertLocalFileSystemURL(d.filename);
						console.log(fileSaveUrl)				
						moveFile(fileSaveUrl)	
						// mui.alert("文件保存路径:" + fileSaveUrl.replace("/storage/emulated/0/", ''), "下载成功");											
					} else { //下载失败
						plus.downloader.clear();
						app.toast("下载失败");
					}
				});
				dtask.start();
			}

			window.addEventListener('preview', function(e) { //执行刷新
				window.location.reload();
			});

			//获取已配对的蓝牙设备列表  
			function scan() {
				$("#list").empty()
				$("#loading").fadeIn();			

				if (!BAdapter.isEnabled()) {
					console.log('检测到未打开蓝牙,尝试打开中....');
					BAdapter.enable();
				}

				var lists = BAdapter.getBondedDevices(); //获取配对的设备列表  
				plus.android.importClass(lists);
				var iterator = lists.iterator();
				plus.android.importClass(iterator);
				// console.log(JSON.stringify(iterator))
				
				let html = '';
				let count = '';
				while (iterator.hasNext()) {
					$("#loading").hide();
					count++;
					var d = iterator.next();
					plus.android.importClass(d);
					html += `<li class="mui-table-view-cell" id=${d.getAddress()}><span class="num">${count}</span><div class="deviceName">${d.getName()}</div></li>`;					
				}
				$("#list").html(html)
			}

			//mac_address:打印机的mac地址  
			function print1(mac_address) {
				if (!mac_address) {
					mui.toast('请选择蓝牙打印机');
					return;
				}

				device = BAdapter.getRemoteDevice(mac_address);
				plus.android.importClass(device);

				bluetoothSocket = device.createInsecureRfcommSocketToServiceRecord(uuid);
				plus.android.importClass(bluetoothSocket);

				if (!bluetoothSocket.isConnected()) {
					try{
						// app.toast('检测到设备未连接，尝试连接...')
						bluetoothSocket.connect();
					}catch(e){
						console.log(e)
						app.toast('连接失败!')	
					}
				}

				console.log('bluetoothSocket.isConnected()=' + bluetoothSocket.isConnected());

				//为什么只能是首次连接成功，之后就一直是未连接  
				if (bluetoothSocket.isConnected()) {
					app.toast('连接成功!')	
					var outputStream = bluetoothSocket.getOutputStream();
					plus.android.importClass(outputStream);
					var String = plus.android.importClass('java.lang.String');
					var str =new String('测试数据\n');
					console.log(str.getBytes('gbk'));
					var bytes = str.getBytes('gbk');
					outputStream.write(bytes);
					outputStream.flush();
				}
			}

			mui('#list').on('tap', 'li', function() {
				print1(this.id);
				//localStorage.setItem('mac_address',this.id);  
			})

			//关闭遮罩层
			$(document).on("click", ".mui-backdrop,#cancelButton", function() {
				isShow = false;
				$('#home-item').hide();
				mask.close();
				// window.location = "prefs:root=SETTING";
			})
			
			function moveFile(filePath){		
				plus.io.resolveLocalFileSystemURL('file:///storage/emulated/0/DownLoad/', function( picDE ) {
					 plus.io.resolveLocalFileSystemURL(filePath, function( fileEntry ) {
						 // app.toast("加载完成")
						 var timestamp = Date.parse(new Date());		
						 fileEntry.moveTo(picDE, "previewFile_"+timestamp+".pdf", function(fe){
							 $("#pdfUrl").val(fe.fullPath.replace("/storage/emulated/0/", ''))	
							 // $('#dialog').show();
							 // console.log(fe.name)
							 path = fe.fullPath;
							 app.toast("下载完成，文件保存路径：" +  $("#pdfUrl").val())
							 plus.runtime.openFile(fe.fullPath, {}, function (e) { //调用第三方应用打开文件
							     		
							 });
						 }, function(error1){  
							app.toast("下载失败")
							console.log(error1.message);    
						 });  
					 }, function(error2){  
						   app.toast("下载失败")
							console.info("error2:"+error2.message);    
					 });  					 
				}, function(error3){    
					    app.toast("下载失败")
						console.info("error:"+error3.message);    
				});   
			}
	
			// document.getElementById("search").addEventListener('tap', scan);
			// 测试区
			/*
16:58:29.130 [LOG] : id:33aacbf9dd6b8e9936b08fd3ae61f599
16:58:29.152 [LOG] : fileType:.pdf
16:58:29.176 [LOG] : filePath:ecidi/a552d3b175464984a02b34201b27da14.pdf
16:58:29.198 [LOG] : fileId:33aacbf9dd6b8e9936b08fd3ae61f599
16:58:29.220 [LOG] : fileName:文档7.pdf
16:58:29.244 [ERROR] : Script error.filename:lineno:0
16:58:29.267 [LOG] : ==== else
16:58:29.288 [LOG] : https://zhswtest.hdec.com/ecidi-cmp/file/uploadFile/previewFileById?id=33aacbf9dd6b8e9936b08fd3ae61f599
			 */
			function initTmpData() {
				console.log("==== initTmpData ");
				url = "https://zhswtest.hdec.com/ecidi-cmp/file/uploadFile/previewFileById?id=33aacbf9dd6b8e9936b08fd3ae61f599"
						//config.urls.baseUrl + 'file/uploadFile/previewFileById?id=' + self.fileId;
				//console.log(url);
				$("#pdfContainer").attr("src", "../defects/web/viewer.html?file=" + encodeURIComponent(url));
				//
				$('#printBtn,#downloadBtn').on('tap', function() {
					print();
					$('#cancelButton').trigger("click");
				});

				$('#cancel').on('tap', function() {
					$('#dialog').hide();
					$("#viewport").attr("content",
							"width=device-width, initial-scale=1,minimum-scale=1,maximum-scale=10,user-scalable=yes")
					self.setStyle({
						scalable: true
					});
				});

				$('#toCopy').on('tap', function() {
					var txt = $("#pdfUrl").val();
					var i = txt.lastIndexOf("/");
					var j = txt.lastIndexOf(".") == -1?txt.length:txt.lastIndexOf(".");
					var name = txt.substring(i + 1, j);
					console.log(name)
					if(mui.os.android) {
						var Context = plus.android.importClass("android.content.Context");
						var main = plus.android.runtimeMainActivity();
						var clip = main.getSystemService(Context.CLIPBOARD_SERVICE);
						plus.android.invoke(clip, "setText", name);
					} else {
						var UIPasteboard = plus.ios.importClass("UIPasteboard");
						var generalPasteboard = UIPasteboard.generalPasteboard();
						// 设置/获取文本内容:
						generalPasteboard.setValueforPasteboardType(name, "public.utf8-plain-text");
						var value = generalPasteboard.valueForPasteboardType("public.utf8-plain-text");
					}
					app.toast("内容已复制到剪切板")
					$('#dialog').hide();
					$("#viewport").attr("content",
							"width=device-width, initial-scale=1,minimum-scale=1,maximum-scale=10,user-scalable=yes")
					self.setStyle({
						scalable: true
					});
				});

			}
			// initTmpData();
		</script>
	</body>

</html>
