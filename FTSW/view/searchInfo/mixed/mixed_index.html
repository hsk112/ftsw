<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>混接点</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<link href="http://gd.wiseom.cn/supermap/iclient-mapboxgl.min.css" rel="stylesheet" />
		<link href="http://gd.wiseom.cn/supermap/mapbox-gl-enhance.css" rel="stylesheet" />


		<link href="../../../css/common.css" rel="stylesheet" />
		<link href="../../../css/mui.min.css" rel="stylesheet" />
		<link href="../../../css/mui.picker.min.css" rel="stylesheet" />
		<style>
			.mui-col-xs-6 {
				text-align: left;
			}
			.mui-table-view-cell.mui-collapse.mui-active .arrow_right{
				transform: rotate(90deg);
				margin-left: 5px;
			}
			.mui-control-content .mui-loading {
				margin-top: 50px;
			}
			.mui-slider{
				height: 100vh;
			}
			.mui-slider .mui-segmented-control.mui-segmented-control-inverted .mui-control-item.mui-active {
				border-bottom: 2px solid #337BFC;
				color: #337BFC;
			}
		   .mui-table-view-cell.mui-collapse.mui-active + .www .arrow_right {
		        transform: rotate(90deg);
		        margin-left: 5px;
		      }
			.mui-slider .mui-segmented-control.mui-segmented-control-inverted~.mui-slider-group .mui-slider-item {
				border-bottom: 0;
			}
			.mui-slider .mui-segmented-control.mui-segmented-control-inverted .mui-control-item.mui-active{
				border-bottom: 0;
			}
			.mui-slider .mui-segmented-control.mui-segmented-control-inverted .mui-control-item.mui-active +.titleleft{
				border-bottom: solid 2px #337BFC;
				display: inline-block;
			}

			.mui-segmented-control .mui-control-item {
				line-height: 43px;
			}
			.mui-scroll {
				background: #FFFFFF;
			}

			.task-ul {
				padding: 0;
			}

			.task-li {
				border-bottom: 5px solid #F4F4F4;
				height: 110px;
				padding: 0 20px;
			}

			.task-item {
				/* height: 50px; */
				line-height: 50px;
				/* padding: 0 5px; */
			}

			.task-item-btn {
				width: 50%;
				float: left;
				text-align: right;
				white-space: nowrap;
				padding: 0 0 0 5px;
			}

			.task-item-btn span {
				padding: 5px 15px;
				border: 1px solid #347CFC;
				color: #347CFC;
				border-radius: 21px;
				font-size: 12px;
			}

			.task-item-running {
				color: #FF5656;
				font-size: 13px;
				text-align: right;
				/* margin-right: 20px; */
			}

			.task-item-finished {
				color: #29CC85;
				font-size: 13px;
				text-align: right;
				/* margin-right: 20px; */
			}

			.task-item-ischange {
				color: #FF7800;
				font-size: 13px;
				text-align: right;
				/* margin-right: 20px; */
			}
			.task-item_status{
				position: absolute;
				top: 8px;
				right: 5px;
			}

			.bottom-item {
				background: #FFFFFF;
				position: absolute;
				width: 100%;
				bottom: 30px;
				z-index: 999;
				text-align: left;
				padding: 15px 0 20px 0;
				border-top-left-radius: 5%;
				border-top-right-radius: 5%;
			}
			.bottom-item-title {
				display: flex;
				align-items: center;
				position: relative;
				font-size:18px;
				color:rgba(22,21,21,1);
				font-weight: bold;
				margin-left: 15px;
			}

			.item1{
				position: absolute;
				top:4px;
				z-index: 10;
				right: 0px ;
				text-align: center;
				line-height: 24px;
				vertical-align: bottom;
				padding: 0 14px;
				border: 1px solid #337BFC;
				border-radius: 20px;
				height: 26px;
				font-size: 12px;
			}

			.item2{
				position: absolute;
				top:4px;
				z-index: 10;
				right: 0px ;
				text-align: center;
				line-height: 24px;
				vertical-align: bottom;
				padding: 0 14px;
				border: 1px solid #337BFC;
				border-radius: 20px;
				height: 26px;
				font-size: 12px;
			}

			.item3{
				position: absolute;
				top:4px;
				z-index: 10;
				right: 64px ;
				text-align: center;
				line-height: 24px;
				vertical-align: bottom;
				padding: 0 14px;
				/* border: 1px solid #337BFC; */
				border-radius: 20px;
				height: 26px;
				font-size: 12px;
			}

			.mui-navigate-left:after
			{
			    content: '\e472';
				left: 5px;
				bottom: 50px;
			}
			.object{
				display: flex;
				justify-content: space-between;
				margin: 8px 0;
			}
			.li-item{
				background-color:white;
			}
			.li-item-pull{
				background-color: #F4F4F4 !important;
			}
			.li-margin{
				margin-bottom: 13px;
				border-bottom: 1px solid #EDEDED;
				padding-bottom: 0px;
				font-size: 13px;
				padding-bottom: 10px;
			}
			.in-obj{
				font-weight: 400;
				color: #888888;
				margin-right: 7px;
			}
			.obj-title{
				color: #444444;
			}
			.bgc-white{
				background-color: white;
			}
			.bgc-grey{
				background-color: #F4F4F4;
			}
			.mui-navigate-r{
				background: #fff;
			}
			.icon-css{
				display: inline-block;
				padding: 8px 0 0;
				vertical-align: top;
			}
			.task_title{
				display: inline-block;
				padding: 8px 0;
				color: #191515;
				font-size: 15px;
				font-weight: 500;
				width: 50%;
				word-break: break-all;
				white-space: pre-wrap;
			}
			.sec-line{
				color: #878787;
				font-size: 14px;
			}
			/* 	.arrow_right{
				transform: rotate(90deg);
			} */
			.ul-mar-bottom{
				margin-bottom: -18px;
			}
			.mui-table-view-cell>a:not(.mui-btn){
				margin: 0;
				padding:0;
			}
			.mui-table-view-cell.mui-active{
				background: #fff;
			}
			.mui-slider .mui-segmented-control.mui-segmented-control-inverted .mui-control-item.mui-active.titleleft{
				border-bottom: solid 3px #337BFC;
				display: inline-block;
			}
			.mui-slider .mui-segmented-control.mui-segmented-control-inverted .mui-control-item.mui-active.titleright{
				border-bottom: solid 3px #337BFC;
				display: inline-block;
			}
			.mui-slider .mui-segmented-control.mui-segmented-control-inverted .mui-control-item.mui-active .lb{
				border-bottom: solid 3px #337BFC;
				display: inline-block;
				font-weight: bold;
			}
			.mui-slider .mui-segmented-control.mui-segmented-control-inverted .mui-control-item.mui-active .dt{
				border-bottom: solid 3px #337BFC;
				display: inline-block;
				font-weight: bold;
			}
			.mui-slider .mui-segmented-control.mui-segmented-control-inverted~.mui-slider-group .mui-slider-item{
				    border-top: 7px solid #F4F4F4
			}
			.color888{
				color: #888888;
			}
			.ibh{
				display: inline-block;
				line-height: 28px;
			}
			.showMore{
				display: inline-block;
			}

			.mui-table-view-cell{
				padding: 0!important;
			}

			#select_ul span{
				padding: 0;
			}

			.home-item {
				position: fixed;
				width: 100%;
				z-index: 999;
				top: 0;
				left: 0;
				height: 300px;
				background: #FFFFFF
			}

			.home-item-title {
				font-size: 19px;
				width: 100%;
				height: 20px;
				text-align: left;
				padding: 25px 23px;
				color: #191515;
				font-weight: bold;
			}

			.home-item-title .span-bg {
				width: 78px;
				height: 12px;
				background: rgba(219, 232, 255, 1);
				margin-top: -10px;
			}


			.home-item-list {
				width: 100%;
				margin-top: 23px;
				height: 77px;
				/* height: 107px; */
			}

			.home-item-list .item {
				width: 25%;
				float: left;
				text-align: center;
				font-size: 13px;
				margin-bottom: 24px;
				/* border-bottom: 2px solid #EEEEEE; */

			}

			.home-item-list .item img {
				height: 40px;
				width: 40px;
				border-radius: 40px;
				margin: 0 auto;
				display: block;
				margin-bottom: 10px;
			}

			.home-item-list .item img {
				height: 40px;
				width: 40px;
				border-radius: 40px;
				margin: 0 auto;
				display: block;
				margin-bottom: 10px;
			}

			.mapboxgl-ctrl-bottom-left {
				bottom: -999px;
				left: 0;
			}

			#riverMap0,#riverMap1{
				width: 60px;
				height: 60px;
				position: absolute;
				left: 82%;
				top: 3%;
				z-index: 1;
			}

			#lakeMap1,#lakeMap0{
				width: 60px;
				height: 60px;
				position: absolute;
				left: 82%;
				top: 13%;
				z-index: 1;
			}

			.btn-outlined{
				border:1px solid #337BFC;
				color: #337BFC;
			}
			.mui-btn.mui-active:enabled{
				background: #337BFC;
			}

			#search_input{
				margin: 0;
				width: 90%;
				height: 32px;
				border-radius: 16px;
				border: none;
				padding-left: 35px;
			}

			#search{
				padding: 5px 0;
				background: #F4F4F4;
				border-bottom: 7px solid #F4F4F4;
				position: relative;
			}
			
			#del_icon img{
				width: 14px;
				height: 14px;
				position: absolute;
				right: 9%;
				top: 35%;
			}

			#search_icon img{
				width: 14px;
				height: 14px;
				position: absolute;
				left: 9%;
				top: 35%;
			}

			#left_item{
				padding: 15px;
				background: #FFFFFF;
				position: fixed;
				bottom: 20%;
				left:19px;
				z-index: 100;
				border-radius: 5px;
				text-align: left;
			}
			#left_item ul li span{
				display: inline-block;
				width: 10px;
				height: 10px;
				border-radius: 50%;
				margin-right: 10px;
			}

			*{
				touch-action:none;
			}

			#mixCode, #commName {
				display: inline-block;
				width:100%;
				display: -webkit-box;
				overflow-x: scroll;
				overflow-y: hidden;
				white-space: nowrap;
				word-break: break-all;
				font-size: 16px;
				touch-action: auto!important;
			}
			
				
			#mixAddress{
				width: 70%;
				display: inline-block;
				overflow: scroll;
				white-space: nowrap;
				word-break: break-all;
				touch-action: auto!important;
			}
			#code{
				width: 45%;
				display: inline-block;
				overflow: scroll;
				white-space: nowrap;
				word-break: break-all;
				touch-action: auto!important;
			}
		</style>
	</head>

	<body>
		<!--页面主结构开始-->
		<div id="app" class="mui-views">
			<div class="mui-view">
				<div class="mui-navbar">
				</div>
				<div class="mui-pages">
				</div>
			</div>
		</div>
		<div class="home-item" style="display: none;" id="home-item">
			<div class="home-item-list" id="business_item">
				<div class="item" id="monitor">
					<img src="../../../img/commom/monitor.png">
					<span>监测信息</span>
				</div>
				<!-- 	<div class="item" id="quality">
						<img src="../../../img/commom/quality-icon.png">
						<span>质量检查</span>
					</div> -->
				<div class="item" id="riverArchives">
					<img src="../../../img/commom/rivers.png">
					<span>河湖档案</span>
				</div>
				<div class="item" id="leaderList">
					<img src="../../../img/commom/leaderList.png">
					<span>河湖长名录</span>
				</div>
				<div class="item" id="emergency">
					<img src="../../../img/commom/emergency.png">
					<span>应急资源</span>
				</div>
				<div class="item" id="waterRisk">
					<img src="../../../img/commom/waterRisk.png">
					<span>积水风险点</span>
				</div>
				<div class="item" id="paishui">
					<img src="../../../img/commom/paishuihu.png">
					<span>排水户</span>
				</div>
				<div class="item" id="overflow">
					<img src="../../../img/commom/overflow.png">
					<span>冒溢点</span>
				</div>
				<div class="item" id="hybrid">
					<img src="../../../img/commom/mixed.png">
					<span>混接点</span>
				</div>
				<div class="item" id="shuiwuFacility">
					<img src="../../../img/commom/shuiwu.png">
					<span>水务设施</span>
				</div>
				<div class="item" id="policy">
					<img src="../../../img/commom/policy.png">
					<span>政策法规</span>
				</div>
				<div class="item" id="standard">
					<img src="../../../img/commom/standard.png">
					<span>标准规范</span>
				</div>
				<div class="item" id="operContract">
					<img src="../../../img/commom/operContract.png">
					<span>运维合同</span>
				</div>
			</div>
		</div>

		<!--页面主结构结束-->
		<!--单页面开始-->
		<div id="mui-content" class="mui-page">
			<!--页面标题栏开始-->
			<!--页面标题栏结束-->
			<!--页面主内容区开始-->
			<div class="mui-page-content">
				<div class="mui-scroll-wrapper">
					<div class="mui-scroll">
						<div id="slider" class="mui-slider">
							<div id="sliderSegmentedControl" class="mui-slider-indicator mui-segmented-control mui-segmented-control-inverted"
							 style="padding: 0 68px;color: #888888;">
								<a id="item1" class="mui-control-item" href="#selectItem1" style="padding-right: 30%;">
									列表
								</a>
								<a id="item2" class="mui-control-item  mui-active" href="#selectItem2" style="padding-left: 30%;">
									地图
								</a>
							</div>
							<div id="sliderProgressBar" class="mui-slider-progress-bar mui-col-xs-6" style="color: #337BFC;height: 2px;background: linear-gradient(to right, rgba(0, 0, 0, 0) 0%,
									 rgba(0, 0, 0, 0) 39.9%, #337BFC 40%, #337BFC 50%, #337BFC 59.9%,
									rgba(0, 0, 0, 0) 60%,  rgba(0, 0, 0, 0) 100%);"></div>

							<div class="mui-slider-group">
								<div id="selectItem1" style="padding-top: 10px;" class="mui-slider-item mui-control-content">
									<div id="scroll1" class="mui-scroll-wrapper" style="height: 100vh;background: #FFFFFF;padding-bottom:50px">
										<div class="mui-table-view">
											<div id="listNav">
												<div id="search">
													<div id="search_icon"><img src="../../../img/commom/search1@2x.png"></div>
													<div id="del_icon"><img src="../../../img/commom/del.png"></div>
													<input type="text" id="search_input" value="" placeholder="请输入所属小区" />
												</div>
												<div id="openFactor" style="height: 60px;line-height: 60px;border-bottom: 5px solid #F4F4F4;text-align: left;">
													<div class="view-title search-tip" style="display: inline-block;">
														<img src="../../../img/commom/river.png" style="width: 16px;height: 15px;line-height: 15px;vertical-align:middle;margin: 0 5px 0 20px" />
														<span id="mixedLabel" style="line-height: 16px;">混接点共有</span>
														<span id="mixedNum" style="color: #337BFC; margin-left: 10px; font-weight: bold;"></span>
													</div>
												</div>
											</div>
											<div id="noDataTips" style='color: #888888;background:#F3F3F3;line-height:100px;width:100%; margin-top:5px; display:none;'>暂无数据，点击此处重置！</div>
											<ul id="select_ul"></ul>
										</div>

									</div>
								</div>
								<div id="selectItem2" class="mui-slider-item mui-control-content mui-active">
									<div id="scroll2" class="mui-scroll-wrapper" style="height: 100vh;">
										<div id="map" class="mapboxgl-map" style="position: absolute;left: 0;top: 0; z-index: 99;height: 100vh;width: 100%;">
											<div id="searchBar" class="mui-input-row" style="position: fixed;z-index: 100;width: 90%;margin: 20px;height: 40px; ">
												<img src="../../../img/commom/search1@2x.png" alt="" id="search_icon" style="width: 16px;position: fixed;top: 31px;left: 31px;">
												<input style="margin: 0;border: none;padding-left: 40px;border-radius: 20px;" class="mui-input-clear" type="text"
												 placeholder="请输入混接点编号或地址" name="" id="searchInput" value="" />
											</div>
											<div id="searchBox" style="touch-action: none;position: fixed;z-index:1000; top:62px;margin:0 20px;background: #FFFFFF;width: calc(100% - 40px);box-shadow: 1px 1px 23px 0px rgba(0, 0, 0, 0.06);">
											</div>
											<div id="left_item">
												<ul>
													<li style="margin-bottom:13.5px;"><span style="background-color:red;"></span>重度混接</li>
													<li style="margin-bottom:13.5px;"><span style="background-color:yellow;"></span>中度混接</li>
													<li style="margin-bottom:13.5px;"><span style="background-color:blue;"></span>轻度混接</li>
													<li><span style="background-color:gray;"></span>未改造</li>
												</ul>
											</div>
											<img src="../../../img/commom/refresh.png" style="width: 40px;position: fixed;right: 20px; bottom:20%;z-index: 100;"
											 id="refresh">
										</div>

										<div class="bottom-item" style="display: none;">
											<span class="bottom-item-title">
												<span id="bottom-icon" style="margin-right: 5px;">
													<img id="info_icon" style="width: 31px;" src="../../../img/icon4.png">
												</span>
												编号：
												<span id="code" style="font-size: 18px;font-weight: bold;color: #161616;">加载中</span>
												<span id="stat" style="color: #FF5656; font-size: 12px;padding-top: 5px; margin-left: 10px;">加载中</span>
												<img id="closeBottom" src="../../../img/commom/del.png" style="width: 20px; position: absolute; top: 8px; right: 5%;"
												 alt="">
											</span>
											<div class="content" style="font-size: 16px;display: flex;">
												<div style="margin:10px 0px 0 20px;display: inline-block; font-size: 14px;color: #888888;">
													<div>
														混接类型：
														<span style="color: #444444;" id="mixType">加载中</span>
													</div>
													<div style="margin-top: 5px;">
														混接管管径(mm)：
														<span style="color: #444444;" id="mixDiameter">加载中</span>
													</div>
													<div style="margin-top: 5px;">
														混接点位置：
														<span style="color: #444444;" id="mixPosition">加载中 </span>
													</div>
												</div>
												<div style="display: inline-block; margin: 10px 0 0 20px;font-size: 13px;color: #888888;">
													<div>
														混接水来源：
														<span style="color: #444444;" id="mixSour">加载中</span>
													</div>
													<div style="margin-top: 5px;">
														混接管埋深(mm)：
														<span style="color: #444444;" id="mixDep">加载中 </span>
													</div>
												</div>
											</div>
											<div style="display: block; margin: 5px 0 20px 20px;width: 100%;font-size: 14px;color: #888888;">
												混接地点：
												<span style="color: #444444;vertical-align: top;" id="mixAddress">加载中</span>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<!--页面主内容区结束-->
				</div>
			</div>
		</div>
	</body>

	<script type="text/javascript" src="http://gd.wiseom.cn/supermap/mapbox-gl-enhance.js"></script>
	<script type="text/javascript" src="http://gd.wiseom.cn/supermap/iclient-mapboxgl.min.js"></script>
	<script src="http://gd.wiseom.cn/mobile-lib/mobile-lib.umd.js"></script>

	<script src="../../../js/jquery.min.js"></script>
	<script src="../../../js/mui.min.js"></script>
	<script src="../../../js/mui.view.js"></script>
	<script src="../../../js/mui.locker.js"></script>
	<script src="../../../js/common.js"></script>
	<script src="../../../js/app.js"></script>
	<script src="../../../js/config.js"></script>
	<script src="../../../js/mixed.js"></script>
	<script src="../../../js/s4.js"></script>
	<script src="../../../js/smutils.js"></script>
	<script src="../../../js/byte&string.js"></script>
	<script src="../../../js/ajaxhook.min.js"></script>
	<script src="../../../js/mui.picker.min.js"></script>
	<script src="../../../js/position.js"></script>
	<!-- <script src="../../../js/vconsole.min.js"></script> -->
	<script src="../../../js/infoQuery/mixedList.js"></script>
	<script src="../../../js/mui.pullrefresh.js"></script>
	<script src="../../../js/mui.init.pullrefresh.js"></script>

	<script>
		//初始化单页view
		var viewApi = mui('#app').view({
			defaultPage: '#mui-content'
		});
		// var vConsole = new VConsole();
		mui.init({
			swipeBack: false,
			// pullRefresh: {
			// 	container: "#loadContainer", 
			// 	up: {
			// 		height: 1000,
			// 		auto: false,
			// 		contentrefresh: "正在加载...", 
			// 		contentnomore: '没有更多数据了', 
			// 		callback: function() {
			// 			alert("load")
			// 		}
			// 	}
			// }
		});

		mui.back = function() {
			var curr = plus.webview.currentWebview();
			var wvs = plus.webview.all();
				for (var i = 0, len = wvs.length-1; i < len; i++) {
					let theurl = wvs[i].getURL() + '';
					if (!(theurl.search('login.html') != -1 ||
						theurl.search('www/main.html') != -1 ||
						theurl.search('www/index.html') != -1 ||
						theurl.search('/searchInfo/index.html') != -1)){					
						wvs[i].close('none');
					}
				}
			curr.close('slide-out-right');
		}
		
		
		// pullRefresh(); //启用上拉下拉 
		// function pullRefresh() {
		// 	mui("#loadContainer").pullRefresh({
		// 		up: {
		// 			height: 20,
		// 			auto: false,
		// 			contentrefresh: "正在加载...", //可选，正在加载状态时，上拉加载控件上显示的标题内容
		// 			contentnomore: '没 有 更 多 数 据 了', //可选，请求完毕若没有更多数据时显示的提醒内容；
		// 			callback: function() { //必选，刷新函数，根据具体业务来编写，比如通过ajax从服务器获取新数据；
		// 				window.setTimeout(function() {
		// 					alert("1")
		// 				}, 500);
		// 			}
		// 		}
		// 	})
		// }

		var mixedData = [];
		var loadFlag = false;
		//用于匹配改造的字典
		var stateColor = [{
			status:'改造',
			color:'#29CC85'
		},{
			status:'未改造',
			color:'#FF5656'
		},{
			status:'新增待确认',
			color:'#0493f3'
		},{
			status:'改造待确认',
			color:'#0493f3'
		},{
			status:'删除待确认',
			color:'#0493f3'
		},{
			status:'已删除',
			color:'#888888'
		}]

		const MobileContainer = window['mobile-lib'].MobileContainer;
		const mobileContainer = new MobileContainer({
			serverUrl: config.urls.serverDomain,
			options: {
				minZoom: 10
			},
			style: 'color'
		});

		const mapData = window['mobile-lib'].MapData({
			serverUrl: config.urls.serverDomain
		});
		const layerSelections = window['mobile-lib'].layerSelections;

		mobileContainer.on('load', () => {
			getCurrentPosition();
			mobileContainer.enableCenterAddress(true);
			mobileContainer.setQuery([{
				NAME: 'DEVICE_POINT_INFO',
				HYBRID_TYPE: 1,
				DEL_FLAG: 0
			}, {
				NAME: 'DEVICE_POINT_INFO',
				HYBRID_TYPE: 2,
				DEL_FLAG: 0
			}]); //加载混接点
			mobileContainer.showAnnotation(true);
			mobileContainer.setSelection([layerSelections.污水点类, layerSelections.雨水点类]);
		});

		//点击混接点
		mobileContainer.on('showInfo', data => {
			$(".bottom-item").hide(); //显示底部信息
			mobileContainer.flyTo(data.feature);
			console.log("显示信息：" + JSON.stringify(data));
			if (data.feature.properties.GUID) { //point_info_b_67951
				//保存SMID
				globalSetItem(GlobalKey.SMID, data.feature.properties.SMID);
				//显示底部信息
				showBottomInfo(data.feature.properties.GUID);
			} else {
				//显示底部信息
				// app.toast("已为您定位至最近一次选择的混接点");
				showBottomInfo(globalGetItem(GlobalKey.guid));
				globalSetItem(GlobalKey.isSelectMix, "false"); //是否设置混接点
				//删除混接点
				globalDelItem(GlobalKey.mix);
			}
		});

		//点击地图 定位
		mobileContainer.on('click', data => {
			if (data) {
				$("#searchInput").val("");
				$("#searchBar").show();
				$(".bottom-item").hide(); //隐藏底部信息
				clearGlobalItem();
				mobileContainer.enableCenterAddress(true);
				console.log(data);
				mobileContainer.markAddress(data.lngLat.lng, data.lngLat.lat);
				mobileContainer.flyTo([data.lngLat.lng, data.lngLat.lat]);

				globalSetItem(GlobalKey.isSelectMix, "false"); //是否设置混接点

				console.log("点击位置：" + JSON.stringify(data.lngLat))
				// globalSetItem(GlobalKey.point, JSON.stringify(data.lngLat)); //选中地图点
				globalDelItem(GlobalKey.mix); //删除选中混接点

				// $(".bottom-item").fadeIn();
				$("#left_item").fadeIn();
				$("#refresh").show();
			} else {
				app.toast('当前选择不在可选范围内，请重新选择');
			}
		});


		//显示地图信息
		mobileContainer.on('showAddress', data => {

			var point = {
				'lng': data.location.lon,
				'lat': data.location.lat
			}
			globalSetItem(GlobalKey.point, JSON.stringify(point)); //选中地图点

			// mobileContainer.enableCenterAddress(false);
			globalSetItem(GlobalKey.address, data.addressComponent.address); //保存选中的地址
			globalSetItem(GlobalKey.isSelectMix, "false"); //是否设置混接点
			// $(".bottom-item").fadeIn();
			// $("#left_item").hide();
			//删除混接点
			globalDelItem(GlobalKey.mix);
		});

		/**
		 * @param fn {Function}   实际要执行的函数
		 * @param delay {Number}  延迟时间，也就是阈值，单位是毫秒（ms）
		 * @return {Function}     返回一个“去弹跳”了的函数
		 */
		function debounce(fn, delay) {
			// 定时器，用来 setTimeout
			var timer
			// 返回一个函数，这个函数会在一个时间区间结束后的 delay 毫秒时执行 fn 函数
			return function() {
				// 保存函数调用时的上下文和参数，传递给 fn
				var context = this
				var args = arguments
				// 每次这个返回的函数被调用，就清除定时器，以保证不执行 fn
				clearTimeout(timer)
				// 当返回的函数被最后一次调用后（也就是用户停止了某个连续的操作），
				// 再过 delay 毫秒就执行 fn
				timer = setTimeout(function() {
					fn.apply(context, args)
				}, delay)
			}
		}

		//搜索框
		$("#searchInput").on('input', debounce((e) => {
			$(".bottom-item").hide();
			$("#left_item").hide();
			$("#searchBox").html(
				"<div style='text-align:center;line-height:50px;font-size: 16px;color:#B1B1B1'>正在搜索...</div>");
			var inputdata = $("#searchInput").val();
			if (inputdata != null && inputdata != "") {
				var param = {
					pageNo: 1,
					pageSize: map_pageSize,
					appParameter: inputdata,
				};
				searchInfo(param);
			} else {
				$("#searchBox").html("");
			}
		}, 680))

		var map_pageNo = '1';
		var map_pageSize = '4';

		function searchInfo(param) {
			param.appParameter = $("#searchInput").val();
			getMixPageList(false, param, function(data) {
				if (data.success) {
					console.log("搜索结果：" + JSON.stringify(data));
					var dataList = data.result.records
					var html = "";
					$("#searchBox").html("");
					if (dataList.length == 0 && param.pageNo == 1) {
						html = '<div style="width:100%;height: 50px;border-bottom: 1px solid #EDEDED;">' +
							'<div style="text-align:center;line-height:50px;font-size: 16px;color:#B1B1B1">' +
							'暂无数据' +
							'</div>' +
							'</div>';
						// $("#searchBox").append(html);
						// $("#searchBox").html(html);
					} else {
						for (var i = 0; i < dataList.length; i++) {
							var guid = dataList[i].guid;
							var addr = dataList[i].address != null ? (dataList[i].address.length > 20 ? dataList[i].address.substring(0,
								20) + "..." : dataList[i].address) : "无";
							var expNo = dataList[i].expNo;
							var SmY = dataList[i].SmY != undefined ? dataList[i].SmY : 114.11111;
							var SmX = dataList[i].SmX != undefined ? dataList[i].SmX : 22.114455;
							console.log("====SmY:" + dataList[i].SmY + ",SmX:" + dataList[i].SmX);
							html += '<div class="box" guid="' + expNo + '" name="' + SmY + ',' + SmX +
								'" style="width:100%;height: 70px;border-bottom: 1px solid #EDEDED;">' +
								'<div style="float: left;width: 15%;background: #FFFFFF;height: 70px;">' +
								'	<img src="../../../img/commom/dz@2x.png" style="width: 20px;height: 20px;margin-top:20px;margin-left:20px" />' +
								'</div>' +
								'<div style="width:85%;float: right;background: #FFFFFF;">' +
								'	<div style="padding-top: 10px;font-size: 14px;font-weight: 400;color: #1A1616;line-height: 21px;text-align: left;background: #FFFFFF;">' +
								expNo + '</div>' +
								'	<div style="padding-top: 5px; font-size: 12px;font-weight: 400;color: #B2B2B2;line-height: 21px;text-align: left;background: #FFFFFF;">' +
								addr + '</div>' +
								'</div>' +
								'</div>';
							// alert(guid + addr + expNo);
							// $("#searchBox").append(html);

						}
						if (dataList.length == map_pageSize) {
							if (param.pageNo == 1) {
								html += '<div style="height:30px;line-height:30px;">' +
									'<a id="more" name="' + param.pageNo + '" style="font-size: 12px;margin-right: 50px;float:right">下一页</a>' +
									'</div>';
							} else {
								html += '<div style="height:30px;line-height:30px;">' +
									'<a id="pre" name="' + param.pageNo +
									'" style="font-size: 12px;margin-right: 10px;width:150px;float:left;margin-left:50px">上一页</a>' +
									'<a id="more" name="' + param.pageNo + '" style="font-size: 12px;margin-right: 50px;float:right">下一页</a>' +
									'</div>';
							}

						} else {
							if (param.pageNo == 1) {
								html += '<div id="nomore" style="height:30px;line-height:30px;">' +
									'<a style="font-size: 12px;margin-right: 10px;">没有更多了</a>' +
									'</div>';
							} else {
								if (dataList.length == 0) {
									html += '<div style="width:100%;height: 60px;border-bottom: 1px solid #EDEDED;margin-bottom:20px">' +
										'<div style="background: #FFFFFF;">' +
										'暂无更多数据' +
										'</div>' +
										'</div>';
								}
								html += '<div style="height:30px;line-height:30px;margin-left:50px">' +
									'<a id="pre" name="' + param.pageNo +
									'" style="font-size: 12px;margin-right: 10px;width:150px;float:left;">上一页</a>' +
									'<a style="font-size: 12px;margin-right: 10px;"  id="nomore">没有更多了</a>' +
									'</div>';
							}
						}

					}
					$("#searchBox").html(html);
				} else {
					app.toast("未查询到任何数据");
					$("#searchBox").html("未查询到任何数据");
				}
			});
		}

		$("#searchInput").focus(function() {
			$(".bottom-item").hide();
			$("#left_item").hide();
			$("#refresh").hide();
		});

		$("#noDataTips").on('tap', function() {
			$("#search_input").val("");
			getList(pageNo, pageSize)
		})

		mui("body").on("tap", ".mui-icon-clear", function() {
			$("#searchBox").html("")
		});

		$("#searchBox").on('tap', "#more", function() {
			$("#left_item").hide();
			var pageNo = parseInt($(this).attr("name")) + 1;
			var param = {
				pageNo: pageNo,
				pageSize: map_pageSize,
				appParameter: $("#searchInput").val(),
			};
			searchInfo(param);
			setTimeout(function() {
				mui.toast("加载完成");
			}, 500);
		})

		$("#searchBox").on('tap', "#pre", function() {
			$("#left_item").hide();
			var pageNo = parseInt($(this).attr("name")) - 1;
			var param = {
				pageNo: pageNo,
				pageSize: map_pageSize,
				appParameter: $("#searchInput").val(),
			};
			searchInfo(param);
			setTimeout(function() {
				mui.toast("加载完成");
			}, 500);
		})

		$("#searchBox").on('tap', "#nomore", function() {
			mui.toast("没有更多了");
		})

		$("#searchBox").on('tap', ".box", function() {
			var that = $(this)
			setTimeout(function() {
				var latlng = that.attr("name").split(",");
				var lat = latlng[0];
				var lng = latlng[1];
				console.log(lat + "," + lng);

				//通过guid查询混接点信息
				showBottomInfo(that.attr("guid"));


				$("#searchBox").html("");
				$("#searchInput").val("");
			}, 200)
		});


		$("#searchInput").keypress(function(even) {
			$(".bottom-item").hide();
			if (even.which == 13) {
				var inputdata = $("#searchInput").val();
				if (inputdata != null && inputdata != "") {
					var param = {
						page: 1,
						pageSize: pageSize,
						appParameter: inputdata,
					};
					searchInfo(param);
				} else {
					$("#searchBox").html("");
				}
			}
		});

		var pageNo = '1';
		var pageSize = '100';
		var searchPageNo = '1';
		var searchPageSize = '20';
		var isShow = true;
		var mask = mui.createMask();
		var extras = {
			openNum: 0
		}

		function debounce(fn, delay) {
			// 定时器，用来 setTimeout
			var timer;
			// 返回一个函数，这个函数会在一个时间区间结束后的 delay 毫秒时执行 fn 函数
			return function() {
				// 保存函数调用时的上下文和参数，传递给 fn
				var context = this
				var args = arguments
				// 每次这个返回的函数被调用，就清除定时器，以保证不执行 fn
				clearTimeout(timer)
				// 当返回的函数被最后一次调用后（也就是用户停止了某个连续的操作），
				// 再过 delay 毫秒就执行 fn
				timer = setTimeout(function() {
					fn.apply(context, args)
				}, delay)
			}
		}

		//初始化单页的区域滚动
		mui('.mui-scroll-wrapper').scroll();
		var pickerpxtop = null;
		mui.plusReady(function() {

			// 初始化数据列表（河流数据）
			getList(pageNo, pageSize);
			//禁止选项卡自带滑动
			mui('.mui-slider').slider().stopped = true;
			var self = plus.webview.currentWebview();
			extras.openNum = self.openNum + 1; //初始化打开页面数量

			self.setStyle({
				titleNView: {
					backgroundImage: "../../../img/bgTop.png",
					backgroundRepeat: 'no-repeat',
					buttons: [{
						float: 'right',
						width: '70',
						fontSize: '17',
						text: '',
						onclick: function() {
							if (isShow) {
								isShow = false;
								$("#home-item").show();
								mask.show()
							} else {
								isShow = true;
								$('#home-item').hide();
								mask.close();
							}
						}
					}],
				}
			});

			// 监听区域滑动
			document.getElementById('selectItem1').addEventListener("swipeleft", function(e) {
				e.stopPropagation()
				$('#item1').removeClass("mui-active")
				$('#item2').addClass("mui-active")
				var gallery = mui('.mui-slider');
				gallery.slider().gotoItem(1);
			});

			//重新加载
			$("#refresh").on("tap", function() {
				$("#searchInput").val("");
				$("#left_item").fadeIn();
				$("#searchBar").fadeIn();
				$("#refresh").fadeIn();
				getCurrentPosition();
			});
		});

		function init() {
			$(".bottom-item").fadeIn();
		};


		// methods

		var initDestoryData = function(data, callback) {
			for (let key in data) {
				if (data[key] == '' || data[key] == null) {
					data[key] = '无'
				}
			}
			callback(data);
		}

		function viewDetails(target) {
			if (target == 'river') {
				window.location.href = 'river_details.html';
			} else {
				window.location.href = 'lake_details.html';
			}

		};

		function getList(pageNo, pageSize) {
			$("#del_icon").hide();
			getMixedList(pageNo, pageSize, function(data) {
				listView(data);
			})
		}

		var listView = function(data) {
			if (data.result.total == 0) {
				$('#select_ul').empty();
				$("#noDataTips").show();
				$('#mixedNum').text("0")
			} else {
				$('#noDataTips').hide();
				mixedData = data.result.records;
				let str2 = '';
				let listLength = mixedData.length;
				let state = '';
				$('#mixedNum').text(listLength)
				for (let i = 0; i < mixedData.length; i++) {
					initDestoryData(mixedData[i], function(Data) {
						num = Number(Data.reformState)
						state = stateColor[num-1].status;
						textColor = stateColor[num-1].color;
						
						str2 +=
							`<li style="height: 50px; line-height: 50px; border-bottom: 1px solid #EDEDED;" data-index=${i}>
								<div id="midxedLi">
									<div class="mui-row" style="text-align: center;">
										<div class="mui-col-sm-2 mui-col-xs-2">
											<span class="mui-table-view-cell">${i+1}</span>
										</div>
										<div class="mui-col-sm-4 mui-col-xs-4" style="padding-right: 10px;">
											<span id="mixCode" >${Data.mixCode}</span>
										</div>
										<div class="mui-col-sm-3 mui-col-xs-3" style="padding-left: 10px;" >
											<span id="commName">${Data.commName}</span>
										</div>
										<div class="mui-col-sm-3 mui-col-xs-3">
											<span class="mui-table-view-cell" style="color: ${textColor};">${state}</span>
										</div>
									</div>
								</div>
							</li>`
					})
				}

				$('#select_ul').html(str2);
			}
		}

		$("#select_ul").on('tap', "li", function() {
			var index = $(this).attr("data-index")
			var item = mixedData[index];
			$('#item1').removeClass("mui-active")
			$('#item2').addClass("mui-active")
			var gallery = mui('.mui-slider');
			gallery.slider().gotoItem(1);
			showBottomInfo(item.expNo)
			// console.log(JSON.stringify(item))
			var Lon = item.SmX; //获取经度
			var Lat = item.SmY; //获取纬度
			mobileContainer.markAddress(Lon, Lat);
			mobileContainer.flyTo([Lon, Lat], {
				zoom: 13
			});
		});

		// JQ

		$("#closeBottom").on('click', function(ev) {
			var oEvent = ev || event;
			oEvent.cancelBubble = true;
			oEvent.stopPropagation();
			$(".bottom-item").hide();
			$("#left_item").fadeIn();
			$("#searchBar").fadeIn();
			$("#refresh").fadeIn();
		})

		$("#riverArchives").on('tap', function() {
			app.openPage('../rivers/rivers_index.html', {
				titleNView: {
					titleText: '河湖档案',
					autoBackButton: true
				}
			}, extras);
		})

		$("#leaderList").on('tap', function() {
			app.openPage('../leaderList/leaderList_index.html', {
				titleNView: {
					titleText: '河湖长名录',
					autoBackButton: true
				}
			}, extras);
		})

		$("#emergency").on('tap', function() {
			app.openPage('../emergency/emergency_map.html', {
				titleNView: {
					titleText: '应急资源',
					autoBackButton: true
				}
			}, extras);
		})

		$("#paishui").on('tap', function() {
			app.openPage('../paishuihu/paishuihu_index.html', {
				titleNView: {
					titleText: '排水户',
					autoBackButton: true
				}
			}, extras);
		})

		$("#hybrid").on('tap', function() {
			isShow = true;
			$('#home-item').hide();
			mask.close();
		})

		//关闭遮罩层
		$(document).on("click", ".mui-backdrop", function() {
			isShow = true;
			$('#home-item').hide();
			mask.close();
		})

		$("#del_icon").on('tap', function() {
			$('#search_input').val('');
			getList(pageNo, pageSize);
			$("#del_icon").hide();
		})

		$('#search_input').on('input', function() {
			if ($("#search_input").val() != '') {
				$("#del_icon").show();
			} else {
				$("#del_icon").hide();
			}
		})

		$("#search_input").change(function() {
			if ($("#search_input").val() != '') {
				$("#del_icon").show();
				getMixedListByAddress(pageNo, pageSize, $("#search_input").val(), function(data) {
					listView(data);
				})
			} else {
				$("#del_icon").hide();
				getList(pageNo, pageSize)
			}

		})

		$("#del_icon").on('tap', function() {
			$('#search_input').val('');
			$("#del_icon").hide();
		})


		window.addEventListener('backInspection', function(e) { //执行刷新
			// location.reload();
			getList(pageNo, pageSize);
			getMapList();
			mui('#scroll1').scroll().scrollTo(0, 0, 0);
			mui('#contentList').scroll().scrollTo(0, 0, 0);
		});

		mui(".mui-segmented-control").on('tap', '.mui-control-item', function() {
			$("#searchInput").blur()
		});

		(function($) {
			$('.mui-scroll-wrapper').scroll({
				indicators: true //是否显示滚动条
			});
		})(mui);

		var getCurrentPosition = function() {
			if (mui.os.plus) {
				app.showLoader();
			}
			//重新定位时重新查询混接点
			mobileContainer.setQuery([{
				NAME: 'DEVICE_POINT_INFO',
				HYBRID_TYPE: 1,
				DEL_FLAG: 0
			}, {
				NAME: 'DEVICE_POINT_INFO',
				HYBRID_TYPE: 2,
				DEL_FLAG: 0
			}]); //加载混接点
			//获取当前坐标
			plus.geolocation.getCurrentPosition(function(position) {
				// app.hideLoader();
				//坐标修正
				var point = coordtransform.gcj02towgs84(position.coords.longitude, position.coords.latitude);

				var Lon = point[0]; //获取经度
				var Lat = point[1]; //获取纬度

				mobileContainer.flyTo([Lon, Lat], {
					zoom: 12
				});
				console.log("当前位置信息：" + Lon + "," + Lat);
				//查询附近1km内的所有混接点
				mapData.getFeaturesByBuffer(
					[{
							NAME: 'DEVICE_POINT_INFO',
							HYBRID_TYPE: 1,
							DEL_FLAG: 0
						},
						{
							NAME: 'DEVICE_POINT_INFO',
							HYBRID_TYPE: 2,
							DEL_FLAG: 0
						}
					],
					// [114.04950213683215, 22.514631855561593], 0.1
					[Lon, Lat], 0.01
				).then(res => {
					var arr = res.features;
					console.log("附近1km内的混接点个数：" + arr.length);
					globalSetItem(GlobalKey.pointNum, res.features.length);
					var guidStr = "";
					for (var i = 0; i < arr.length; i++) {
						guidStr = guidStr + arr[i].properties.GUID + ","
					}
					if (guidStr.length > 0) {
						guidStr = guidStr.substring(0, guidStr.length - 1);
					}
					console.log("附近1km内的混接点：" + JSON.stringify(res) + ",guidList:" + guidStr);
					globalSetItem(GlobalKey.guidsList, guidStr);
				});
				mobileContainer.markAddress(Lon, Lat);
				app.hideLoader();
			}, function(e) {
				app.hideLoader();
				// console.log("error:" + e.message);
				mui.toast("位置信息获取失败，将无法获取附近混接点");
			})

		}

		var showBottomInfo = function(guid) {
			searchMixById(guid, function(data1) {
				// console.log(JSON.stringify(data1));
				if (data1.success) { //是混接点
					if (data1.result != null) {
						var mixInfo = data1.result;
						//定位至混接点
						var lat = mixInfo.SmY;
						var lng = mixInfo.SmX;
						//保存选中混接点经纬度
						globalSetItem(GlobalKey.Lat, lng);
						globalSetItem(GlobalKey.Lng, lat);
						mobileContainer.markAddress(lng, lat);
						mobileContainer.flyTo([lng, lat], {
							zoom: 13
						});
						//重置底部信息
						document.getElementById("info_icon").setAttribute("src", "../" + mixLevel(isEmp(mixInfo.reformState), isEmp(
							mixInfo.dischargerType)));

						$("#code").html(mixInfo.mixCode);

						var mixTypeText = mixInfo.mixType == 1 ? "雨水接入污水" : "污水接入雨水";

						getReformState(mixInfo.reformState, function(data) {
							$("#stat").html(data); //状态
						});

						$("#mixType").html(mixTypeText); //混接类型
						if (mixInfo.mixSource == null || mixInfo.mixSource == '') {
							$("#mixSour").html("无");
						} else {
							$("#mixSour").html(mixInfo.mixSource);
						}

						// getMixSource(mixInfo.mixSource, function(data) {
						// 	$("#mixSour").html(data);
						// })
						$("#mixDiameter").html(mixInfo.mixDiameter); //混接管径
						$("#mixDep").html(mixInfo.mixDepth); //混接埋深

						getMixPosition(mixInfo.mixPosition, function(data) {
							$("#mixPosition").html(data); //混接位置
						})
						// var addr =mixInfo.address!=null?(mixInfo.address.length > 15 ? mixInfo.address.substring(0, 15) + "..." : mixInfo.address):"无";
						$("#mixAddress").html(mixInfo.address); //混接地点

						globalSetItem(GlobalKey.mix, JSON.stringify(mixInfo)); //保存混接点信息
						globalSetItem(GlobalKey.guid, guid);
						globalSetItem(GlobalKey.isSelectMix, "true"); //是否设置混接点
						$(".bottom-item").fadeIn(); //显示底部信息
						$("#left_item").hide();
						$("#searchBar").hide();
						$("#refresh").hide();
					} else {
						app.toast("未查询到混接点信息！");
						$(".bottom-item").hide(); //隐藏底部信息
						$("#left_item").fadeIn();
						$("#searchBar").fadeIn();
						$("#refresh").fadeIn();
					}
				}
			});
		}
	</script>

</html>
