<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>派单</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/mui.picker.min.css" rel="stylesheet" />
		<link href="../../css/mui.poppicker.css" rel="stylesheet" />
		<link href="../../css/common.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../../css/mui.imageviewer.css" />
		<style>
			.mui-popover {
			height: 300px;
		}
		.mui-content {
			padding: 10px;
		}
		.bar-title{
			font-size: 14px;
			font-weight: 400;
			color: #888888;
		}
		.item-title{
			font-size: 14px;
			font-weight: 400;
			color: #444444;
		}
		.mui-icon-arrowright{
			color:#62666E;
			font-weight: 100 !important;
		}
		.inputCss{
			font-size: 16px;
			font-weight: 400;
			color: #1A1616;
			height: 30px;
		}
		.checkBoxCss{
			font-size: 16px;
			font-weight: 400;
			color: #000000;
		}
		.img_item{
			text-align: left;
			width: 72px;
			height: 100px;
			float: left;
			margin-right: 20px;
		}
		.img_item img{
			width: 72px;
			height: 72px;
		}
		.bottom-item-btn {
			height: 100px;
			position: fixed;
			z-index: 999;
			width: 100%;
			background: #f2f2f2;
			bottom: 0px;
			padding-top: 30px;
		}
		.bottom-item-btn .item {
			width: 95%;
			float: left;
			text-align: center;
			padding: 0 14px;

		}

		.bottom-item-btn .item div {
			border: 1px solid #337BFB;
			border-radius: 20px;
			height: 40px;
			line-height: 40px;
			font-size: 16px;
		}
		.file-item-box ul li{
			height: 30px;
			line-height: 30px;
			padding: 0;
			margin: 0;

		}
		.mui-table-view:after{ height:0}
		.mui-table-view:before{ height:0}
		.mui-table-view-cell:after{ height:0}
		.mui-table-view-cell:before{ height:0}
		.mui-table-view::-webkit-scrollbar {
			display: none;
		}
		.mui-table-view-cell{
			width: 100%;
			text-align: left;
		}
		.btn-label{
			font-size: 12px;
			font-weight: 400;
			color: #B1B1B1;
			line-height: 14px;
		}
	
		.in-obj {
			color: #888;
			font-weight: 400;
		}
		
		.obj-title {
			font-size: 20px;
			font-family: PingFang SC;
			font-weight: bold;
			color: #191515;
			line-height: 48px;
			padding: 20px 0 20px 20px;
			border-bottom: 1px solid #EDEDED;
			text-align: left;
			
		}
		.object {
			display: flex;
			justify-content: space-between;
			margin: 8px 0;
			color: #444444;
		}
	</style>
	</head>

	<body>
		<!--页面主结构开始-->
		<div id="app" class="mui-views">
			<div class="mui-view">
				<div class="mui-navbar">
				</div>
				<div class="mui-pages">
				</div>
			</div>
		</div>
		<div class="bottom-item-btn" id="bottom-item-btn">
			<div class="item" id="save" style="width: 50%;">
				<div style="color:#337BFC ;border:1px solid #337BFC">取消</div>
			</div>
			<div class="item" id="submit" style="width: 50%;">
				<div style="background: #337BFC;color: #fff">确认</div>
			</div>
		</div>
		<!--页面主结构结束-->
		<!--单页面开始-->
		<div id="mui-content" class="mui-page paish">
			<!--页面标题栏开始-->
			<!--页面标题栏结束-->
			<!--页面主内容区开始-->
			<div class="mui-page-content">
				<div id="scroll-content" class="mui-scroll-wrapper">
					<div class="mui-scroll">
						<div class="scroll-li" style="padding-bottom: 20px;">
							<div class="bar-title">
								整改明细
							</div>
							<div id="contentList">
								<!-- <div class="info-bar-content">
									<div class="obj-title" style="">
										巡检对象1
									</div>
									<div class="info-bar-content-item isShow">
										<div class="item-title">
											设施1类型
										</div>
										<input id="mixType" type="text" style="display: none;">
										<div class="mui-input-row item-input">
											<input id="mixType_text" readonly="readonly" type="text"  value="污水检查井"
											class="inputCss" style="width:90%;">
											<span class="mui-icon mui-icon-arrowright"></sapn>
										</div>
									</div>
									<div class="info-bar-content-item isShow">
										<div class="item-title">
											设施编号
										</div>
										<div class="mui-input-row item-input">
											<input id="mixType_text" readonly="readonly" type="text"  value="WSJ0001"
											class="inputCss" style="width:90%;">
										</div>
									</div>
									<div class="info-bar-content-item isShow">
										<div class="item-title" style="margin-bottom: 10.5px;">
											<span>设施描述</span>
										</div>
										<div class="mui-input-row item-input">
											<input id="mixType_text" readonly="readonly" type="text" value="井盖缺损"
											class="inputCss" style="width:90%;">
										</div>
									</div>
									<div class="info-bar-content-item" style="height: 160px;">
										<div class="item-title" style="margin-bottom: 20px;">
											整体/局部照片
										</div>
										<div class="psh_img_list1" id="psh_img_list1">
										</div>
										<div id="photo1" class="img_item">
											<img class="img_src" src="../../img/commom/pz@2x.png" style="" />
										</div>
									</div>
									<div class="info-bar-content-item isShow" style="height: 100px;border-bottom:none;">
										<div class="item-title" style="margin-bottom: 10.5px;">
											<span>处理要求</span>
										</div>
										<div class="mui-input-row item-input">
											<input id="mixType_text" readonly="readonly" type="text" value="" style="border:1px solid #EDEDED"
											class="inputCss" style="width:90%;">
										</div>
									</div>
									<div id="border_line" style="height:10px;background: #F4F4F4;"></div> -->
								</div>
								<div class="info-bar-content-item">
									<div class="item-title">
										接收人
									</div>
									<div class="mui-input-row item-input">
										<input id="inputById" type="text" style="display: none;">
										<input id="inputByName" type="text" readonly placeholder="请选择接收人" class="inputCss">
									</div>
								</div>
								<div id="bottom-div" style="height: 100px;"></div>
							</div>
						</div>
					</div>
				</div>
			</div>


			<!--拍照须知-->
			<div id="middlePopover" class="mui-popover" style="text-align: left;background: #FFFFFF;">
				<div class="mui-popover-arrow"></div>
				<div class="mui-scroll-wrapper">
					<div class="mui-scroll">
						<ul class="mui-table-view" style="background: #FFFFFF;">
							<li class="mui-table-view-cell"><a href="#">现场图片拍照须知:</a>
							</li>
							<li class="mui-table-view-cell"><a href="#" style="white-space:initial">1、如手机有水印功能，请开启：【设置】->【水印】</a>
							</li>
							<li class="mui-table-view-cell"><a href="#" style="white-space:initial">2、平视图：手机正面对着门面，要能够看清楚整个门面及门面上面的排水户名称</a>
							</li>
							<li class="mui-table-view-cell"><a href="#" style="white-space:initial">3、楼栋图：手机仰视拍摄排水户所在的楼栋</a>
							</li>
							<li class="mui-table-view-cell"><a href="#" style="white-space:initial">4、方位图：手机竖直沿排水户所在街道的某一个方向拍摄</a>
							</li>
							<li class="mui-table-view-cell"><a href="#" style="white-space:initial">5、门牌图：如果有门牌挂牌，正门拍摄</a>
							</li>
						</ul>
					</div>
				</div>

			</div>
			<!--页面主内容区结束-->
		</div>

	</body>

	<script type="text/javascript" src="http://gd.wiseom.cn/supermap/mapbox-gl-enhance.js"></script>
	<script type="text/javascript" src="http://gd.wiseom.cn/supermap/iclient-mapboxgl.min.js"></script>
	<script src="http://gd.wiseom.cn/mobile-lib/mobile-lib.umd.js"></script>


	<script src="../../js/mui.min.js"></script>
	<script src="../../js/mui.view.js"></script>
	<script src="../../js/mui.locker.js"></script>
	<script src="../../js/mui.picker.min.js"></script>
	<script src="../../js/mui.picker.js"></script>
	<script src="../../js/mui.poppicker.js"></script>

	<script src="../../js/app.js"></script>
	<script src="../../js/config.js"></script>
	<script src="../../js/jquery.min.js"></script>
	<script src="../../js/common.js"></script>	
	<script src="../../js/supervision.js"></script>
	<script src="../../js/helper.js"></script>
	<script src="../../js/uploadimage.js"></script>
	<script src="../../js/s4.js"></script>
	<script src="../../js/smutils.js"></script>
	<script src="../../js/byte&string.js"></script>
	<script src="../../js/ajaxhook.min.js"></script>
	<script src="../../js/mui.zoom.js"></script>
	<script src="../../js/mui.previewimage.js"></script>

	<!-- <script src="../../js/vconsole.min.js"></script> -->
	<script>
		// var vConsole = new VConsole();
		mui.init({swipeBack:false});
		//初始化单页view
		var viewApi = mui('#app').view({
			defaultPage: '#mui-content'
		});

		//初始化单页的区域滚动
		mui('.mui-scroll-wrapper').scroll();

		const mapData = window['mobile-lib'].MapData({
			serverUrl: config.urls.serverDomain,
			style: 'color'
		});
		
		var objList=[
			{
				name:"巡检对象1",
				objType:1,
				objCode:"WSJ0001",
				objDesc:"出口订单",
				attachment:"",
				requirements:""
			},
			{
				name:"巡检对象2",
				objType:0,
				objCode:"WSJ0001",
				objDesc:"出口订单",
				attachment:"",
				requirements:""
			},
			{
				name:"巡检对象3",
				objType:2,
				objCode:"WSJ0001",
				objDesc:"出口订单",
				attachment:"",
				requirements:""
			}
		];

		mui.plusReady(function() {
			//界面元素控制
			initView();

			// 点击事件
			initDownSelect();
			//初始化回调
			// initCallback();

			// 初始化选项框状态
			initCheckBox();

			plus.webview.currentWebview().setStyle({
				softinputMode: "adjustResize" // 弹出软键盘时自动改变webview的高度
			});
			var originalHeight = document.documentElement.clientHeight || document.body.clientHeight;
			window.onresize = function() {
				var resizeHeight = document.documentElement.clientHeight || document.body.clientHeight;
				//软键盘弹起与隐藏  都会引起窗口的高度发生变化
				if (resizeHeight * 1 < originalHeight * 1) { //resizeHeight<originalHeight证明窗口被挤压了
					plus.webview.currentWebview().setStyle({
						height: originalHeight + 65
					});
				}
			}
		});

		//界面元素控制
		var initView = function() {

			var self = plus.webview.currentWebview();

			var type = self.type;
			// //填写人
			// $("#inputById").val(app.userInfo().username);
			// $("#inputByName").val(app.userInfo().realname);
			// //填报时间
			// var nowDate=(new Date()).Format("yyyy-MM-dd hh:mm:ss");
			// $("#inputTime").val(nowDate)
			//对象列表
			var htm="";
			var imgList="";
			for(var i=0;i<objList.length;i++){
				let item=objList[i];
				let objType_text="";
				//获取设施类型
				getDicTextByIdAndKey(item.objType,'ZHSW.DEVICE.INPUT_OBJECT_TYPE',function(data){
					objType_text=data;
				})
				//获取图片
				var groupIds=item.attachment.split(",");//多张图片
				for(let j=0;i<groupIds.length;j++){
					// findFilesByGroupId({
					// 	groupId: groupIds[j]
					// }, function(data) {
					// 	if (data.success) {
					// 		// if (data.result.length >= 3) {
					// 		// 	$("#photo2").hide();
					// 		// }
					// 		for (var i = 0; i < data.result.length; i++) {
					// 			imgList += '<div id="' + data.result[i].uploadFile.id + '" data-token="' + data.result[i].fileToken +
					// 				'" name="fileMixIdPaths" class="img_item" style="position:relative;">' +
					// 				'		<img class="img_src" src="' + config.urls.baseUrl + "sys/common/view/" + data.result[i].uploadFile.savePath +
					// 				'" 	style="" data-preview-src="" data-preview-group="1" />' +'">'+
					// 				'	</div>';
					// 		}
					// 	}
					// });
				}
				
				htm+=`<div class="obj-title" style="">${item.name}</div>
								<div class="info-bar-content-item isShow">
									<div class="item-title">设施${i+1}类型</div>
									<input id="objType" type="text" value=${item.objType} style="display: none;">
									<div class="mui-input-row item-input">
										<input id="objType_text" readonly="readonly" type="text"  value="${objType_text}" class="inputCss" style="width:90%;">
										<span class="mui-icon mui-icon-arrowright"></sapn>
									</div>
								</div>
								<div class="info-bar-content-item isShow">
									<div class="item-title">设施${i+1}编号</div>
									<div class="mui-input-row item-input">
										<input id="mixType_text" readonly="readonly" type="text"  value="${item.objCode}" class="inputCss" style="width:90%;">
									</div>
								</div>
								<div class="info-bar-content-item isShow">
									<div class="item-title" style="margin-bottom: 10.5px;">
										<span>设施${i+1}描述</span>
									</div>
									<div class="mui-input-row item-input">
										<input id="mixType_text" readonly="readonly" type="text" value="${item.objDesc}" class="inputCss" style="width:90%;">
									</div>
								</div>
								<div class="info-bar-content-item" style="height: 160px;">
									<div class="item-title" style="margin-bottom: 20px;">
										整体/局部照片
									</div>
									<div class="psh_img_list1" id="psh_img_list1">`+imgList+`</div>
									<div id="photo1" class="img_item">
										<img class="img_src" src="../../img/commom/pz@2x.png" style="" />
									</div>
								</div>
								<div class="info-bar-content-item isShow" style="height: 100px;border-bottom:none;">
									<div class="item-title" style="margin-bottom: 10.5px;">
										<span>处理要求</span>
									</div>
									<div class="mui-input-row item-input">
										<input id="mixType_text" type="text" value="${item.requirements}" style="border:1px solid #EDEDED"
										class="inputCss" style="width:90%;">
									</div>
								</div>
								<div id="border_line" style="height:10px;background: #F4F4F4;"></div>`;
			}
			console.log(htm)
			$('#contentList').html(htm);
		}



		// 初始化选项框状态
		var initCheckBox = function() {
			$(".info-bar-content-item").find(":checkbox").each(function() {
				$(this).click(function() {
					if ($(this).is(':checked')) {
						$(this).parent().siblings().find(":checkbox").each(function() {
							$(this).prop("checked",false)
						});
					}
				});
			});
		}

		// 点击事件
		var initDownSelect = function() {
			//拍照
			$("#photo1,#photo2").on("tap", function() {
				var that = $(this);
				plusSelectImage(function(data, path) {
					console.log(JSON.stringify(data));
					if (data.success) {
						var thisId = that.attr("id");
						var name = "";
						if (thisId == "photo1") {
							name = "fileIdPaths";
						} else {
							name = "fileMixIdPaths";
						}

						var html = '<div id="' + data.result.uploadFile.id + '" data-token="' + data.result.fileTokens + '" name="' +
							name + '"' +
							'" class="img_item" style="position:relative;">' +
							'		<img class="img_src" src="' + path + '" style="" data-preview-src="" data-preview-group="' + name +
							'"  />' +
							'		<input type="hidden" name="' + name + '" value="' + data.result.uploadFile.savePath + '">' +
							'		<span class="img_close mui-icon mui-icon-closeempty"  name="' + data.result.uploadFile.savePath +
							'" style="width: 16px;height: 16px;position:relative;top:-88px;left:64px;font-size: 16px;color: #888888;background: #E7E7E7;border-radius: 50%;"></span>'+
							'	</div>';
						that.prev().append(html);
						var count = that.prev().children(".img_item").length;
						if (count == 3) { //处理上传的数量
							that.hide();
						}
					} else {
						app.toast(data.message);
					}
				});

			});
			$(document).on('tap', '.img_src', function() {
				mui.previewImage();
			});
			
		}
		//提交
		$("#submit").on("tap", function(event) {
			app.openPage("submitted.html", {
				titleNView: {
					titleText: '提交完成',
					autoBackButton: true,
					"titleSize": "18px",//标题字体大小
				}
			},{})
			if (validateRequiredFields()) {

			}
		});
		//重新加载
		var reloadAddress = function(data) {
			window.location.reload();
		}
		//自定义校验
		var validateAttach = function() {

			return true;
		}

		//附件
		var attach = function() {
			var imagefileTokens1 = '';//整体照片
			var imagefileTokens2 = '';//局部照片
			var imagefileTokens3 = '';//现场照片
		
			$("[data-token]").each(function(index) {
				var imgID = $(this).attr("id");
				var name = $(this).attr("name");
				var token = $(this).attr("data-token");
				if (name == "fileIdPaths") {
					imagefileTokens1 = imagefileTokens1 + "," + token;
				} else if (name == "fileMixIdPaths") {
					imagefileTokens2 = imagefileTokens2 + "," + token;
				} else if (name == "ideaFileId") {
					imagefileTokens3 = imagefileTokens3 + "," + token;
				}
			});
			console.log("imagefileTokens1:" + imagefileTokens1 + ",imagefileTokens2:" + imagefileTokens2 + ",imagefileTokens3:" + imagefileTokens3 );
			var photoFile = globalGetItem(GlobalKey.photoAttachment);

			// if (photoFile) {
			// 	photoAttachment = JSON.parse(photoFile);
			// }
			photoAttachment.forEach((img, index, array) => {
				console.log("====" + JSON.stringify(img));
				if (img.fieldName == 'fileId') {
					img.groupId = $("#fileId").val();
					img.fileTokens = imagefileTokens1;
				} else if (img.fieldName == 'fileMixId') {
					img.groupId = $("#fileMixId").val();
					img.fileTokens = imagefileTokens2;
				} else if (img.fieldName == 'ideaFileId') {
					img.groupId = $("#ideaFileId").val();
					img.fileTokens = imagefileTokens3;
				}
			})
			$("#strAttachment").val(JSON.stringify(photoAttachment));
			console.log($("#fileId").val() + "---" + $("#fileMixId").val());
			globalSetItem(GlobalKey.photoAttachment, JSON.stringify(photoAttachment));
		}



		
	</script>
</html>
